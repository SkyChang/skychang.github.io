<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="google-site-verification" content="iFYOZeAkjA9mpw80K_6C3Ybqm8zAmrJ3XXy5cSphRew" />










  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Redis,Windows," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description" content="前言首先，這篇要感謝公司的架構師 Harry、好友饅頭和 Jamis，提供了非常的多 Redis 經驗。 其實 Redis 的相關文章已經有非常非常非常多，不光是對岸，甚至國內大家也已經有大量的文章產出了，也已經是一個非常成熟的 Open Source 產品，而最近，因為剛好有要建立高可用性的 Redis 的需求，所以就在這邊，把整個過程寫下來，畢竟人年紀大了，很容易忘東忘西… Redis HA在">
<meta property="og:type" content="article">
<meta property="og:title" content="Redis - 在 Windows 上建立高可用性的 Redis">
<meta property="og:url" content="http://skychang.github.io/2017/04/09/Redis-Create_Redis_HA/index.html">
<meta property="og:site_name" content="天空的垃圾場">
<meta property="og:description" content="前言首先，這篇要感謝公司的架構師 Harry、好友饅頭和 Jamis，提供了非常的多 Redis 經驗。 其實 Redis 的相關文章已經有非常非常非常多，不光是對岸，甚至國內大家也已經有大量的文章產出了，也已經是一個非常成熟的 Open Source 產品，而最近，因為剛好有要建立高可用性的 Redis 的需求，所以就在這邊，把整個過程寫下來，畢竟人年紀大了，很容易忘東忘西… Redis HA在">
<meta property="og:locale" content="zh_TW">
<meta property="og:image" content="http://skychang.github.io/2017/04/09/Redis-Create_Redis_HA/00.png">
<meta property="og:image" content="http://skychang.github.io/2017/04/09/Redis-Create_Redis_HA/01.png">
<meta property="og:image" content="http://skychang.github.io/2017/04/09/Redis-Create_Redis_HA/02.png">
<meta property="og:image" content="http://skychang.github.io/2017/04/09/Redis-Create_Redis_HA/03.png">
<meta property="og:image" content="http://skychang.github.io/2017/04/09/Redis-Create_Redis_HA/04.png">
<meta property="og:image" content="http://skychang.github.io/2017/04/09/Redis-Create_Redis_HA/05.png">
<meta property="og:image" content="http://skychang.github.io/2017/04/09/Redis-Create_Redis_HA/06.png">
<meta property="og:image" content="http://skychang.github.io/2017/04/09/Redis-Create_Redis_HA/07.png">
<meta property="og:image" content="http://skychang.github.io/2017/04/09/Redis-Create_Redis_HA/08.png">
<meta property="og:image" content="http://skychang.github.io/2017/04/09/Redis-Create_Redis_HA/09.png">
<meta property="og:image" content="http://skychang.github.io/2017/04/09/Redis-Create_Redis_HA/10.png">
<meta property="og:image" content="http://skychang.github.io/2017/04/09/Redis-Create_Redis_HA/11.png">
<meta property="og:image" content="http://skychang.github.io/2017/04/09/Redis-Create_Redis_HA/12.png">
<meta property="og:image" content="http://skychang.github.io/2017/04/09/Redis-Create_Redis_HA/13.png">
<meta property="og:image" content="http://skychang.github.io/2017/04/09/Redis-Create_Redis_HA/14.png">
<meta property="og:image" content="http://skychang.github.io/2017/04/09/Redis-Create_Redis_HA/15.png">
<meta property="og:image" content="http://skychang.github.io/2017/04/09/Redis-Create_Redis_HA/16.png">
<meta property="og:image" content="http://skychang.github.io/2017/04/09/Redis-Create_Redis_HA/17.png">
<meta property="og:image" content="http://skychang.github.io/2017/04/09/Redis-Create_Redis_HA/18.png">
<meta property="og:image" content="http://skychang.github.io/2017/04/09/Redis-Create_Redis_HA/19.png">
<meta property="og:image" content="http://skychang.github.io/2017/04/09/Redis-Create_Redis_HA/20.png">
<meta property="og:image" content="http://skychang.github.io/2017/04/09/Redis-Create_Redis_HA/21.png">
<meta property="og:image" content="http://skychang.github.io/2017/04/09/Redis-Create_Redis_HA/22.png">
<meta property="og:image" content="http://skychang.github.io/2017/04/09/Redis-Create_Redis_HA/23.png">
<meta property="og:image" content="http://skychang.github.io/2017/04/09/Redis-Create_Redis_HA/24.png">
<meta property="og:image" content="http://skychang.github.io/2017/04/09/Redis-Create_Redis_HA/25.png">
<meta property="og:image" content="http://skychang.github.io/2017/04/09/Redis-Create_Redis_HA/25.png">
<meta property="og:image" content="http://skychang.github.io/2017/04/09/Redis-Create_Redis_HA/27.png">
<meta property="og:image" content="http://skychang.github.io/2017/04/09/Redis-Create_Redis_HA/28.png">
<meta property="article:published_time" content="2017-04-09T23:11:00.000Z">
<meta property="article:modified_time" content="2020-05-27T12:09:38.928Z">
<meta property="article:author" content="Sky Chang">
<meta property="article:tag" content="Redis">
<meta property="article:tag" content="Windows">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://skychang.github.io/2017/04/09/Redis-Create_Redis_HA/00.png">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>

  <title> Redis - 在 Windows 上建立高可用性的 Redis | 天空的垃圾場 </title>
<meta name="generator" content="Hexo 4.2.1"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-tw">

  


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-29938905-2', 'auto');
  ga('send', 'pageview');
</script>









  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">天空的垃圾場</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首頁
          </a>
        </li>
      
        
        <li class="menu-item menu-item-development">
          <a href="/development" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            開發
          </a>
        </li>
      
        
        <li class="menu-item menu-item-alm">
          <a href="/alm" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            維運
          </a>
        </li>
      
        
        <li class="menu-item menu-item-cloud">
          <a href="/cloud" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            雲端
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            歸檔
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            標籤
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                Redis - 在 Windows 上建立高可用性的 Redis
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">發表於</span>
            <time itemprop="dateCreated" datetime="2017-04-09T23:11:00+00:00" content="2017-04-09">
              2017-04-09
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2017/04/09/Redis-Create_Redis_HA/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2017/04/09/Redis-Create_Redis_HA/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>首先，這篇要感謝公司的架構師 Harry、好友饅頭和 Jamis，提供了非常的多 Redis 經驗。</p>
<p>其實 Redis 的相關文章已經有非常非常非常多，不光是對岸，甚至國內大家也已經有大量的文章產出了，<br>也已經是一個非常成熟的 Open Source 產品，而最近，因為剛好有要建立高可用性的 Redis 的需求，<br>所以就在這邊，把整個過程寫下來，畢竟人年紀大了，很容易忘東忘西…</p>
<h2 id="Redis-HA"><a href="#Redis-HA" class="headerlink" title="Redis HA"></a>Redis HA</h2><p>在 Redis 的建置上，最簡單的，當然就是單機一台，單機一台只要去官網下載，下載完畢後，安裝，<br>並且把設定檔設定完，基本上就可以進行運作。</p>
<p>接下來比較複雜的建設，大概就是 Cluster 和 HA 了；在 Redis Cluster 指的是當資料 I/O 過於龐大，<br>如果一台沒辦法處理如此龐大的資料量，這個時候，就可以透過 Cluster 的機制，將資料做切分，<br>並依據 Redis 內部的機制，算出要放到哪一台 Redis Server；換言之，在 Redis 的 Cluster，<br>指的是多台資料做分流，而非當作備援。</p>
<p>說到備援，也就是今天的主題，Redis 的高可用性 ( HA )，目的是希望當我們使用 Redis 的情況下，<br>當主要進行資料處理的那台 Server 掛掉的時候，可以快速的切換到備援機而不中斷<br>( 其實還是可能會有短暫的中斷和出錯 )，讓服務能持續地進行，而不影響；<br>其次，因為 Redis 主要是將資料存放於 Memory ，所以當整台機器服務當掉的時候，也可能會有資料遺失，<br>所以透過 HA，也可以自動地將 主 ( Master ) 和 從 ( Slave ) 的資料進行同步。</p>
<p>當然，如果要更複雜，就可以搭配 Cluster 和 HA ，這樣就可以規劃出，既可以處理大量 I/O ，<br>又可以擁有高可用性的服務環境。</p>
<p>有興趣的可以參考這篇<a href="http://stackoverflow.com/questions/31143072/redis-sentinel-vs-clustering" target="_blank" rel="noopener">文章</a> </p>
<p>最後，在 Redis HA 的架構下，其實大家習慣稱為 Reids Sentinel ( 哨兵 )，為什麼稱為 Sentinel (哨兵)，<br>其實原因很簡單，因為要有一台 Sentinel (哨兵) Server，來幫忙仲裁，決定目前哪台還活著，哪台可以提供服務，<br>換言之，以 Redis Sentinel 的架構來說，至少需要三台 Server，Master、Slave 和 Sentinel，<br>由 Sentinel 來進行 Master 與 Slave 的監控，當 Master 掛點的時候， Sentinel 會將 Slave 變更為 Master，<br>而原本死翹翹的 Master 經過修復重新開機後，復活後，Sentinel 會將原本的 Master 改為 Slave。</p>
<p>沒錯，這就是 Sentinel 的功能，監控著哪台活著，哪台死掉。</p>
<p>看到這邊，對，聰明的你，你一定會有一個疑問，如果 Sentinel 自己偷懶，或是死掉怎麼辦!?<br>所以，在官方文件裡面，官方也建議要有 “奇數” 的 Sentinel 來保持 Sentinel 的可用性。</p>
<p>為何要 “奇數” 呢，那是因為，仲裁機制的關係，如果是 2台 Sentinel 的情況下，其中一台說 Master 死掉了，<br>另外一台說，沒有，他活著好好的，那…到底要聽誰的呢 ??</p>
<p>所以才會需要 “奇數” 的 Sentinel，目的就是希望可以透過表決的方式，來證明 Master 死掉了。<br>( 所以如果有三台，只要兩台投 Master 掛了，那就符合了切換的程序，其實官方也建議 Sentinel 至少三台… )</p>
<p>所以這又衍生一個問題，所以我們建立高可用性，是否至少要 5 台 Server …<br>其實也不然，就如這篇<a href="http://stackoverflow.com/questions/31143072/redis-sentinel-vs-clustering" target="_blank" rel="noopener">文章</a> 的發問者問的一樣，<br>我們也可以把 Sentinel 裝在 Master 和 Slave 裡面，這樣只要三台 Server 一樣可以完成，<br>但也如同那篇文章所敘述的，這不一定是個好主意，也可能有很多不確定的因子…<br>同樣的，透過 Docker run Redis 也不失為一種手法，但無論怎樣的手法，都會有優缺點，這邊小弟就不探討此塊。</p>
<p>而這篇文章，主要會用三台 Server 來進行 Reids Sentinel ( HA ) 的建置。<br>其中兩台就是單純的 Master 和 Slave，最後一台則是只裝 Sentinel。</p>
<p>小弟這邊使用 Azure，開了三台 VM 來完成這次的實作，分別是 </p>
<ul>
<li>Cache-1 - 10.0.0.4</li>
<li>Cache-2 - 10.0.0.5</li>
<li>Sentinel - 10.0.0.6</li>
</ul>
<p><img src="00.png" alt=""></p>
<h2 id="安裝第一台-Redis-Server"><a href="#安裝第一台-Redis-Server" class="headerlink" title="安裝第一台 Redis Server"></a>安裝第一台 Redis Server</h2><p>每次要安裝程式，第一步驟是甚麼?，當然就是要去官網進行下載，所以我們可以先去 Redis 的<a href="https://redis.io/" target="_blank" rel="noopener">官網</a>溜溜，<br>而我們可以從官網的地方，找到<a href="https://redis.io/download" target="_blank" rel="noopener">官網下載</a>，但是大家可能會發現，<br>基本上官網只提供的是 Linux 的版本；這是正確的；因為 Redis 最初的發展，就是在 Linux 上，<br>而官網提供的，基本上也只有 Linux 的相關版本；甚至，如果有任何的問題與服務，官方也只 support Linux 而已喔。</p>
<p><img src="01.png" alt=""></p>
<p>但我們今天要裝的是 Windows 版本，那 Windows 版本在哪邊勒？<a href="https://github.com/MSOpenTech/redis" target="_blank" rel="noopener">Windows 版本的位置在此</a></p>
<p>其實大家也不用擔心，雖然是 Windows 版本，但是整個團隊，是 Microsoft 的 Open Tech 團隊所維護，<br>甚至所有的 Redis for Windows 的 Source Code，全部都放在 GitHub 上，也是完全的 Open Source。<br>相同的，如果是使用 Windows 版本的 Redis ，就必須要來此 GitHub 尋求支援了喔。</p>
<p>我們可以從底下位置，找到 Windows 版本的下載。</p>
<p><img src="02.png" alt=""></p>
<p><a href="https://github.com/MSOpenTech/redis/releases" target="_blank" rel="noopener">Windows 版本 Redis 下載</a>點進去後，我們就可以看到兩個，<br>一個是 msi，一個是 zip，兩個內容很雷同，唯一的差別是， msi 會自動幫你把 Redis 註冊到 Windows Service 服務，<br>未來你就可以透過 UI 來停止或啟動，而 zip 裡面則是解開就可以直接執行 exe 使用<br>( 當然，你也可以下載 zip ，然後自己註冊成 Windows Service )</p>
<p><img src="03.png" alt=""></p>
<p>了解下載位置後，接下來，我們進入　Cache-1 的 VM 裡面，並且下載 msi，然後，我們將下載下來的 msi 點兩下進行安裝。</p>
<p><img src="04.png" alt=""></p>
<p>到這一步的時候，記得勾選 [Add the Redis Installation folder to the PATH environment variable.]，<br>因為等下我們會使用到 Redis 的 Cli ，所以把 Redis 加入到環境變數 PATH 裡面，就可以不用到 Redis 底下的目錄來執行。</p>
<p><img src="05.png" alt=""></p>
<p>預設的 Port 是 6379 ，勾選下面的按鈕，就可以順便加入防火牆。</p>
<p><img src="06.png" alt=""></p>
<p>如果想限制 Memory 的大小，可以在這邊進行設定，在正式環境建議設定一下。</p>
<p><img src="07.png" alt=""></p>
<p>安裝完成後，我們就可以從[服務]底下看到 Redis 的服務已經註冊且已經啟動了。</p>
<p><img src="08.png" alt=""></p>
<p>接下來，我們可以從 cmd 裡面輸入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli info</span><br></pre></td></tr></table></figure>

<p>來查看目前 Redis 的狀況。</p>
<p><img src="09.png" alt=""></p>
<p>亦可以使用 Get、Set 等指令來塞入值和取得值</p>
<p><img src="10.png" alt=""></p>
<p>到這邊，最簡單的第一台算是建立完成了；但此時的設定是僅支援 Localhost 的，換言之，<br>當你想從外面來存取，是會完全被擋住的。</p>
<p>是低，Redis 的 config ，預設只開放 Localhost，所以接下來，我們要修改一下設定。</p>
<p>我們要去 Redis 的安裝目錄下，修改 redis.windows-service.conf 這個檔案，<br>並且在原本的 bind 127.0.0.1 後面加上這台的私有 ip。</p>
<p>在預設的情況下，為了安全，Redis 只會監聽 127.0.0.1 這個 IP 位置，所以為了讓他能支援內網，<br>所以我們在 127.0.0.1 後面加上這台 ( Cache-1 ) 的私有 IP。</p>
<p><img src="11.png" alt=""></p>
<p>雖然加上上面那個步驟後，就可以從私有網域進行連線，但我們還是希望多加上一下密碼，<br>所以我們可以把如下圖的地方註解掉；將 requirepass foobared 給註解掉，<br>其中，foobared 就是密碼；這邊小弟就懶得改嚕。</p>
<p><img src="12.png" alt=""></p>
<p>設定完成後，我們這邊重新啟動一下 Redis 後，新的設定檔就會生效了。</p>
<p>接下來，大家可以趕快裝一下 Cache-2 這台機器 ( 裝法同上 ) ，裝完後，我們也先不用進行任何設定，<br>我們可以直接透過底下命令，連線到 Cache-1 ，並且取得剛剛送進去的 Hello。<br>( 備註: Key 值的大小寫是有差的喔 )</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -h 10.0.0.4 -a foobared</span><br></pre></td></tr></table></figure>

<p><img src="13.png" alt=""></p>
<p>如果，如果，真的想讓這台開放給全世界服務(攻擊)，那必須把 bind 前面加上 # 來註解掉 ( 例: # bind 127.0.0.1 )。</p>
<p>另外，這邊要特別注意一點，Redis 目前有一個參數為　protected-mode yes ，這是一個 Redis 預設的保護參數，<br>如果把 bind 給註解掉 ( 表示開放 )，且又沒設定 Password，那外部怎樣連都會連不通喔。</p>
<p>所以，要不就是把 protected-mode 設定 no ，要不就是乖乖地給個密碼吧。<br>( 把 Protected-mode yes 給註解掉是沒用的喔～ )</p>
<p>當然，最理想的狀況，就是只提供私有網域，真的想開放，建議還是設定一個密碼比較好喔。</p>
<p>P.S 如果使用 Azure VM，也別忘了開 Azure VM 的 Endpoint 喔~</p>
<p><img src="14.png" alt=""></p>
<p>底下是無法存取的情況。</p>
<p><img src="15.png" alt=""></p>
<p>最後，我們還是把設定還原到底下這三個狀態。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bind 127.0.0.1 10.0.0.4</span><br><span class="line">protected-mode yes</span><br><span class="line">requirepass foobared</span><br></pre></td></tr></table></figure>

<h2 id="設定-Master-和-Slave"><a href="#設定-Master-和-Slave" class="headerlink" title="設定 Master 和 Slave"></a>設定 Master 和 Slave</h2><p>目前我們已經裝完了 Master 和 Slave，其中 Master 有簡單的設定一些參數，<br>而 Slave 目前還沒設定任何參數；然後 Sentinel 連裝都還沒裝…</p>
<p>在開始前，我們先回到 Master ，我們可以先下一下這個指令，來查看複寫的資訊。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -h 127.0.0.1 -a foobared  info replication</span><br></pre></td></tr></table></figure>

<p>如下圖，我們可以看到，目前這台是 Master，而連線的 Slave 為 0<br>( Connected_Slave:0)</p>
<p><img src="16.png" alt=""></p>
<p>接著，我們也可以觀察一下，預計要變成 Slave 的這台電腦的狀況，我們可以發現，<br>目前她還是 Master。</p>
<p><img src="17.png" alt=""></p>
<p>所以目前沒有任何一台 Slave 與我們的 Master 連線 ( 兩台目前都是 Master )，<br>所以我們將開始進行 Slave 的設定，我們進入 Slave，並且打開 redis.windows-service.conf 這個檔案，<br>並切找到 # slaveof 這行，拿掉註解，修改成 slaveof 10.0.0.4 6379 ( 代表 Master 的 ip 位置和 Port )，<br>接著，找到 # masterauth，改成 masterauth foobared ( 代表 Master 的密碼 )。<br>另外，Bind 127.0.0.1 也要改成 Bind 127.0.0.1 10.0.0.5，也別忘記把 requirepass foobared 取消註解，<br>讓 Slave 也可以透過 10.0.0.5 並且搭配密碼 foobred 來連入喔。</p>
<p><img src="18.png" alt=""></p>
<p>是低，就是那麼簡單，就完成了，然後我們重開 Slave 後，回到 Master 看一下狀態。<br>可以發現，目前 Slave 已經連上了!!</p>
<p><img src="19.png" alt=""></p>
<p>然後回到 Slave 看一下，也可以發現，他從 Master 變成 Slave 了!!</p>
<p><img src="20.png" alt=""></p>
<p>接下來，我們從 Master 塞一個 HelloWorld ，然後連到 Slave，取得資料看看。<br>我們全部都用 Slave 這台來操作，結果可以參考如下圖；所以這樣設定完，兩台 Redis 就會擁有複寫的功能了，<br>而且我們可以透過 Master 來讀寫，而 Slave 來進行讀的動作了，不過這邊要特別注意，<br>Master 提供了讀寫，但 Slave 是僅供讀取而已，是不能寫入的…</p>
<p><img src="21.png" alt=""></p>
<p>所以，到這邊，如果 Master 掛掉了，會自動把 Slave 切換成 Master 嗎!?<br>當然不…所以下一個章節，就是第三台機器登場。</p>
<h2 id="設定-Sentinel"><a href="#設定-Sentinel" class="headerlink" title="設定　Sentinel"></a>設定　Sentinel</h2><p>我們完成了 Master 和 Slave 的複寫，接下來，就是要建構 Sentinel，Sentinel 的其中兩個功能，<br>就是監控和切換，他會監控 Master 是否死掉，死了之後，就會把 Slave 變成 Master ( 這樣就可以持續寫入 )，<br>而原本的 Master 復活後，就會被改成 Slave。</p>
<p>同樣的，我們到 Windows 版本的 GitHub <a href="https://github.com/MSOpenTech/redis/releases" target="_blank" rel="noopener">下載</a>，<br>但這次我們下載 zip 檔案，下載回來後，找個地方解壓縮，小弟是直接丟在桌面 ( 不好習慣喔~ )<br>這邊不使用 msi 的原因是因為，使用 msi ，他會自動幫我們註冊到 Windows 的服務，<br>但我們要啟動 Sentinel ，需要不同的參數，所以我們就不使用 msi 了，<br>然果真的覺得 Windows 服務比較威，那可以<a href="http://hadb.me/2016/10/23/redis-windows-sentinel/" target="_blank" rel="noopener">參考這邊</a>，註冊進 Windows 服務。</p>
<p><img src="22.png" alt=""></p>
<p>接下來，我們在解開壓縮的那個目錄，增加一個 sentinel.conf 檔案，到時候 Sentinel 的設定就會寫在裡面，如下。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">port 26379</span><br><span class="line">bind 127.0.0.1 10.0.0.6</span><br><span class="line">sentinel monitor master1 10.0.0.4 6379 1</span><br><span class="line">sentinel down-after-milliseconds master1 5000</span><br><span class="line">sentinel failover-timeout master1 900000</span><br><span class="line">sentinel parallel-syncs master1 2</span><br><span class="line">sentinel auth-pass master1 foobared</span><br></pre></td></tr></table></figure>

<ul>
<li>port : 代表 Sentinel Port 的位置，通常大家都會用 26379</li>
<li>bind : 這很重要，至少要加上 127.0.0.1，不然會因為通訊的原因，而造成不斷的去嘗試切換 Master 和 Slave，如果有三台 Sentinel ，後面也要加上這台的 IP，真的不想加這行，也可以把安全模式關閉，改成　protected-mode no </li>
<li>sentinel monitor : 要監控的 Master ip 和 port，其中 master1 是自訂名稱。</li>
<li>down-after-milliseconds : 如果在幾毫秒內， 没有回應 sentinel ， 那麼 Sentinel 就會將這台標記為下線 SDOWN （ subjectively down )</li>
<li>failover-timeout : 轉移過程多久沒完成，算失敗。</li>
<li>parallel-syncs 在轉移過程，有多少台會和 Master 同步資料， 數字越小，完成轉移的時間越長 </li>
</ul>
<p><img src="23.png" alt=""></p>
<p>上面完成後，我們還要回到 Master 的機器，設定 redis.windows-service.conf，<br>找到 # masterauth，改成 masterauth foobared ( 代表 Master 的密碼 )。<br>需要這樣的原因，是因為，到時候 Master 會被切換成 Slave，如果沒有設定 masterauth foobared，<br>到時候這台機器會無法和未來的 Master 進行連線。<br>( 設定完也不忘記重新啟動 )</p>
<p>完成後，我們就可以啟動 Sentinel</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-server.exe sentinel.conf --sentinel</span><br></pre></td></tr></table></figure>

<p><img src="24.png" alt=""></p>
<h2 id="測試轉移"><a href="#測試轉移" class="headerlink" title="測試轉移"></a>測試轉移</h2><p>接下來，我們可以測試看看轉移，我們可以先關閉 Master，然後可以從 Sentinel 看到此變化。<br>馬上就可以看到，他已經把 Salve 切換到 Master 了。</p>
<p><img src="25.png" alt=""></p>
<p>我們也可以看看原本的 Salve，已經變成 Master 了，而且因為原本的 Master 沒啟動，<br>所以現在沒有任何一台 Salve。</p>
<p><img src="25.png" alt=""></p>
<p>如果再把 Master 啟動回來，我們可以發現，原本這台的資訊還是 Master ，但沒過多久，<br>Sentinel 就會把 Master 變成 Salve。</p>
<p><img src="27.png" alt=""></p>
<p>回到新的 Master ，我們依樣可以看到，和新的 Salve 連線也從新連好了。</p>
<p><img src="28.png" alt=""></p>
<p>接下來，我們可以看看程式如何搭配。</p>
<h2 id="程式連線"><a href="#程式連線" class="headerlink" title="程式連線"></a>程式連線</h2><p>待補</p>
<h2 id="後記"><a href="#後記" class="headerlink" title="後記"></a>後記</h2><p>待補</p>
<h2 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h2><ul>
<li><a href="http://stackoverflow.com/questions/31143072/redis-sentinel-vs-clustering" target="_blank" rel="noopener">http://stackoverflow.com/questions/31143072/redis-sentinel-vs-clustering</a></li>
<li><a href="https://dotblogs.com.tw/supershowwei/2016/02/03/123740" target="_blank" rel="noopener">https://dotblogs.com.tw/supershowwei/2016/02/03/123740</a></li>
<li><a href="http://blog.mkfree.com/posts/5257683d479e1dd72e7c1b4e" target="_blank" rel="noopener">http://blog.mkfree.com/posts/5257683d479e1dd72e7c1b4e</a></li>
<li><a href="https://segmentfault.com/a/1190000002680804" target="_blank" rel="noopener">https://segmentfault.com/a/1190000002680804</a></li>
<li><a href="https://segmentfault.com/a/1190000002685515" target="_blank" rel="noopener">https://segmentfault.com/a/1190000002685515</a></li>
<li><a href="http://mrcto.blog.51cto.com/1923168/1319542" target="_blank" rel="noopener">http://mrcto.blog.51cto.com/1923168/1319542</a></li>
<li><a href="https://dotblogs.com.tw/supershowwei/2016/02/03/123740" target="_blank" rel="noopener">https://dotblogs.com.tw/supershowwei/2016/02/03/123740</a></li>
<li><a href="http://www.jianshu.com/p/51f0cf57df7d" target="_blank" rel="noopener">http://www.jianshu.com/p/51f0cf57df7d</a></li>
<li><a href="https://redis.io/topics/sentinel" target="_blank" rel="noopener">https://redis.io/topics/sentinel</a></li>
<li><a href="http://www.redis.cn/topics/sentinel.html" target="_blank" rel="noopener">http://www.redis.cn/topics/sentinel.html</a></li>
<li><a href="http://www.voidcn.com/blog/fighterandknight/article/p-6338983.html" target="_blank" rel="noopener">http://www.voidcn.com/blog/fighterandknight/article/p-6338983.html</a></li>
<li><a href="http://hadb.me/2016/10/23/redis-windows-sentinel/" target="_blank" rel="noopener">http://hadb.me/2016/10/23/redis-windows-sentinel/</a></li>
<li><a href="http://www.voidcn.com/blog/fighterandknight/article/p-6338983.html" target="_blank" rel="noopener">http://www.voidcn.com/blog/fighterandknight/article/p-6338983.html</a></li>
<li><a href="http://www.redis.cn/topics/sentinel.html" target="_blank" rel="noopener">http://www.redis.cn/topics/sentinel.html</a></li>
<li><a href="http://bbs.redis.cn/forum.php?mod=viewthread&amp;tid=715" target="_blank" rel="noopener">http://bbs.redis.cn/forum.php?mod=viewthread&amp;tid=715</a></li>
<li><a href="https://redis.io/topics/sentinel" target="_blank" rel="noopener">https://redis.io/topics/sentinel</a></li>
<li><a href="https://dotblogs.com.tw/supershowwei/2017/02/27/163018" target="_blank" rel="noopener">https://dotblogs.com.tw/supershowwei/2017/02/27/163018</a></li>
<li><a href="https://github.com/StackExchange/StackExchange.Redis" target="_blank" rel="noopener">https://github.com/StackExchange/StackExchange.Redis</a></li>
<li><a href="https://dotblogs.com.tw/supershowwei/2017/02/27/163018" target="_blank" rel="noopener">https://dotblogs.com.tw/supershowwei/2017/02/27/163018</a></li>
</ul>

      
    </div>

    <div>
      
        
      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Redis/" rel="tag">#Redis</a>
          
            <a href="/tags/Windows/" rel="tag">#Windows</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/02/12/ASP-NET-Core-Uninstall_Net_SDK/" rel="next" title="ASP.NET Core - 移除在 macOS 上的 .Net Core SDK">
                <i class="fa fa-chevron-left"></i> ASP.NET Core - 移除在 macOS 上的 .Net Core SDK
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/07/19/Azure-Azure_Container_Service_Kubernetes_First/" rel="prev" title="Azure - 在 Azure 上使用 Azure Container Service 來執行 Kubernetes">
                Azure - 在 Azure 上使用 Azure Container Service 來執行 Kubernetes <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="//disqus.com/?ref_noscript" target="_blank" rel="noopener">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目錄
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            本站概覽
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="Sky Chang" />
          <p class="site-author-name" itemprop="name">Sky Chang</p>
          <p class="site-description motion-element" itemprop="description">雖然是垃圾場，但還是有許多好東西</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">354</span>
              <span class="site-state-item-name">文章</span>
            </a>
          </div>

          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">108</span>
                <span class="site-state-item-name">標籤</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Redis-HA"><span class="nav-number">2.</span> <span class="nav-text">Redis HA</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#安裝第一台-Redis-Server"><span class="nav-number">3.</span> <span class="nav-text">安裝第一台 Redis Server</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#設定-Master-和-Slave"><span class="nav-number">4.</span> <span class="nav-text">設定 Master 和 Slave</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#設定-Sentinel"><span class="nav-number">5.</span> <span class="nav-text">設定　Sentinel</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#測試轉移"><span class="nav-number">6.</span> <span class="nav-text">測試轉移</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#程式連線"><span class="nav-number">7.</span> <span class="nav-text">程式連線</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#後記"><span class="nav-number">8.</span> <span class="nav-text">後記</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#參考資料"><span class="nav-number">9.</span> <span class="nav-text">參考資料</span></a></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Sky Chang</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io" target="_blank" rel="noopener">Hexo</a> 強力驅動
</div>

<div class="theme-info">
  主題 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next" target="_blank" rel="noopener">
    NexT.Mist
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  



  

    <script type="text/javascript">
      var disqus_shortname = 'skychang';
      var disqus_identifier = '2017/04/09/Redis-Create_Redis_HA/';
      var disqus_title = 'Redis - 在 Windows 上建立高可用性的 Redis';
      var disqus_url = 'http://skychang.github.io/2017/04/09/Redis-Create_Redis_HA/';

      function run_disqus_script(disqus_script){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }

      run_disqus_script('count.js');
      
        run_disqus_script('embed.js');
      
    </script>
  



  
  
  

  

  

</body>
</html>
