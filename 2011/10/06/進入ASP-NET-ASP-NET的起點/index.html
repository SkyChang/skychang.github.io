<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="google-site-verification" content="iFYOZeAkjA9mpw80K_6C3Ybqm8zAmrJ3XXy5cSphRew" />










  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="ASP.NET,ASP.NET MVC,IIS," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description" content="最近開始深入ASP.NET的核心，花了很多時間來了解，也翻了很多書還有找了很多很多網站，同樣的如果不寫這篇，我想大概沒幾天我就忘記了，就像是委派一樣，看過四次，但還是只剩一些殘餘的印象XDD ( 所以下次一定要把委派整理起來- - )，所以我決定還是稱現在比較清楚的時候，趕快整理起來，並且寫到Blog來做個紀錄。 ASP.NET 核心這系列是ASP.NET核心篇的起點，也就是ASP.NET底層是怎">
<meta property="og:type" content="article">
<meta property="og:title" content="進入ASP.NET - ASP.NET的起點">
<meta property="og:url" content="http://skychang.github.io/2011/10/06/%E9%80%B2%E5%85%A5ASP-NET-ASP-NET%E7%9A%84%E8%B5%B7%E9%BB%9E/index.html">
<meta property="og:site_name" content="天空的垃圾場">
<meta property="og:description" content="最近開始深入ASP.NET的核心，花了很多時間來了解，也翻了很多書還有找了很多很多網站，同樣的如果不寫這篇，我想大概沒幾天我就忘記了，就像是委派一樣，看過四次，但還是只剩一些殘餘的印象XDD ( 所以下次一定要把委派整理起來- - )，所以我決定還是稱現在比較清楚的時候，趕快整理起來，並且寫到Blog來做個紀錄。 ASP.NET 核心這系列是ASP.NET核心篇的起點，也就是ASP.NET底層是怎">
<meta property="og:locale" content="zh_TW">
<meta property="article:published_time" content="2011-10-06T18:57:00.000Z">
<meta property="article:modified_time" content="2020-05-27T12:09:39.079Z">
<meta property="article:author" content="Sky Chang">
<meta property="article:tag" content="ASP.NET">
<meta property="article:tag" content="ASP.NET MVC">
<meta property="article:tag" content="IIS">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>

  <title> 進入ASP.NET - ASP.NET的起點 | 天空的垃圾場 </title>
<meta name="generator" content="Hexo 4.2.1"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-tw">

  


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-29938905-2', 'auto');
  ga('send', 'pageview');
</script>









  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">天空的垃圾場</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首頁
          </a>
        </li>
      
        
        <li class="menu-item menu-item-development">
          <a href="/development" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            開發
          </a>
        </li>
      
        
        <li class="menu-item menu-item-alm">
          <a href="/alm" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            維運
          </a>
        </li>
      
        
        <li class="menu-item menu-item-cloud">
          <a href="/cloud" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            雲端
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            歸檔
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            標籤
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                進入ASP.NET - ASP.NET的起點
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">發表於</span>
            <time itemprop="dateCreated" datetime="2011-10-06T18:57:00+00:00" content="2011-10-06">
              2011-10-06
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2011/10/06/%E9%80%B2%E5%85%A5ASP-NET-ASP-NET%E7%9A%84%E8%B5%B7%E9%BB%9E/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2011/10/06/進入ASP-NET-ASP-NET的起點/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>最近開始深入ASP.NET的核心，花了很多時間來了解，也翻了很多書還有找了很多很多網站，同樣的如果不寫這篇，我想大概沒幾天我就忘記了，就像是委派一樣，看過四次，但還是只剩一些殘餘的印象XDD ( 所以下次一定要把委派整理起來- - )，所以我決定還是稱現在比較清楚的時候，趕快整理起來，並且寫到Blog來做個紀錄。</p>
<h4 id="ASP-NET-核心"><a href="#ASP-NET-核心" class="headerlink" title="ASP.NET 核心"></a>ASP.NET 核心</h4><p>這系列是ASP.NET核心篇的起點，也就是ASP.NET底層是怎樣運作的，從一個HTTP Request近來的時候，會怎樣處理，Web應用程式又是怎樣吐回到Client的Browser，老實說，看完後，我覺得還滿有趣的 ( 但是看的時候一點也不有趣= = )，而這系列也是比較硬派一點的文章，我也試著用我了解的方式且比較多的例子來詮釋一遍，當然，如果有神人發現有誤，請務必和我說喔!</p>
<h4 id="來寫一個Web-Server吧"><a href="#來寫一個Web-Server吧" class="headerlink" title="來寫一個Web Server吧!"></a>來寫一個Web Server吧!</h4><p>當個使用者其實是最開心的，甚麼都可以不用管，出問題了還可罵說，怎麼寫得那麼爛…，但是身為程式開發人員就倒楣了，不但要被罵，還要找出哪裡有問題…，所以我們也必須去了解底層是怎樣運作，所以我們這邊簡單的從Browser開始講起；其實當一個Browser要求一個網頁的時候，其實是一堆文字的來來回回，也就是透過協定來進行Client和Server的傳輸 ( 細節就不說了，如果有機會，我在另外一篇補完 )； 而我們平常使用的IIS或是Apache等等Web Server，提供的網頁服務，就是再處理Browser的請求；當Browser需要一個東西，Web Server就吐回去一個東西，ok，我相信講到這邊，大家應該都沒有問題，那既然我們也知道協定、傳輸等等方式，是不是可以用C#等等語言寫一個Web Server!?，答案當然是可以，但我想應該沒有人會那麼無聊，寫出像IIS或是Apache那樣強大的Web Server…( 或是說，也很難寫出來，還是乖乖地用人家寫的吧 )，雖然無法寫出那麼強大的Web Server，但是簡單的還是可以吧!?，是的，就像下面的程式碼；不過不用急著去把它看完 ( 我想看到這麼長的程式，大概就會想直接按”上一頁”了吧… )；它的原理其實很簡單，利用TcpListener這個類別來監聽，聽到請求後就將資料吐回，當然你也可以用Socket這個類別或是HttpListener來實作；總之，我想強調的是，基本上Client和Server端通訊內容，其實也就是一堆文字，也就是利用這些文字來處理要做甚麼事情。</p>
<pre class="brush: csharp;">using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Net.Sockets;
using System.IO;
using System.Threading;
using System.Web;
using System.Web.Hosting;
using System.Net;

namespace AspNetSimulator
{
    class WebHandle
    {
        private TcpListener _tcpListener;    //監聽用
        private FileStream _fileStream;      //利用串流處理要求。
        private string _virtualDir;
        private string _realDir;

        public WebHandle(string virtualDir, string realDir)
        {
            this._virtualDir = virtualDir;
            this._realDir = realDir;
        }

        //啟動服務
        public void StartService()
        {
            try
            {
                IPEndPoint address = new IPEndPoint(IPAddress.Loopback, 8080);
                _tcpListener = new TcpListener(address);
                //啟動監聽
                _tcpListener.Start();   
                Console.WriteLine("啟動服務...");

                WebServiceStart();
            }
            catch (NullReferenceException)
            {
                Console.WriteLine("NullReferenceException throwed!");
            }
        }

        //主要服務
        public void WebServiceStart()
        {
            while (true)
            {
                //建立連線
                TcpClient tcpClient = _tcpListener.AcceptTcpClient();
                Console.WriteLine("連線建立...");
                //取得網路串流
                NetworkStream networkStream = tcpClient.GetStream();
                //設定使用UTF-8
                Encoding utf8 = Encoding.UTF8;
                byte[] request = new byte[4096];
                //讀取請求，並塞到request裡面，此方法會傳回長度。
                int length = networkStream.Read(request, 0, 4096);
                //轉換成人類能看得懂的字串。
                string requestString = utf8.GetString(request, 0, length);

                string output = "";
                //中間略，簡單的說就是將網頁輸出到output...

                //以下只是簡單的將訊息送出。
                string statusLine = "HTTP/1.1 200 OK\r\n";
                byte[] outputStatusLineBs = utf8.GetBytes(statusLine);
                byte[] outputBodyBs = utf8.GetBytes(output);
                string responseHeader = string.Format("Content-Type: text/html;charset=UTF-8\r\nContent-Length:{0}\r\n",outputBodyBs.Length);
                byte[] outputResponseHeaderBs = utf8.GetBytes(responseHeader);
                networkStream.Write(outputStatusLineBs, 0, outputStatusLineBs.Length);
                networkStream.Write(outputResponseHeaderBs, 0, outputResponseHeaderBs.Length);
                networkStream.Write(new byte[]{13,10},0,2);
                networkStream.Write(outputBodyBs, 0, outputBodyBs.Length);
                tcpClient.Close();
            }
        }
    }
}
</pre>

<h4 id="NET的Application-Domain"><a href="#NET的Application-Domain" class="headerlink" title=".NET的Application Domain"></a>.NET的Application Domain</h4><p>在談論ASP.NET之前，先說一個觀念，那就是Application Domain，他是.NET裡面管理的最小單位，舉例來說，每個Web應用程式會有一個Application Domain ( 和 Application Pool不同…)，而Web Server也會有一個Application Domain；而Application Domain會有一些特性，例如說，兩個Application Domain不能直接互通、執行時，以Application Domian為邊界、卸載的時候也以Application Domain為單位 ( 但是可以隨時動態載入組件 )等等。</p>
<h4 id="為何會提到Application-Domain"><a href="#為何會提到Application-Domain" class="headerlink" title="為何會提到Application Domain?"></a>為何會提到Application Domain?</h4><p>其實是因為Application Domain有一個關鍵性的特點，發現了嗎?就是兩個Application Domain不能直接互通!，簡單的說，當一個Web Server收到Client的請求時，Web Server沒辦法跨Application Domain到Web應用程式的Application Domain來讓Web應用程式處理這個請求 ( 也就是說Web應用程式沒辦法得知這個Client的請求，所以也沒辦法處理，然後吐回處理過的html網頁… )。</p>
<h4 id="MarshalByRefObject是救星"><a href="#MarshalByRefObject是救星" class="headerlink" title="MarshalByRefObject是救星!"></a>MarshalByRefObject是救星!</h4><p>沒錯，解決辦法就是使用MarshalByRefObject這個類別，繼承了這個類別的物件，可以讓Web Server透過他來將資料封裝起來並傳遞到Web應用程式裡面去，然後再吐回Web Server。</p>
<h4 id="來看看MarshalByRefObject如何寫"><a href="#來看看MarshalByRefObject如何寫" class="headerlink" title="來看看MarshalByRefObject如何寫"></a>來看看MarshalByRefObject如何寫</h4><pre class="brush: csharp;">using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.IO;
using System.Web.Hosting;
using System.Web;

namespace AspNetSimulator
{
    //繼承MarshalByRefObject來讓MyAspNetHost跨越兩個Application Domain 
    class MyAspNetHost:MarshalByRefObject
    {
         public void  ProcessRequest( string fileName ,ref string output)
         {
             //利用記憶體當串流。
             MemoryStream memoryStream=new MemoryStream();
             //設定輸出，來將網頁透過這個Stream送到這裡。
             StreamWriter streamWriter = new StreamWriter(memoryStream);
             //自動更新 
             streamWriter.AutoFlush = true;      
             //利用HttpWorkRequest類別，來設定要給Web應用程式的請求。
             //第一個參數是檔案名稱，第二個參數是query，第三個參數是將產生出來的html要透過哪個Stream做寫入至Memory
             HttpWorkerRequest worker = new SimpleWorkerRequest(fileName, "", streamWriter);   
             //正式派發出去執行。
             HttpRuntime.ProcessRequest(worker) ;
             //準備讀取的Stream
             StreamReader streamReader = new StreamReader(memoryStream);
             //移動指標
             memoryStream.Position = 0;
             //從頭讀到尾，並且塞到output裡面去。
             output = streamReader.ReadToEnd();
         }
    }
}
</pre>

<p>這裡要特別注意，此物件並不是用來傳遞，而是定義了這個物件以後，到時候我們的Web Server就可以來呼叫這個物件的方法，如上所示，我們就可以在Web Server這個類別使用ProcessRequest()這個方法；接下來，我們稍微解釋一下程式碼，基本上前面幾行設定串流模式，並利用記憶體當儲存體；比較需要注意的是這兩行。</p>
<pre class="brush: csharp;"> //利用HttpWorkRequest類別，來設定要給Web應用程式的請求。
 //第一個參數是檔案名稱，第二個參數是query，第三個參數是將產生出來的html要透過哪個Stream做寫入至Memory
 HttpWorkerRequest worker = new SimpleWorkerRequest(fileName, "", streamWriter);   
 //正式派發出去執行。
 HttpRuntime.ProcessRequest(worker) ;
</pre>

<p>我們利用SimpleWorkerRequest類別來產生HttpWorkerRequest這個抽象類別的實體 ( 也就是woker )，這裡有三個參數，第一個參數其實就是檔案名稱，例如Test.aspx，而第二個參數則是query，已就是檔案後面的?xxx=xxxx這種URL的query，第三個則表示未來Web應用程式產出的HTML要利用哪個串流來進行寫入，( 而這邊因為是範例，第二個參數就直接給空白)，最後再將這個實體( worker ) 送到HttpRuntime.ProcessRequest來執行，送進去後，就是Web應用程式的事情了，經過一連串的執行運算，最後會產生HTML，並且透過串流寫到記憶體，所以就可以用以下程式碼進行取出。</p>
<pre class="brush: csharp;"> //準備讀取的Stream
 StreamReader streamReader = new StreamReader(memoryStream);
 //移動指標
 memoryStream.Position = 0;
 //從頭讀到尾，並且塞到output裡面去。
 output = streamReader.ReadToEnd();
</pre>

<p>要注意的是output是利用ref的方式，也就是說，到時候Web Server會定義一個output的變數，未來這裡會直接寫回到Web Server的output變數裡面，這樣，就完成了中介的MarshalByRefObject物件。</p>
<h4 id="ApplicationHost-CreateApplicationHost方法"><a href="#ApplicationHost-CreateApplicationHost方法" class="headerlink" title="ApplicationHost.CreateApplicationHost方法"></a>ApplicationHost.CreateApplicationHost方法</h4><p>開始撰寫Web Server之前，還有一個東西需要講，那就是ApplicationHost.CreateApplicationHost這個方法，CreateApplicationHost是ApplicationHost的一個靜態方法，他可以幫助我們建立Web應用程式的Application Domain；我們執行程式時，當然會先將Web Server執行起來，也會建立起Web Server的Application Domain，但是Web應用程式呢?，所以我們會在Web Server裡面去建立Web應用程式的Application Domain，而建立的方法就是使用CreateApplicationHost。</p>
<pre class="brush: csharp;">//利用CreateApplicationHost方法來建立一個ASP.NET的Application Domain，
//以便執行ASP.NET。
_myAspNetHost = (MyAspNetHost)ApplicationHost.CreateApplicationHost
    (typeof(MyAspNetHost), _virtualDir, _realDir);
</pre>

<p>如上程式碼，就是建立Web應用程式的Application Domain的寫法，他會帶三個參數，第一個是最難解釋的，先跳過，第二個參數其實就是Web應用程式的根所對應的虛擬路徑，第三個則是實體路徑；接下來我們回來講第一個參數，通常我們會把剛剛寫好的MarshalByRefObject物件放到第一個參數，並且使用typeof來取得MarshalByRefObject的Type這個型別，老實說，這塊我看了很久，最後還去翻Source來查，才知道比較細的細節，以下我們先看一下CreateApplicationHost這個程式碼。</p>
<pre class="brush: csharp;">[SecurityPermission(SecurityAction.Demand, Unrestricted=true)]
public static object CreateApplicationHost(Type hostType, string virtualDir, string physicalDir)
{
    if (Environment.OSVersion.Platform != PlatformID.Win32NT)
    {
        throw new PlatformNotSupportedException(SR.GetString("RequiresNT"));
    }
    if (!StringUtil.StringEndsWith(physicalDir, Path.DirectorySeparatorChar))
    {
        physicalDir = physicalDir + Path.DirectorySeparatorChar;
    }
    ApplicationManager applicationManager = ApplicationManager.GetApplicationManager();
    string appId = (virtualDir + physicalDir).GetHashCode().ToString("x");
    return applicationManager.CreateInstanceInNewWorkerAppDomain(hostType, appId, VirtualPath.CreateNonRelative(virtualDir), physicalDir).Unwrap();
}
</pre>

<p>上面在敘說CreateApplicationHost這個方法，我們其實可以看到，傳進來的Type型別，又傳入到CreateInstanceInNewWorkerAppDomain裡面去，所以再往下看吧。</p>
<pre class="brush: csharp;">internal ObjectHandle CreateInstanceInNewWorkerAppDomain(Type type, string appId, VirtualPath virtualPath, string physicalPath)
{
    IApplicationHost appHost = new SimpleApplicationHost(virtualPath, physicalPath);
    HostingEnvironmentParameters hostingParameters = new HostingEnvironmentParameters {
        HostingFlags = HostingEnvironmentFlags.HideFromAppManager
    };
    return this.CreateAppDomainWithHostingEnvironmentAndReportErrors(appId, appHost, hostingParameters).CreateInstance(type.AssemblyQualifiedName);
}
</pre>

<p>到這邊，直接跳到最後一行，我們可以看到type.AssmblyQualifiedName，其實這是取出type的詳細資訊，也就是MarshalByRefObject的NameSpace、版本、等等的詳細資訊；這邊如果再繼續查下去，還有非常多層，我就跳過不講了，但至少我們發現了關鍵，也就是說，這邊轉成Type是為了讓Web應用程式的Application Domain在runtime時，動態載入MarshalByRefObject這個物件，所以在runtime的時候，程式會去尋找GAC和網站底下的bin目錄，並將之載入，所以需要知道MarshalByRefObject這個物件的詳細資訊，所以使用Type來取得詳細資訊；到這邊，我們知道了CreateApplicatinHost如何使用，我們就可以開始寫Web Server了。</p>
<h4 id="撰寫Web-Server"><a href="#撰寫Web-Server" class="headerlink" title="撰寫Web Server"></a>撰寫Web Server</h4><p>接下來就是整段的Web Server程式碼，下面比較簡單的都註解了，基本上看一下應該都可以看得懂。</p>
<pre class="brush: csharp;">using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Net.Sockets;
using System.IO;
using System.Threading;
using System.Web;
using System.Web.Hosting;
using System.Net;

namespace AspNetSimulator
{
    class WebHandle
    {
        //繼承了MarshalByRefObject的MyAspNetHost，
        //負責處理We Server 和 Asp.net Application Domain之間的通訊
        private MyAspNetHost _myAspNetHost;
        private TcpListener _tcpListener;    //監聽用
        private FileStream _fileStream;      //利用串流處理要求。
        private string _virtualDir;
        private string _realDir;

        public WebHandle(string virtualDir, string realDir)
        {
            this._virtualDir = virtualDir;
            this._realDir = realDir;
        }

        //啟動服務
        public void StartService()
        {
            try
            {
                IPEndPoint address = new IPEndPoint(IPAddress.Loopback, 8080);
                _tcpListener = new TcpListener(address);
                //啟動監聽
                _tcpListener.Start();   
                Console.WriteLine("啟動服務...");
                //利用CreateApplicationHost方法來建立一個ASP.NET的Application Domain，
                //以便執行ASP.NET。
                _myAspNetHost = (MyAspNetHost)ApplicationHost.CreateApplicationHost
                    (typeof(MyAspNetHost), _virtualDir, _realDir);
              //啟動服務
                WebServiceStart();
            }
            catch (NullReferenceException)
            {
                Console.WriteLine("NullReferenceException throwed!");
            }
        }

        //主要服務
        public void WebServiceStart()
        {
            while (true)
            {
                //建立連線
                TcpClient tcpClient = _tcpListener.AcceptTcpClient();
                Console.WriteLine("連線建立...");
                //取得網路串流
                NetworkStream networkStream = tcpClient.GetStream();
                //設定使用UTF-8
                Encoding utf8 = Encoding.UTF8;
                byte[] request = new byte[4096];
                //讀取請求，並塞到request裡面，此方法會傳回長度。
                int length = networkStream.Read(request, 0, 4096);
                //轉換成人類能看得懂的字串。
                string requestString = utf8.GetString(request, 0, length);

                string output = "";
                //這裡是關鍵，
                //簡單的說，就是WebHandle這個Application Domain 透過 _myAspNetHost 來和
                //ASP.NET Application Domain傳遞訊息。
                //( 這裡因為是Demo，所以就直接指定為Test.aspx網頁了 )
                //而使用ref來將ASP.NET Application Domain的資料塞回這裡。
                _myAspNetHost.ProcessRequest("Test.aspx", ref output);
                //以下只是簡單的將訊息送出。
                string statusLine = "HTTP/1.1 200 OK\r\n";
                byte[] outputStatusLineBs = utf8.GetBytes(statusLine);
                byte[] outputBodyBs = utf8.GetBytes(output);
                string responseHeader = string.Format("Content-Type: text/html;charset=UTF-8\r\nContent-Length:{0}\r\n",outputBodyBs.Length);
                byte[] outputResponseHeaderBs = utf8.GetBytes(responseHeader);
                networkStream.Write(outputStatusLineBs, 0, outputStatusLineBs.Length);
                networkStream.Write(outputResponseHeaderBs, 0, outputResponseHeaderBs.Length);
                networkStream.Write(new byte[]{13,10},0,2);
                networkStream.Write(outputBodyBs, 0, outputBodyBs.Length);
                tcpClient.Close();
            }
        }
    }
}
</pre>

<p>我們會在_tcpListerer.start()後，建立Web應用程式的Application Domain，來讓Web應用程式準備運作，然後進入WebServiceStart方法，利用無窮迴圈來讓服務不中斷，而當程式讀到這行時，就會暫停，直到有請求進來，並繼續執行下去；另外WebServiceStart可以使用執行序來進行多執行序的處理，這裡是簡單的Demo，就直接這樣寫了。</p>
<pre class="brush: csharp;">TcpClient tcpClient = _tcpListener.AcceptTcpClient();
</pre>

<p>然後就進行串流的讀取，將請求的部分進行處理，如果寫的複雜一點，可能也還需去判斷要求的是哪個檔案，或是有沒有query等等的處理。( 所以沒事不要自己寫Web Server… )最後到下面這行，這邊就是透過繼承了MarshalByRefObject的物件，並呼叫此物件的方法，如上所說，經過一連串的執行，就會把html資料吐回到output裡面。</p>
<pre class="brush: csharp;">//這裡是關鍵，
//簡單的說，就是WebHandle這個Application Domain 透過 _myAspNetHost 來和
//ASP.NET Application Domain傳遞訊息。
//( 這裡因為是Demo，所以就直接指定為Test.aspx網頁了 )
//而使用ref來將ASP.NET Application Domain的資料塞回這裡。
_myAspNetHost.ProcessRequest("Test.aspx", ref output);
</pre>

<p>最後，我們去把這些資料輸出回瀏覽器，就完成了這個平常簡單的一次請求…</p>
<h4 id="還有一小段進入點"><a href="#還有一小段進入點" class="headerlink" title="還有一小段進入點!"></a>還有一小段進入點!</h4><p>另外，有沒有發現上面全部都是類別，完全沒有進入點，其實我是使用了Console專案來撰寫，所以下面補上程式的進入點，於是Web Server (偽) 就完成了=w=。</p>
<pre class="brush: csharp;">using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;

namespace AspNetSimulator
{
    class ServerSimulator
    {
        static void Main(string[] args)
        {
            WebHandle webHandle = new WebHandle("/", "C:\\My\\TestWeb");
            webHandle.StartService();
        }
    }
}
</pre>

<p>寫了那麼多，其實也只是ASP.NET的開頭，也希望能讓大家對ASP.NET的一些基礎能更加瞭解!</p>

      
    </div>

    <div>
      
        
      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/ASP-NET/" rel="tag">#ASP.NET</a>
          
            <a href="/tags/ASP-NET-MVC/" rel="tag">#ASP.NET MVC</a>
          
            <a href="/tags/IIS/" rel="tag">#IIS</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2011/10/04/%E9%96%8B%E7%99%BC%E4%BA%BA%E6%87%89%E8%A9%B2%E5%AD%B8%E7%9A%84%EF%BC%8C%E7%94%A8Visual-Studio%E9%96%8B%E7%99%BCSQL-SQL-Server-Data-Tools-%E4%B8%8D%E4%BD%BF%E7%94%A8DataBase-Project%E7%9A%84%E9%96%8B%E7%99%BC%E6%A8%A1%E5%BC%8F/" rel="next" title="開發人應該學的，用Visual Studio開發SQL(SQL Server Data Tools) - 不使用DataBase Project的開發模式">
                <i class="fa fa-chevron-left"></i> 開發人應該學的，用Visual Studio開發SQL(SQL Server Data Tools) - 不使用DataBase Project的開發模式
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2011/10/11/ASP-NET-MVC-WebGrid%E9%85%8D%E5%90%88Ajax%E5%8B%95%E6%85%8B%E5%88%AA%E9%99%A4WebGrid%E7%9A%84Row/" rel="prev" title="ASP.NET MVC - WebGrid配合Ajax動態刪除WebGrid的Row">
                ASP.NET MVC - WebGrid配合Ajax動態刪除WebGrid的Row <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="//disqus.com/?ref_noscript" target="_blank" rel="noopener">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目錄
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            本站概覽
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="Sky Chang" />
          <p class="site-author-name" itemprop="name">Sky Chang</p>
          <p class="site-description motion-element" itemprop="description">雖然是垃圾場，但還是有許多好東西</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">354</span>
              <span class="site-state-item-name">文章</span>
            </a>
          </div>

          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">108</span>
                <span class="site-state-item-name">標籤</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-4"><a class="nav-link" href="#ASP-NET-核心"><span class="nav-number">1.</span> <span class="nav-text">ASP.NET 核心</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#來寫一個Web-Server吧"><span class="nav-number">2.</span> <span class="nav-text">來寫一個Web Server吧!</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#NET的Application-Domain"><span class="nav-number">3.</span> <span class="nav-text">.NET的Application Domain</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#為何會提到Application-Domain"><span class="nav-number">4.</span> <span class="nav-text">為何會提到Application Domain?</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#MarshalByRefObject是救星"><span class="nav-number">5.</span> <span class="nav-text">MarshalByRefObject是救星!</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#來看看MarshalByRefObject如何寫"><span class="nav-number">6.</span> <span class="nav-text">來看看MarshalByRefObject如何寫</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ApplicationHost-CreateApplicationHost方法"><span class="nav-number">7.</span> <span class="nav-text">ApplicationHost.CreateApplicationHost方法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#撰寫Web-Server"><span class="nav-number">8.</span> <span class="nav-text">撰寫Web Server</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#還有一小段進入點"><span class="nav-number">9.</span> <span class="nav-text">還有一小段進入點!</span></a></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Sky Chang</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io" target="_blank" rel="noopener">Hexo</a> 強力驅動
</div>

<div class="theme-info">
  主題 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next" target="_blank" rel="noopener">
    NexT.Mist
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  



  

    <script type="text/javascript">
      var disqus_shortname = 'skychang';
      var disqus_identifier = '2011/10/06/進入ASP-NET-ASP-NET的起點/';
      var disqus_title = '進入ASP.NET - ASP.NET的起點';
      var disqus_url = 'http://skychang.github.io/2011/10/06/%E9%80%B2%E5%85%A5ASP-NET-ASP-NET%E7%9A%84%E8%B5%B7%E9%BB%9E/';

      function run_disqus_script(disqus_script){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }

      run_disqus_script('count.js');
      
        run_disqus_script('embed.js');
      
    </script>
  



  
  
  

  

  

</body>
</html>
