<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.796ada07b3eebed52170.css">.icon-module--root--aZeph{display:inline-flex;align-items:center;justify-content:center}.icon-module--icon--1ihz7{fill:currentColor}.icon-module--label--fHC-f{position:relative;display:inline-block;margin-left:4px;line-height:1}.menu-module--mobileMenuContainer--T9wTN{display:none}@media (max-width:683px){.menu-module--mobileMenuContainer--T9wTN{display:flex}}.menu-module--desktopMenuContainer--3iXKR{display:block}@media (max-width:683px){.menu-module--desktopMenuContainer--3iXKR{display:none}}.menu-module--menu--dd4-Y{display:flex;flex:0 0 auto;align-items:center;justify-content:flex-start;max-width:100%;padding:0 15px;list-style:none;border-right:1px solid;margin:0 18px 0 auto}.menu-module--menu--dd4-Y li{margin:0 12px}.menu-module--menuTrigger--32seM{margin-right:10px;padding:0;line-height:0;background:none;color:inherit;border:none;box-shadow:none;outline:none;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer}.menu-module--menu--dd4-Y a{display:inline-block;margin-right:15px;text-decoration:none}.menu-module--menu--dd4-Y a:last-of-type{margin-right:0}.menu-module--mobileMenu--2VGmR{position:absolute;top:0;right:0;flex-direction:column;align-items:flex-start;background:#fafafa;margin:0;padding:0;text-align:left;list-style:none;border-radius:5px;overflow:hidden;z-index:99}.dark-theme .menu-module--mobileMenu--2VGmR{background:#252627}.menu-module--mobileMenu--2VGmR li{margin:0;white-space:nowrap}.menu-module--mobileMenu--2VGmR li a{display:block;padding:10px 15px}.menu-module--mobileMenuOverlay--2RcSs{position:fixed;top:0;bottom:0;left:0;right:0;background:rgba(0,0,0,.2);z-index:10}.menu-module--themeToggle--2E8ye{line-height:0;padding:0 5px}.menu-module--subMenuTrigger--1crdm,.menu-module--themeToggle--2E8ye{background:none;color:inherit;border:none;box-shadow:none;-webkit-appearance:none;-moz-appearance:none;appearance:none;outline:none}.menu-module--subMenuTrigger--1crdm{font-size:inherit;font-weight:inherit;margin:0 12px;padding:0;cursor:pointer}.menu-module--subMenu--3Rgj_{position:absolute;max-width:300px;background:#fafafa;box-shadow:0 8px 20px rgba(0,0,0,.12);margin:0;padding:5px;list-style:none;border-radius:5px;top:35px;right:70px;overflow:hidden;z-index:99}.dark-theme .menu-module--subMenu--3Rgj_{background:#3b3d42}.menu-module--subMenu--3Rgj_ li{text-align:left;margin:0;white-space:nowrap}.menu-module--subMenu--3Rgj_ li a{padding:10px}.menu-module--subMenu--3Rgj_ li:hover{background:rgba(0,0,0,.05);border-radius:3px;cursor:pointer}.dark-theme .menu-module--subMenu--3Rgj_ li:hover{background:rgba(0,0,0,.15)}.menu-module--subMenuOverlay--3TQRy{position:fixed;top:0;bottom:0;left:0;right:0;z-index:-1}.menu-module--menuArrow--1COMf{display:inline-block;font-family:Inter UI;margin-left:5px;transform:rotate(90deg)}.header-module--header--tFeG9{background:#fafafa;display:flex;align-items:center;justify-content:space-between;position:relative;padding:20px}.dark-theme .header-module--header--tFeG9{background:#252627}.header-module--header--tFeG9 a{text-decoration:none}.header-module--inner--7ao1M{justify-content:space-between;margin:0 auto;width:760px;max-width:100%}.header-module--inner--7ao1M,.header-module--logo--2kX-3{display:flex;align-items:center}.header-module--logo--2kX-3{text-decoration:none;font-weight:700}.header-module--logo--2kX-3 img{height:44px}.header-module--mark--J6C0c{margin-right:5px}.header-module--cursor--33Aoa{display:inline-block;width:10px;height:1rem;background:#fe5186;margin-left:5px;border-radius:1px;-webkit-animation:header-module--cursor--33Aoa 1s infinite;animation:header-module--cursor--33Aoa 1s infinite}.header-module--mark--J6C0c,.header-module--text--3UAQj{font-size:18px}.header-module--right--1Zeb6{display:flex;position:relative}@-webkit-keyframes header-module--cursor--33Aoa{0%{opacity:0}50%{opacity:1}to{opacity:0}}@keyframes header-module--cursor--33Aoa{0%{opacity:0}50%{opacity:1}to{opacity:0}}@font-face{font-family:Inter UI;font-style:normal;font-weight:400;src:url(/static/Inter-UI-Regular-ecf7c639683dfcb4868861e0c613c455.woff) format("woff")}@font-face{font-family:Inter UI;font-style:italic;font-weight:400;src:url(/static/Inter-UI-Italic-bcf654c7bea165e9dae257206c5521ad.woff) format("woff")}@font-face{font-family:Inter UI;font-style:normal;font-weight:600;src:url(/static/Inter-UI-Medium-48dfecfe37de0ef8f0e2c2d2e6992e9c.woff) format("woff")}@font-face{font-family:Inter UI;font-style:italic;font-weight:600;src:url(/static/Inter-UI-MediumItalic-a9eddc92c84c5f78fba1cb7d7833d31c.woff) format("woff")}@font-face{font-family:Inter UI;font-style:normal;font-weight:800;src:url(/static/Inter-UI-Bold-e2158f600a4b0175b73dfefb0d2fe8f8.woff) format("woff")}@font-face{font-family:Inter UI;font-style:italic;font-weight:800;src:url(/static/Inter-UI-BoldItalic-dbe4ec1d26d41331c91550939a7fd27f.woff) format("woff")}pre[class*=language-],pre[class*=language-]>code{color:#a9a9b3;background:none;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto;background:#1a1a1d!important;border-radius:8px}.token.block-comment,.token.cdata,.token.comment,.token.doctype,.token.prolog{color:hsla(0,0%,100%,.35)}.token.punctuation{color:#a9a9b3}.token.attr-name,.token.deleted,.token.namespace,.token.tag{color:#e2777a}.token.function-name{color:#6196cc}.token.boolean,.token.function,.token.number{color:#f08d49}.token.class-name,.token.constant,.token.property,.token.symbol{color:#f8c555}.token.atrule,.token.builtin,.token.important,.token.keyword,.token.selector{color:#cc99cd}.token.attr-value,.token.char,.token.regex,.token.string,.token.variable{color:#7ec699}.token.entity,.token.operator,.token.url{color:#67cdcc}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.token.inserted{color:green}pre[class*=language-].line-numbers{position:relative;padding-left:65px;counter-reset:linenumber}pre[class*=language-].line-numbers>code{position:relative;white-space:inherit}.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:5px!important;width:3em!important;letter-spacing:-1px;border-right:1px solid;opacity:.5;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}div.code-toolbar{position:relative}div.code-toolbar>.toolbar{position:absolute;top:.3em;right:.2em;transition:opacity .3s ease-in-out;opacity:0}div.code-toolbar:hover>.toolbar{opacity:1}div.code-toolbar>.toolbar .toolbar-item{display:inline-block}div.code-toolbar>.toolbar a{cursor:pointer}div.code-toolbar>.toolbar button{background:none;border:0;color:inherit;font:inherit;line-height:normal;overflow:visible;padding:0;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none}div.code-toolbar>.toolbar a,div.code-toolbar>.toolbar button,div.code-toolbar>.toolbar span{color:#bbb;font-size:.8em;padding:0 .5em;background:#f5f2f0;background:hsla(0,0%,87.8%,.2);box-shadow:0 2px 0 0 rgba(0,0,0,.2);border-radius:.5em}div.code-toolbar>.toolbar a:focus,div.code-toolbar>.toolbar a:hover,div.code-toolbar>.toolbar button:focus,div.code-toolbar>.toolbar button:hover,div.code-toolbar>.toolbar span:focus,div.code-toolbar>.toolbar span:hover{color:inherit;text-decoration:none}.command-line-prompt{border-right:1px solid #999;display:block;float:left;font-size:100%;letter-spacing:-1px;margin-right:1em;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.command-line-prompt>span:before{color:#999;content:" ";display:block;padding-right:.8em}.command-line-prompt>span[data-user]:before{content:"[" attr(data-user) "@" attr(data-host) "] $"}.command-line-prompt>span[data-user=root]:before{content:"[" attr(data-user) "@" attr(data-host) "] #"}.command-line-prompt>span[data-prompt]:before{content:attr(data-prompt)}html{box-sizing:border-box}*,:after,:before{box-sizing:inherit}body{margin:0;padding:0;font-family:Inter UI,-apple-system,BlinkMacSystemFont,Roboto,Segoe UI,Helvetica,Arial,sans-serif;font-size:1rem;line-height:1.8;background-color:#fff;color:#222;text-rendering:optimizeLegibility;-webkit-font-smoothing:antialiased;font-feature-settings:"liga","tnum","case","calt","zero","ss01","locl";-webkit-overflow-scrolling:touch;-webkit-text-size-adjust:100%}@media (max-width:683px){body{font-size:1rem}}body.dark-theme{background-color:#292a2d;color:#b8becf}h1,h2,h3,h4,h5,h6{display:flex;align-items:center;line-height:1.3}h1{font-size:2.2rem}h2{font-size:1.625rem}h2,h3{margin-top:50px;margin-bottom:20px}h3{font-size:1.375rem}h4{font-size:1.125rem;margin-top:50px;margin-bottom:20px}@media (max-width:683px){h1{font-size:2rem}h2{font-size:1.4rem}h3{font-size:1.15rem}h4{font-size:1.125rem}}p{margin-bottom:20px}a{color:inherit}img{display:block;max-width:100%}img.center,img.left{margin-right:auto}img.center,img.right{margin-left:auto}figure{display:table;max-width:100%;margin:25px 0}figure.center,figure.left{margin-right:auto}figure.center,figure.right{margin-left:auto}figure figcaption{font-size:14px;margin-top:5px;opacity:.8}figure figcaption.left{text-align:left}figure figcaption.center{text-align:center}figure figcaption.right{text-align:right}code{font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-feature-settings:normal;font-weight:400;background:#eaeaea;padding:1px 6px;margin:0 2px;border-radius:5px;font-size:.9rem}.dark-theme code{background:#3b3d42}pre{background:#1a1a1d;padding:20px;border-radius:8px;font-size:.9rem;overflow:auto}@media (max-width:683px){pre{white-space:pre-wrap;word-wrap:break-word}}pre code{background:none!important;color:#ccc;margin:0;padding:0;font-size:.9rem}blockquote{border-left:2px solid;margin:40px;padding:10px 20px}@media (max-width:683px){blockquote{margin:10px;padding:10px}}blockquote p:first-of-type{margin-top:0}blockquote p:last-of-type{margin-bottom:0}table{table-layout:fixed;border-collapse:collapse;width:100%;margin:40px 0;border-radius:5px}table,td,th{border:1px solid #222;padding:10px}.dark-theme table,.dark-theme td,.dark-theme th{border-color:#b8becf}th{background:#eaeaea}.dark-theme th{background:#3b3d42}ol,ul{margin-left:40px;padding:0}@media (max-width:683px){ol,ul{margin-left:20px}}ol ol{list-style-type:lower-alpha}button,input,textarea{font-family:Inter UI,-apple-system,BlinkMacSystemFont,Roboto,Segoe UI,Helvetica,Arial,sans-serif}.container{flex-direction:column;text-align:center}.container,.content{display:flex;justify-content:center}.content{flex-direction:column;flex:1 0 auto;align-items:center;margin:50px auto;width:100%;max-width:800px}@media (max-width:683px){.content{margin-top:0}}@media (max-width:899px){.content{max-width:660px}}hr{width:100%;border:none;background:#dcdcdc;height:1px}.dark-theme hr{background:#4a4b50}.infoBanner{text-align:left;margin:20px 0 40px;padding:10px 20px;border-radius:10px;width:calc(100% - 40px);background:#eaeaea}.dark-theme .infoBanner{background:#3b3d42}.infoBanner span{font-weight:700}.hidden{display:none}.embedVideo-container{position:relative;padding-bottom:56.25%;height:0;overflow:hidden}.embedVideo-container iframe{position:absolute;top:0;left:0;width:100%;height:100%;border:0}footer{font-size:1rem;text-align:center;margin-bottom:50px}@media (max-width:683px){footer{display:flex;flex-direction:column}}footer .footerCopyrights:not(:first-of-type){margin-left:20px;padding-left:20px;border-left:1px solid}@media (max-width:683px){footer .footerCopyrights:not(:first-of-type){margin:0;padding:0;border:none}}.navigation-module--navigation--3Zfju{display:flex;width:1024px;max-width:100%;margin:80px 0 40px}.navigation-module--button--28kp3,.navigation-module--navigation--3Zfju{align-items:center;justify-content:center}.navigation-module--button--28kp3{position:relative;display:inline-flex;background:#eaeaea;font-size:1rem;font-weight:700;border-radius:8px;max-width:40%;cursor:pointer;-webkit-appearance:none;-moz-appearance:none;appearance:none}.dark-theme .navigation-module--button--28kp3{background:#3b3d42}.navigation-module--button--28kp3+.navigation-module--button--28kp3{margin-left:10px}.navigation-module--button--28kp3 a{display:flex;padding:8px 16px;text-decoration:none}.navigation-module--button--28kp3 a,.navigation-module--buttonText--1Xod2{text-overflow:ellipsis;white-space:nowrap;overflow:hidden}.navigation-module--iconNext--3xyJ-{margin-left:8px}.navigation-module--iconPrev--23mg1{margin-right:8px}.post-module--post--28Mq2{width:100%;max-width:800px;text-align:left;padding:20px;margin:0 auto 20px}.post-module--post--28Mq2:not(:last-of-type){border-bottom:1px solid #dcdcdc}.dark-theme .post-module--post--28Mq2:not(:last-of-type){border-color:#4a4b50}@media (max-width:899px){.post-module--post--28Mq2{max-width:660px}}.post-module--post--28Mq2 h1{margin:0 0 10px}.post-module--post--28Mq2 img{border-radius:8px}.post-module--title--3XBo2 a{text-decoration:none}.post-module--coverImage--1GM7V{border-radius:8px;margin-bottom:40px;box-shadow:0 15px 30px rgba(0,0,0,.1)}.post-module--meta--3YtjE{font-size:1rem;margin-bottom:30px}.post-module--tags--3RbqF{margin-top:10px;opacity:.5}.post-module--tag--16U9p{margin-right:10px}.post-module--readMore--3zWML,.post-module--tag--16U9p{display:inline-block}.post-module--readMore--3zWML{text-decoration:none;font-weight:700;margin:20px 0;font-size:1rem}.post-module--postContent--1bfnt{position:relative}</style><meta name="generator" content="Gatsby 2.22.12"/><title data-react-helmet="true">進入ASP.NET - ASP.NET的起點 :: 天空的垃圾場 v3</title><meta data-react-helmet="true" name="description" content="最近開始深入ASP.NET的核心，花了很多時間來了解，也翻了很多書還有找了很多很多網站，同樣的如果不寫這篇，我想大概沒幾天我就忘記了，就像是委派一樣，看過四次，但還是只剩一些殘餘的印象XDD…"/><meta data-react-helmet="true" property="og:title" content="進入ASP.NET - ASP.NET的起點"/><meta data-react-helmet="true" property="og:description" content="最近開始深入ASP.NET的核心，花了很多時間來了解，也翻了很多書還有找了很多很多網站，同樣的如果不寫這篇，我想大概沒幾天我就忘記了，就像是委派一樣，看過四次，但還是只剩一些殘餘的印象XDD…"/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:title" content="進入ASP.NET - ASP.NET的起點"/><meta data-react-helmet="true" name="twitter:description" content="最近開始深入ASP.NET的核心，花了很多時間來了解，也翻了很多書還有找了很多很多網站，同樣的如果不寫這篇，我想大概沒幾天我就忘記了，就像是委派一樣，看過四次，但還是只剩一些殘餘的印象XDD…"/><meta data-react-helmet="true" name="twitter:creator" content="Sky Chang"/><meta data-react-helmet="true" name="keywords" content="gatsby, minimal, starter, blog, theme, dark, light, personal site"/><link rel="icon" href="/favicon-32x32.png?v=9e099edb68c6a2f5bc8ed47b25bd8ece"/><link rel="manifest" href="/manifest.webmanifest"/><meta name="theme-color" content="#292a2d"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=9e099edb68c6a2f5bc8ed47b25bd8ece"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=9e099edb68c6a2f5bc8ed47b25bd8ece"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=9e099edb68c6a2f5bc8ed47b25bd8ece"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=9e099edb68c6a2f5bc8ed47b25bd8ece"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=9e099edb68c6a2f5bc8ed47b25bd8ece"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=9e099edb68c6a2f5bc8ed47b25bd8ece"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=9e099edb68c6a2f5bc8ed47b25bd8ece"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=9e099edb68c6a2f5bc8ed47b25bd8ece"/><link as="script" rel="preload" href="/webpack-runtime-5a5a97b7337a917cb0df.js"/><link as="script" rel="preload" href="/framework-75da9754c2a76bbaf08a.js"/><link as="script" rel="preload" href="/app-8a5ec9ca460de146e1b0.js"/><link as="script" rel="preload" href="/styles-9b6f388623a2ec93d35f.js"/><link as="script" rel="preload" href="/commons-588a46b1342b8cdac1fc.js"/><link as="script" rel="preload" href="/23c3d3a3a2879427593569aafa02d04d4d5b9e2a-ee33f3640e06062a9ba5.js"/><link as="script" rel="preload" href="/component---src-templates-page-js-e853b3cf8fae77fda562.js"/><link as="fetch" rel="preload" href="/page-data/2011/10/06/進入ASP-NET-ASP-NET的起點/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body class="dark-theme"><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div class="container"><header class="header-module--header--tFeG9"><div class="header-module--inner--7ao1M"><a href="/"><div class="header-module--logo--2kX-3"><span class="header-module--mark--J6C0c">&gt;</span><span class="header-module--text--3UAQj">天空的垃圾場 v3</span><span class="header-module--cursor--33Aoa"></span></div></a><span class="header-module--right--1Zeb6"><div class="menu-module--mobileMenuContainer--T9wTN"><button class="menu-module--menuTrigger--32seM" style="color:inherit" type="button" aria-label="Menu"><span class="icon-module--root--aZeph" style="cursor:pointer" role="figure"><svg version="1.1" width="24" height="24" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg"><path d="M4 34H40V30H4V34ZM4 24H40V20H4V24ZM4 10V14H40V10H4Z" class="icon-module--icon--1ihz7"></path></svg></span></button></div><div class="menu-module--desktopMenuContainer--3iXKR"><ul class="menu-module--menu--dd4-Y"><li><a href="/about">About</a></li><li><a href="/develop">Develop</a></li><li><a href="/cloud">Cloud</a></li><li><a href="/devops">DevOps</a></li></ul></div><button class="menu-module--themeToggle--2E8ye" type="button" aria-label="Theme toggle"><span class="icon-module--root--aZeph" style="cursor:pointer" role="figure"><svg version="1.1" width="24" height="24" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg"><path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z" class="icon-module--icon--1ihz7"></path></svg></span></button></span></div></header><div class="content"><div class="post-module--post--28Mq2"><div class="post-module--postContent--1bfnt"><h1 class="post-module--title--3XBo2">進入ASP.NET - ASP.NET的起點</h1><div class="post-module--meta--3YtjE">06 October 2011<!-- --> <!-- -->— Written by <!-- -->Sky Chang<div class="post-module--tags--3RbqF"><a href="/tag/ASP.NET/"><span class="post-module--tag--16U9p">#<!-- -->ASP.NET</span></a><a href="/tag/ASP.NET-MVC/"><span class="post-module--tag--16U9p">#<!-- -->ASP.NET MVC</span></a><a href="/tag/IIS/"><span class="post-module--tag--16U9p">#<!-- -->IIS</span></a></div></div><div><p>最近開始深入ASP.NET的核心，花了很多時間來了解，也翻了很多書還有找了很多很多網站，同樣的如果不寫這篇，我想大概沒幾天我就忘記了，就像是委派一樣，看過四次，但還是只剩一些殘餘的印象XDD ( 所以下次一定要把委派整理起來- - )，所以我決定還是稱現在比較清楚的時候，趕快整理起來，並且寫到Blog來做個紀錄。</p>
<h4>ASP.NET 核心</h4>
<p>這系列是ASP.NET核心篇的起點，也就是ASP.NET底層是怎樣運作的，從一個HTTP Request近來的時候，會怎樣處理，Web應用程式又是怎樣吐回到Client的Browser，老實說，看完後，我覺得還滿有趣的 ( 但是看的時候一點也不有趣= = )，而這系列也是比較硬派一點的文章，我也試著用我了解的方式且比較多的例子來詮釋一遍，當然，如果有神人發現有誤，請務必和我說喔!</p>
<h4>來寫一個Web Server吧!</h4>
<p>當個使用者其實是最開心的，甚麼都可以不用管，出問題了還可罵說，怎麼寫得那麼爛…，但是身為程式開發人員就倒楣了，不但要被罵，還要找出哪裡有問題…，所以我們也必須去了解底層是怎樣運作，所以我們這邊簡單的從Browser開始講起；其實當一個Browser要求一個網頁的時候，其實是一堆文字的來來回回，也就是透過協定來進行Client和Server的傳輸 ( 細節就不說了，如果有機會，我在另外一篇補完 )； 而我們平常使用的IIS或是Apache等等Web Server，提供的網頁服務，就是再處理Browser的請求；當Browser需要一個東西，Web Server就吐回去一個東西，ok，我相信講到這邊，大家應該都沒有問題，那既然我們也知道協定、傳輸等等方式，是不是可以用C#等等語言寫一個Web Server!?，答案當然是可以，但我想應該沒有人會那麼無聊，寫出像IIS或是Apache那樣強大的Web Server…( 或是說，也很難寫出來，還是乖乖地用人家寫的吧 )，雖然無法寫出那麼強大的Web Server，但是簡單的還是可以吧!?，是的，就像下面的程式碼；不過不用急著去把它看完 ( 我想看到這麼長的程式，大概就會想直接按"上一頁"了吧… )；它的原理其實很簡單，利用TcpListener這個類別來監聽，聽到請求後就將資料吐回，當然你也可以用Socket這個類別或是HttpListener來實作；總之，我想強調的是，基本上Client和Server端通訊內容，其實也就是一堆文字，也就是利用這些文字來處理要做甚麼事情。</p>
<pre class="brush: csharp;">using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Net.Sockets;
using System.IO;
using System.Threading;
using System.Web;
using System.Web.Hosting;
using System.Net;

namespace AspNetSimulator
{
    class WebHandle
    {
        private TcpListener _tcpListener;    //監聽用
        private FileStream _fileStream;      //利用串流處理要求。
        private string _virtualDir;
        private string _realDir;

        public WebHandle(string virtualDir, string realDir)
        {
            this._virtualDir = virtualDir;
            this._realDir = realDir;
        }

        //啟動服務
        public void StartService()
        {
            try
            {
                IPEndPoint address = new IPEndPoint(IPAddress.Loopback, 8080);
                _tcpListener = new TcpListener(address);
                //啟動監聽
                _tcpListener.Start();   
                Console.WriteLine("啟動服務...");

                WebServiceStart();
            }
            catch (NullReferenceException)
            {
                Console.WriteLine("NullReferenceException throwed!");
            }
        }

        //主要服務
        public void WebServiceStart()
        {
            while (true)
            {
                //建立連線
                TcpClient tcpClient = _tcpListener.AcceptTcpClient();
                Console.WriteLine("連線建立...");
                //取得網路串流
                NetworkStream networkStream = tcpClient.GetStream();
                //設定使用UTF-8
                Encoding utf8 = Encoding.UTF8;
                byte[] request = new byte[4096];
                //讀取請求，並塞到request裡面，此方法會傳回長度。
                int length = networkStream.Read(request, 0, 4096);
                //轉換成人類能看得懂的字串。
                string requestString = utf8.GetString(request, 0, length);

                string output = "";
                //中間略，簡單的說就是將網頁輸出到output...

                //以下只是簡單的將訊息送出。
                string statusLine = "HTTP/1.1 200 OK\r\n";
                byte[] outputStatusLineBs = utf8.GetBytes(statusLine);
                byte[] outputBodyBs = utf8.GetBytes(output);
                string responseHeader = string.Format("Content-Type: text/html;charset=UTF-8\r\nContent-Length:{0}\r\n",outputBodyBs.Length);
                byte[] outputResponseHeaderBs = utf8.GetBytes(responseHeader);
                networkStream.Write(outputStatusLineBs, 0, outputStatusLineBs.Length);
                networkStream.Write(outputResponseHeaderBs, 0, outputResponseHeaderBs.Length);
                networkStream.Write(new byte[]{13,10},0,2);
                networkStream.Write(outputBodyBs, 0, outputBodyBs.Length);
                tcpClient.Close();
            }
        }
    }
}
</pre>
<h4>.NET的Application Domain</h4>
<p>在談論ASP.NET之前，先說一個觀念，那就是Application Domain，他是.NET裡面管理的最小單位，舉例來說，每個Web應用程式會有一個Application Domain ( 和 Application Pool不同…)，而Web Server也會有一個Application Domain；而Application Domain會有一些特性，例如說，兩個Application Domain不能直接互通、執行時，以Application Domian為邊界、卸載的時候也以Application Domain為單位 ( 但是可以隨時動態載入組件 )等等。</p>
<h4>為何會提到Application Domain?</h4>
<p>其實是因為Application Domain有一個關鍵性的特點，發現了嗎?就是兩個Application Domain不能直接互通!，簡單的說，當一個Web Server收到Client的請求時，Web Server沒辦法跨Application Domain到Web應用程式的Application Domain來讓Web應用程式處理這個請求 ( 也就是說Web應用程式沒辦法得知這個Client的請求，所以也沒辦法處理，然後吐回處理過的html網頁… )。</p>
<h4>MarshalByRefObject是救星!</h4>
<p>沒錯，解決辦法就是使用MarshalByRefObject這個類別，繼承了這個類別的物件，可以讓Web Server透過他來將資料封裝起來並傳遞到Web應用程式裡面去，然後再吐回Web Server。</p>
<h4>來看看MarshalByRefObject如何寫</h4>
<pre class="brush: csharp;">using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.IO;
using System.Web.Hosting;
using System.Web;

namespace AspNetSimulator
{
    //繼承MarshalByRefObject來讓MyAspNetHost跨越兩個Application Domain 
    class MyAspNetHost:MarshalByRefObject
    {
         public void  ProcessRequest( string fileName ,ref string output)
         {
             //利用記憶體當串流。
             MemoryStream memoryStream=new MemoryStream();
             //設定輸出，來將網頁透過這個Stream送到這裡。
             StreamWriter streamWriter = new StreamWriter(memoryStream);
             //自動更新 
             streamWriter.AutoFlush = true;      
             //利用HttpWorkRequest類別，來設定要給Web應用程式的請求。
             //第一個參數是檔案名稱，第二個參數是query，第三個參數是將產生出來的html要透過哪個Stream做寫入至Memory
             HttpWorkerRequest worker = new SimpleWorkerRequest(fileName, "", streamWriter);   
             //正式派發出去執行。
             HttpRuntime.ProcessRequest(worker) ;
             //準備讀取的Stream
             StreamReader streamReader = new StreamReader(memoryStream);
             //移動指標
             memoryStream.Position = 0;
             //從頭讀到尾，並且塞到output裡面去。
             output = streamReader.ReadToEnd();
         }
    }
}
</pre>
<p>這裡要特別注意，此物件並不是用來傳遞，而是定義了這個物件以後，到時候我們的Web Server就可以來呼叫這個物件的方法，如上所示，我們就可以在Web Server這個類別使用ProcessRequest()這個方法；接下來，我們稍微解釋一下程式碼，基本上前面幾行設定串流模式，並利用記憶體當儲存體；比較需要注意的是這兩行。</p>
<pre class="brush: csharp;"> //利用HttpWorkRequest類別，來設定要給Web應用程式的請求。
 //第一個參數是檔案名稱，第二個參數是query，第三個參數是將產生出來的html要透過哪個Stream做寫入至Memory
 HttpWorkerRequest worker = new SimpleWorkerRequest(fileName, "", streamWriter);   
 //正式派發出去執行。
 HttpRuntime.ProcessRequest(worker) ;
</pre>
<p>我們利用SimpleWorkerRequest類別來產生HttpWorkerRequest這個抽象類別的實體 ( 也就是woker )，這裡有三個參數，第一個參數其實就是檔案名稱，例如Test.aspx，而第二個參數則是query，已就是檔案後面的?xxx=xxxx這種URL的query，第三個則表示未來Web應用程式產出的HTML要利用哪個串流來進行寫入，( 而這邊因為是範例，第二個參數就直接給空白)，最後再將這個實體( worker ) 送到HttpRuntime.ProcessRequest來執行，送進去後，就是Web應用程式的事情了，經過一連串的執行運算，最後會產生HTML，並且透過串流寫到記憶體，所以就可以用以下程式碼進行取出。</p>
<pre class="brush: csharp;"> //準備讀取的Stream
 StreamReader streamReader = new StreamReader(memoryStream);
 //移動指標
 memoryStream.Position = 0;
 //從頭讀到尾，並且塞到output裡面去。
 output = streamReader.ReadToEnd();
</pre>
<p>要注意的是output是利用ref的方式，也就是說，到時候Web Server會定義一個output的變數，未來這裡會直接寫回到Web Server的output變數裡面，這樣，就完成了中介的MarshalByRefObject物件。</p>
<h4>ApplicationHost.CreateApplicationHost方法</h4>
<p>開始撰寫Web Server之前，還有一個東西需要講，那就是ApplicationHost.CreateApplicationHost這個方法，CreateApplicationHost是ApplicationHost的一個靜態方法，他可以幫助我們建立Web應用程式的Application Domain；我們執行程式時，當然會先將Web Server執行起來，也會建立起Web Server的Application Domain，但是Web應用程式呢?，所以我們會在Web Server裡面去建立Web應用程式的Application Domain，而建立的方法就是使用CreateApplicationHost。</p>
<pre class="brush: csharp;">//利用CreateApplicationHost方法來建立一個ASP.NET的Application Domain，
//以便執行ASP.NET。
_myAspNetHost = (MyAspNetHost)ApplicationHost.CreateApplicationHost
    (typeof(MyAspNetHost), _virtualDir, _realDir);
</pre>
<p>如上程式碼，就是建立Web應用程式的Application Domain的寫法，他會帶三個參數，第一個是最難解釋的，先跳過，第二個參數其實就是Web應用程式的根所對應的虛擬路徑，第三個則是實體路徑；接下來我們回來講第一個參數，通常我們會把剛剛寫好的MarshalByRefObject物件放到第一個參數，並且使用typeof來取得MarshalByRefObject的Type這個型別，老實說，這塊我看了很久，最後還去翻Source來查，才知道比較細的細節，以下我們先看一下CreateApplicationHost這個程式碼。</p>
<pre class="brush: csharp;">[SecurityPermission(SecurityAction.Demand, Unrestricted=true)]
public static object CreateApplicationHost(Type hostType, string virtualDir, string physicalDir)
{
    if (Environment.OSVersion.Platform != PlatformID.Win32NT)
    {
        throw new PlatformNotSupportedException(SR.GetString("RequiresNT"));
    }
    if (!StringUtil.StringEndsWith(physicalDir, Path.DirectorySeparatorChar))
    {
        physicalDir = physicalDir + Path.DirectorySeparatorChar;
    }
    ApplicationManager applicationManager = ApplicationManager.GetApplicationManager();
    string appId = (virtualDir + physicalDir).GetHashCode().ToString("x");
    return applicationManager.CreateInstanceInNewWorkerAppDomain(hostType, appId, VirtualPath.CreateNonRelative(virtualDir), physicalDir).Unwrap();
}
</pre>
<p>上面在敘說CreateApplicationHost這個方法，我們其實可以看到，傳進來的Type型別，又傳入到CreateInstanceInNewWorkerAppDomain裡面去，所以再往下看吧。</p>
<pre class="brush: csharp;">internal ObjectHandle CreateInstanceInNewWorkerAppDomain(Type type, string appId, VirtualPath virtualPath, string physicalPath)
{
    IApplicationHost appHost = new SimpleApplicationHost(virtualPath, physicalPath);
    HostingEnvironmentParameters hostingParameters = new HostingEnvironmentParameters {
        HostingFlags = HostingEnvironmentFlags.HideFromAppManager
    };
    return this.CreateAppDomainWithHostingEnvironmentAndReportErrors(appId, appHost, hostingParameters).CreateInstance(type.AssemblyQualifiedName);
}
</pre>
<p>到這邊，直接跳到最後一行，我們可以看到type.AssmblyQualifiedName，其實這是取出type的詳細資訊，也就是MarshalByRefObject的NameSpace、版本、等等的詳細資訊；這邊如果再繼續查下去，還有非常多層，我就跳過不講了，但至少我們發現了關鍵，也就是說，這邊轉成Type是為了讓Web應用程式的Application Domain在runtime時，動態載入MarshalByRefObject這個物件，所以在runtime的時候，程式會去尋找GAC和網站底下的bin目錄，並將之載入，所以需要知道MarshalByRefObject這個物件的詳細資訊，所以使用Type來取得詳細資訊；到這邊，我們知道了CreateApplicatinHost如何使用，我們就可以開始寫Web Server了。</p>
<h4>撰寫Web Server</h4>
<p>接下來就是整段的Web Server程式碼，下面比較簡單的都註解了，基本上看一下應該都可以看得懂。</p>
<pre class="brush: csharp;">using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Net.Sockets;
using System.IO;
using System.Threading;
using System.Web;
using System.Web.Hosting;
using System.Net;

namespace AspNetSimulator
{
    class WebHandle
    {
        //繼承了MarshalByRefObject的MyAspNetHost，
        //負責處理We Server 和 Asp.net Application Domain之間的通訊
        private MyAspNetHost _myAspNetHost;
        private TcpListener _tcpListener;    //監聽用
        private FileStream _fileStream;      //利用串流處理要求。
        private string _virtualDir;
        private string _realDir;

        public WebHandle(string virtualDir, string realDir)
        {
            this._virtualDir = virtualDir;
            this._realDir = realDir;
        }

        //啟動服務
        public void StartService()
        {
            try
            {
                IPEndPoint address = new IPEndPoint(IPAddress.Loopback, 8080);
                _tcpListener = new TcpListener(address);
                //啟動監聽
                _tcpListener.Start();   
                Console.WriteLine("啟動服務...");
                //利用CreateApplicationHost方法來建立一個ASP.NET的Application Domain，
                //以便執行ASP.NET。
                _myAspNetHost = (MyAspNetHost)ApplicationHost.CreateApplicationHost
                    (typeof(MyAspNetHost), _virtualDir, _realDir);
              //啟動服務
                WebServiceStart();
            }
            catch (NullReferenceException)
            {
                Console.WriteLine("NullReferenceException throwed!");
            }
        }

        //主要服務
        public void WebServiceStart()
        {
            while (true)
            {
                //建立連線
                TcpClient tcpClient = _tcpListener.AcceptTcpClient();
                Console.WriteLine("連線建立...");
                //取得網路串流
                NetworkStream networkStream = tcpClient.GetStream();
                //設定使用UTF-8
                Encoding utf8 = Encoding.UTF8;
                byte[] request = new byte[4096];
                //讀取請求，並塞到request裡面，此方法會傳回長度。
                int length = networkStream.Read(request, 0, 4096);
                //轉換成人類能看得懂的字串。
                string requestString = utf8.GetString(request, 0, length);

                string output = "";
                //這裡是關鍵，
                //簡單的說，就是WebHandle這個Application Domain 透過 _myAspNetHost 來和
                //ASP.NET Application Domain傳遞訊息。
                //( 這裡因為是Demo，所以就直接指定為Test.aspx網頁了 )
                //而使用ref來將ASP.NET Application Domain的資料塞回這裡。
                _myAspNetHost.ProcessRequest("Test.aspx", ref output);
                //以下只是簡單的將訊息送出。
                string statusLine = "HTTP/1.1 200 OK\r\n";
                byte[] outputStatusLineBs = utf8.GetBytes(statusLine);
                byte[] outputBodyBs = utf8.GetBytes(output);
                string responseHeader = string.Format("Content-Type: text/html;charset=UTF-8\r\nContent-Length:{0}\r\n",outputBodyBs.Length);
                byte[] outputResponseHeaderBs = utf8.GetBytes(responseHeader);
                networkStream.Write(outputStatusLineBs, 0, outputStatusLineBs.Length);
                networkStream.Write(outputResponseHeaderBs, 0, outputResponseHeaderBs.Length);
                networkStream.Write(new byte[]{13,10},0,2);
                networkStream.Write(outputBodyBs, 0, outputBodyBs.Length);
                tcpClient.Close();
            }
        }
    }
}
</pre>
<p>我們會在_tcpListerer.start()後，建立Web應用程式的Application Domain，來讓Web應用程式準備運作，然後進入WebServiceStart方法，利用無窮迴圈來讓服務不中斷，而當程式讀到這行時，就會暫停，直到有請求進來，並繼續執行下去；另外WebServiceStart可以使用執行序來進行多執行序的處理，這裡是簡單的Demo，就直接這樣寫了。</p>
<pre class="brush: csharp;">TcpClient tcpClient = _tcpListener.AcceptTcpClient();
</pre>
<p>然後就進行串流的讀取，將請求的部分進行處理，如果寫的複雜一點，可能也還需去判斷要求的是哪個檔案，或是有沒有query等等的處理。( 所以沒事不要自己寫Web Server… )最後到下面這行，這邊就是透過繼承了MarshalByRefObject的物件，並呼叫此物件的方法，如上所說，經過一連串的執行，就會把html資料吐回到output裡面。</p>
<pre class="brush: csharp;">//這裡是關鍵，
//簡單的說，就是WebHandle這個Application Domain 透過 _myAspNetHost 來和
//ASP.NET Application Domain傳遞訊息。
//( 這裡因為是Demo，所以就直接指定為Test.aspx網頁了 )
//而使用ref來將ASP.NET Application Domain的資料塞回這裡。
_myAspNetHost.ProcessRequest("Test.aspx", ref output);
</pre>
<p>最後，我們去把這些資料輸出回瀏覽器，就完成了這個平常簡單的一次請求…</p>
<h4>還有一小段進入點!</h4>
<p>另外，有沒有發現上面全部都是類別，完全沒有進入點，其實我是使用了Console專案來撰寫，所以下面補上程式的進入點，於是Web Server (偽) 就完成了=w=。</p>
<pre class="brush: csharp;">using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;

namespace AspNetSimulator
{
    class ServerSimulator
    {
        static void Main(string[] args)
        {
            WebHandle webHandle = new WebHandle("/", "C:\\My\\TestWeb");
            webHandle.StartService();
        }
    }
}
</pre>
<p>寫了那麼多，其實也只是ASP.NET的開頭，也希望能讓大家對ASP.NET的一些基礎能更加瞭解!</p></div></div></div></div><footer><div>Sky & Study4.TW</div></footer></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/2011/10/06/進入ASP-NET-ASP-NET的起點/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-8a5ec9ca460de146e1b0.js"],"component---src-pages-404-js":["/component---src-pages-404-js-216c2b4f5d02a741e4f2.js"],"component---src-templates-index-js":["/component---src-templates-index-js-615d11b4d3f2aa5ff33e.js"],"component---src-templates-page-js":["/component---src-templates-page-js-e853b3cf8fae77fda562.js"],"component---src-templates-tags-js":["/component---src-templates-tags-js-4100f9b0c43c4bde8fb9.js"]};/*]]>*/</script><script src="/component---src-templates-page-js-e853b3cf8fae77fda562.js" async=""></script><script src="/23c3d3a3a2879427593569aafa02d04d4d5b9e2a-ee33f3640e06062a9ba5.js" async=""></script><script src="/commons-588a46b1342b8cdac1fc.js" async=""></script><script src="/styles-9b6f388623a2ec93d35f.js" async=""></script><script src="/app-8a5ec9ca460de146e1b0.js" async=""></script><script src="/framework-75da9754c2a76bbaf08a.js" async=""></script><script src="/webpack-runtime-5a5a97b7337a917cb0df.js" async=""></script></body></html>