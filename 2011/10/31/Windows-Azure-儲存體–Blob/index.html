<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="google-site-verification" content="iFYOZeAkjA9mpw80K_6C3Ybqm8zAmrJ3XXy5cSphRew" />










  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="ASP.NET,Azure," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description" content="在Desktop的環境裡面有硬碟可以用來儲存照片、影片、MP3等等，那Windows Azure當然也要儲存體來進行儲存啦，所以這次介紹的是Windows Azure專門用來存取大型資料的儲存體Blob(Binary Large Object)，而在談論之前，也有一個觀念要給大家，無論是Blob或是Table、Queue，其實都是存在於資料庫裏面，所以本機要模擬的時候，也必須要有資料庫才能進行測試">
<meta property="og:type" content="article">
<meta property="og:title" content="Windows Azure 儲存體–Blob">
<meta property="og:url" content="http://skychang.github.io/2011/10/31/Windows-Azure-%E5%84%B2%E5%AD%98%E9%AB%94%E2%80%93Blob/index.html">
<meta property="og:site_name" content="天空的垃圾場">
<meta property="og:description" content="在Desktop的環境裡面有硬碟可以用來儲存照片、影片、MP3等等，那Windows Azure當然也要儲存體來進行儲存啦，所以這次介紹的是Windows Azure專門用來存取大型資料的儲存體Blob(Binary Large Object)，而在談論之前，也有一個觀念要給大家，無論是Blob或是Table、Queue，其實都是存在於資料庫裏面，所以本機要模擬的時候，也必須要有資料庫才能進行測試">
<meta property="og:locale" content="zh_TW">
<meta property="og:image" content="http://lh3.ggpht.com/-BvJGgxdBrr4/Tq9qkvvpBkI/AAAAAAAAA18/1WabQSTNX_Y/image_thumb2.png?imgmax=800">
<meta property="og:image" content="http://lh6.ggpht.com/-MGUCj2NP4lU/Tq9qmFP23FI/AAAAAAAAA2M/2X_GEeeDL7A/image_thumb5.png?imgmax=800">
<meta property="og:image" content="http://lh6.ggpht.com/-6p4DsMv3V7U/Tq9qnlXwkXI/AAAAAAAAA2c/T8aqSOLCPp4/image_thumb16.png?imgmax=800">
<meta property="og:image" content="http://lh5.ggpht.com/-Jo9AJRgj0EQ/Tq9qpPp1ECI/AAAAAAAAA2o/4tzqYjMwVA0/image_thumb%25255B2%25255D.png?imgmax=800">
<meta property="og:image" content="http://lh4.ggpht.com/-Pd0cfTD09Kw/Tq9qqbWPj2I/AAAAAAAAA20/HRKa3K3ZOBI/Image.png?imgmax=800">
<meta property="og:image" content="http://lh6.ggpht.com/-EHVMjwCZWf0/Tq9qr4_PX2I/AAAAAAAAA3M/b5imFw4PBxw/image_thumb%25255B5%25255D.png?imgmax=800">
<meta property="article:published_time" content="2011-10-31T23:41:00.000Z">
<meta property="article:modified_time" content="2020-05-27T12:09:39.027Z">
<meta property="article:author" content="Sky Chang">
<meta property="article:tag" content="ASP.NET">
<meta property="article:tag" content="Azure">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://lh3.ggpht.com/-BvJGgxdBrr4/Tq9qkvvpBkI/AAAAAAAAA18/1WabQSTNX_Y/image_thumb2.png?imgmax=800">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>

  <title> Windows Azure 儲存體–Blob | 天空的垃圾場 </title>
<meta name="generator" content="Hexo 4.2.1"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-tw">

  


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-29938905-2', 'auto');
  ga('send', 'pageview');
</script>









  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">天空的垃圾場</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首頁
          </a>
        </li>
      
        
        <li class="menu-item menu-item-development">
          <a href="/development" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            開發
          </a>
        </li>
      
        
        <li class="menu-item menu-item-alm">
          <a href="/alm" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            維運
          </a>
        </li>
      
        
        <li class="menu-item menu-item-cloud">
          <a href="/cloud" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            雲端
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            歸檔
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            標籤
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                Windows Azure 儲存體–Blob
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">發表於</span>
            <time itemprop="dateCreated" datetime="2011-10-31T23:41:00+00:00" content="2011-10-31">
              2011-10-31
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2011/10/31/Windows-Azure-%E5%84%B2%E5%AD%98%E9%AB%94%E2%80%93Blob/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2011/10/31/Windows-Azure-儲存體–Blob/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>在Desktop的環境裡面有硬碟可以用來儲存照片、影片、MP3等等，那Windows Azure當然也要儲存體來進行儲存啦，所以這次介紹的是Windows Azure專門用來存取大型資料的儲存體Blob(Binary Large Object)，而在談論之前，也有一個觀念要給大家，無論是Blob或是Table、Queue，其實都是存在於資料庫裏面，所以本機要模擬的時候，也必須要有資料庫才能進行測試喔!</p>
<h4 id="Blob架構"><a href="#Blob架構" class="headerlink" title="Blob架構"></a>Blob架構</h4><p>既然Blob是儲存在雲端上，就必須符合雲端的特性，所以架構必定和本機上有所不同，以下是Blob的結構圖，我們可以看到，基本上會分成三層，Account(帳號)、Container(容器)、Blob；畢竟網路那麼多使用者，所以一定是用Account來做區分，而一個Account會有非常多的Container，這些Container是可以自己去自訂的，Container的目的其實就像是利用群組的方式，來設定存取的權限，而Container裡面會有許多Blob，基本上就如下圖。( 其實Container也是物件，官方網站也稱Container為Blob Container )，此外，除了下圖外，Container和Blob還擁有Metadata可以進行描述。</p>
<p><a href="http://lh4.ggpht.com/-mGrWbX9bn7o/Tq9qj8WFTDI/AAAAAAAAA10/SAjCv6gVPCo/s1600-h/image4.png" target="_blank" rel="noopener"><img src="http://lh3.ggpht.com/-BvJGgxdBrr4/Tq9qkvvpBkI/AAAAAAAAA18/1WabQSTNX_Y/image_thumb2.png?imgmax=800" alt="image" title="image"></a></p>
<h5 id="Storage-Account"><a href="#Storage-Account" class="headerlink" title="Storage Account"></a>Storage Account</h5><ul>
<li>所有的Blob是透過此帳號進行存取。  <li>他是整個架構的起點。  <li>一個帳號可以有非常多的Container。 </li>
</ul>
<h5 id="Blog-Container"><a href="#Blog-Container" class="headerlink" title="Blog Container"></a>Blog Container</h5><ul>
<li>此Container必須在Account內，且此Container幫Blob分了群組。  <li>共享權限的等級，是設在Container裡面，目前支援Public Read和Private，當此權限為Public Read時，任何人都可以進行讀取，而不需要驗證，只有驗證過的對應使用者能進行存取。  <li>容器也有Metadata，大小為8k，是一組&lt;name,value&gt;的形式。  <li>Blob Containet擁有可以列出所有Blob的方法，所以可以很輕鬆地去做存取。 </li>
</ul>
<p>Blob</p>
<ul>
<li>Blob儲存在Container裡面，而且每個Blob最高可儲存50G!  <li>每個在Container裡面的Blob都有一個獨一無二的字串名稱。  <li>Blob也擁有Metadata可以設定，一樣是8k，也是一組&lt;name,value&gt;的形式。 </li>
</ul>
<p>最後，如上圖，因為是雲端儲存體，所以如果我們要取得Blob，可想而知，就一定是使用url來當作識別的位置啦!如下。</p>
<p>http://&lt;account&gt;.blob.core.windows.net/&lt;container&gt;/&lt;blobname&gt;</p>
<h4 id="來寫程式吧"><a href="#來寫程式吧" class="headerlink" title="來寫程式吧!"></a>來寫程式吧!</h4><p>接下來，我們就來撰寫程式看看吧，我相信大家應該也沒有那麼多的錢可以租用Windows Azure服務，老實說，小弟我也沒那麼多錢，所以我的範例都是在本機上面做測試。</p>
<p>首先，要寫Windows Azure，必須先裝SDK，如果還沒裝的可以<a href="http://blog.sanc.idv.tw/2011/09/windows-azure.html" target="_blank" rel="noopener">參考這篇</a>。接下來就在Visual Studio裡面選擇Windows Azure專案。</p>
<p><a href="http://lh6.ggpht.com/-NkTumZKYiYI/Tq9qlbg9nuI/AAAAAAAAA2E/HHd1UuCFAOo/s1600-h/image9.png" target="_blank" rel="noopener"><img src="http://lh6.ggpht.com/-MGUCj2NP4lU/Tq9qmFP23FI/AAAAAAAAA2M/2X_GEeeDL7A/image_thumb5.png?imgmax=800" alt="image" title="image"></a></p>
<p>到這邊，就可以選擇Web Role，但小弟我不喜歡在這邊選擇，會利用後續再增加的做法，有興趣的可以<a href="http://blog.sanc.idv.tw/2011/10/windows-azure-web-role.html" target="_blank" rel="noopener">參考這篇</a>，如果只想要簡單Demo，也可以直接在這邊選擇ASP.NET Web Role ( 中文翻角色 )。</p>
<p><a href="http://lh6.ggpht.com/-Z70xZb2oW8Q/Tq9qm_Xvw0I/AAAAAAAAA2Q/6uEXldenDIg/s1600-h/image30.png" target="_blank" rel="noopener"><img src="http://lh6.ggpht.com/-6p4DsMv3V7U/Tq9qnlXwkXI/AAAAAAAAA2c/T8aqSOLCPp4/image_thumb16.png?imgmax=800" alt="image" title="image"></a></p>
<p>接下來，我們先來看看最後寫完的範例程式執行起來的樣子吧；基本上就是長這樣，這隻程式的主要功能是可以上傳照片，並且可以刪除照片，如果有照片的話，可以從DropDownList可以看到檔名，並且於無資料那邊那個區塊，顯示所有雲端上的照片，這個範例也是Ruddy老師所說的，最經典且簡單的Blob範例，所以小弟我也造樣畫葫蘆，寫了此程式，並用此程式和大家解說。</p>
<p><a href="http://lh6.ggpht.com/-w-KJp4rZyTY/Tq9qoXOFwuI/AAAAAAAAA2k/FANP4rZY4rM/s1600-h/image%25255B5%25255D.png" target="_blank" rel="noopener"><img src="http://lh5.ggpht.com/-Jo9AJRgj0EQ/Tq9qpPp1ECI/AAAAAAAAA2o/4tzqYjMwVA0/image_thumb%25255B2%25255D.png?imgmax=800" alt="image" title="image"></a></p>
<p>首先我們先來看看HTML這邊的程式碼，基本就是很基本的ASP.NET。</p>
<pre class="brush: xml;">&lt;%@ Page Language="C#" AutoEventWireup="true" CodeBehind="BlobTest.aspx.cs" Inherits="WebRole1.BlobTest" %&gt;

&lt;!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"&gt;

&lt;html xmlns="http://www.w3.org/1999/xhtml"&gt;
&lt;head id="Head1" runat="server"&gt;
    &lt;title&gt;&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;form id="form1" runat="server"&gt;
    &lt;div&gt;

        &lt;asp:FileUpload ID="uploadImage" runat=server /&gt;
        &lt;asp:Button ID="uploadBtn" runat="server" Text="上傳" onclick="uploadBtn_Click" /&gt;

        &lt;asp:DropDownList ID="imageList" runat="server" AutoPostBack="true"&gt;&lt;/asp:DropDownList&gt;
        &lt;asp:Button ID="delBtn" runat="server" Text="刪除" onclick="delBtn_Click" /&gt;

        &lt;asp:ListView ID="imageView" runat="server"&gt;
            &lt;LayoutTemplate&gt;
                &lt;asp:PlaceHolder ID="itemPlaceHolder" runat="server" /&gt;
            &lt;/LayoutTemplate&gt;
            &lt;EmptyDataTemplate&gt;
                &lt;h2&gt;無資料&lt;/h2&gt;
            &lt;/EmptyDataTemplate&gt;
            &lt;ItemTemplate&gt;
                &lt;!--
                Eval：Eval是用於單向資料繫結，資料是唯讀的顯示。
                Bind：Bind則是雙向的資料繫當，不但能讀取資料，
                更具有Insert、Update、Delete功能，所以若您需要編輯更新、新增與刪除功能使用本方法。
                語法如下。
                --&gt;
                &lt;img src="&lt;%# Eval("Uri") %&gt;" alt="&lt;%# Eval("Uri") %&gt;" style="float:left" /&gt;
            &lt;/ItemTemplate&gt;
        &lt;/asp:ListView&gt;
    &lt;/div&gt;
    &lt;/form&gt;
&lt;/body&gt;
&lt;/html&gt;
</pre>

<p>為了大家方便，我也做了一張對應圖給大家看。</p>
<p><a href="http://lh5.ggpht.com/-Pbbsg6xu6W4/Tq9qp8WuvUI/AAAAAAAAA2w/THxHlGdG-X8/s1600-h/Image.png" target="_blank" rel="noopener"><img src="http://lh4.ggpht.com/-Pd0cfTD09Kw/Tq9qqbWPj2I/AAAAAAAAA20/HRKa3K3ZOBI/Image.png?imgmax=800" alt="圖片 1" title="圖片 1"></a></p>
<p>接下來，我們開始撰寫這個BlobTest.aspx.cs吧( 此ASP.NET的程式名稱為BlobTest.aspx )，首先，既然要存取雲端的Blob，我們當然要先準備一下，存取的方法；首先，我們定義一個GetContainer的方法，來取得CloudBlobContainer，這樣後續就可以利用此方法來取得Container底下的Blob了；就如前面說的，任何的Container都是在Account之下，所以我們第一步，就是先取得Account，因為我們是在本機上模擬與測試，所以我們可以使用CloudStorageAccount這個靜態類別的DevelopmentStorageAccount這個靜態方法來取得開發用的Account；有了Account，就可以利用Account來取得Client來進行後續的處理，最後，我們就可以利用Client來取得Container ( 這個Container的名稱就是myContainer )；到這邊還滿容易理解的，但是有人可能會有疑問，明明沒看到建立mycontainer這個Container的程式碼阿?沒錯，如果第一次執行的時候，到這邊的確還沒有在資料庫裡建立起mycontainer這個Container，我們只是利用client的GetContainerReference(“mycontainer”)這個方法來取得CloudBlobContainer這個物件，並且設定CloudBlobContainer裡面的Name屬性為mycontainer，後續我們才會於資料庫建立Container。</p>
<pre class="brush: csharp;">//取得Container
private CloudBlobContainer GetContainer()
{
    //取得Developer用的Storage Account。
    CloudStorageAccount account = CloudStorageAccount.DevelopmentStorageAccount;
    //取得Storage的Client
    CloudBlobClient client = account.CreateCloudBlobClient();
    //取得Container關聯。
    return client.GetContainerReference("mycontainer");
}
</pre>

<p>有了取得Container這個方法，接下來，我們就來實際撰寫建立容器的方法，第一行滿簡單的，就是取回CloudBlobContainer這個容器，而第二行，我們就利用取得回來的CloudBlobContainer物件來建立一個Container，CreateIfNotExist()，這個方法很好玩，如果目前資料庫裡面已經有了名為mycontainer的這個容器，他就不會再建立了，如果沒有，就會在資料庫裏面建立一個。</p>
<pre class="brush: csharp;">//建立容器
private void CreateContainerExists()
{
    CloudBlobContainer container = this.GetContainer();
    //假如沒有這個Container，就建立一個。
    container.CreateIfNotExist();
}
</pre>

<p>我們可以看到，如果程式執行到這邊，就會建立了一個mycontainer這個container。</p>
<p>( 這是一個很好用的Azure Storage 瀏覽工具 )</p>
<p><a href="http://lh4.ggpht.com/-qpnLIDCvteI/Tq9qq5vdh1I/AAAAAAAAA3E/BA1IZSGmCcQ/s1600-h/image%25255B10%25255D.png" target="_blank" rel="noopener"><img src="http://lh6.ggpht.com/-EHVMjwCZWf0/Tq9qr4_PX2I/AAAAAAAAA3M/b5imFw4PBxw/image_thumb%25255B5%25255D.png?imgmax=800" alt="image" title="image"></a></p>
<p>完成了存取後，我們來處理一下刷新Image這個方法，這個方法的用處是，當有上傳，或是刪除動作的時候，可以呼叫這個方法來重新刷新頁面上的控制項，詳細可以看程式碼的註解。</p>
<pre class="brush: csharp;">//刷新Image
private void RefreshImage()
{
    //ListBlobs可以取回此Container所有的Blobs，而後面可以傳入BlobRequestOptions這個物件，
    //這個物件可以設定，傳回來的條件。
    //這邊條件設定的第一個是列出所有的Blob(UseFlatBlobListing = true)
    //並且抓取所有的Blob對象 ( BlobListingDetails = BlobListingDetails.All )
    imageView.DataSource = this.GetContainer().ListBlobs(new BlobRequestOptions() { UseFlatBlobListing = true, BlobListingDetails = BlobListingDetails.All });
    imageView.DataBind();
    //每次刷新時，也清除DropDownList內的資訊。
    imageList.Items.Clear();
    var blobList = this.GetContainer().ListBlobs();
    foreach (var item in blobList)
    {
        //每個Blob都有一個Uri屬性，這裡是取得Blob的檔案名稱。
        imageList.Items.Add(item.Uri.Segments[3].ToString());
    }

    //dropDownListItem其實是紀錄目前dropDownList選了哪一個item。
    //這個變數是此類別的屬性，最後整體程式碼的時候會看到。
    imageList.SelectedIndex = dropDownListItem;

}
</pre>

<p>接下來，我們來撰寫存Image這個方法，這個方法會帶四個參數進來，第一個會傳入id，後續我們會利用Guid.NewGuid.ToString()來產生id，而第二個會傳入檔案名稱，第三個會傳入檔案的型態( image/jpeg )，第四個則是圖片binary的資料；程式碼的第一行，會使用GetBlobReference來取得Blob物件，這個方法和之前的GetContainerReference一樣，並不會馬上寫到資料庫，指示先將Blob物件準備好，後面的部分，就只是很簡單的設定檔案型態、定義MetaData，最後使用UploadByteArrary將資料寫到資料庫。</p>
<pre class="brush: csharp;">//存Image
private void SaveImage(string id, string fileName, string contentType, byte[] data)
{
    //利用GetBlobReference來取得Blob，第一個參數會帶進檔案名稱，
    //而此檔案名稱會化成Uri的一部分。
    CloudBlob blob = this.GetContainer().GetBlobReference(fileName);
    //檔案型態
    blob.Properties.ContentType = contentType;

    //定義MetaData
    NameValueCollection metadata = new NameValueCollection();
    metadata["Id"] = id;
    metadata["Filename"] = fileName;

    blob.Metadata.Add(metadata);
    blob.UploadByteArray(data);
}
</pre>

<p>最後我們要處理的就是刪除，刪除的原理很簡單，利用DropDownList所選取到的檔名去和娶回來的BlobList來比對，如果相同，就將此Blob移除。</p>
<pre class="brush: csharp;">//刪除
protected void delBtn_Click(object sender, EventArgs e)
{
    if (this.GetContainer() == null) return;

    var blobList = this.GetContainer().ListBlobs();
    foreach (var item in blobList)
    {
        string deleteImage = item.Uri.Segments[3].ToString();
        //判斷DropDownList所選擇的item名稱和Blob名稱是否相同，
        //相同就刪除。
        if (deleteImage == imageList.SelectedValue)
        {
            //利用GetBlobReference來取得Blob
            CloudBlob blob = this.GetContainer().GetBlobReference(item.Uri.ToString());
            blob.DeleteIfExists();

            //刪除完後刷新一下。
            RefreshImage();
            return;
        }
    }
}
</pre>

<p>最後附上完整的程式碼。</p>
<pre class="brush: csharp;">using System;
using System.Collections.Generic;
using System.Linq;
using System.Web;
using System.Web.UI;
using System.Web.UI.WebControls;

using System.Net;
using System.Collections.Specialized;
using System.Configuration;

using Microsoft.WindowsAzure;
using Microsoft.WindowsAzure.StorageClient;
using Microsoft.WindowsAzure.ServiceRuntime;

namespace WebRole1
{
    public partial class BlobTest : System.Web.UI.Page
    {
        int dropDownListItem = 0;
        protected void Page_Load(object sender, EventArgs e)
        {
            if (!IsPostBack)
            {
                //First
                this.CreateContainerExists();
                dropDownListItem = imageList.SelectedIndex;
                this.RefreshImage();
            }
            else
            {
                dropDownListItem = imageList.SelectedIndex;
                this.RefreshImage();
            }
        }

        //上傳
        protected void uploadBtn_Click(object sender, EventArgs e)
        {
            if (uploadImage.HasFile)
            {
                //SaveImage(string id, string fileName, string contentType, byte[] data)
                this.SaveImage(Guid.NewGuid().ToString(), uploadImage.FileName, uploadImage.PostedFile.ContentType, uploadImage.FileBytes);
                RefreshImage();
            }
        }

        //取得Container
        private CloudBlobContainer GetContainer()
        {
            //取得Developer用的Storage Account。
            CloudStorageAccount account = CloudStorageAccount.DevelopmentStorageAccount;
            //取得各種Storage的Client
            CloudBlobClient client = account.CreateCloudBlobClient();
            //取得Container。
            return client.GetContainerReference("mycontainer");
        }

        //確保容器存在
        private void CreateContainerExists()
        {
            CloudBlobContainer container = this.GetContainer();
            //假如沒有這個Container，就建立一個。
            container.CreateIfNotExist();
        }

        //刷新Image
        private void RefreshImage()
        {
            //ListBlobs可以取回此Container所有的Blobs，而後面可以傳入BlobRequestOptions這個物件，
            //這個物件可以設定，傳回來的條件。
            //這邊條件設定的第一個是列出所有的Blob(UseFlatBlobListing = true)
            //並且抓取所有的Blob對象 ( BlobListingDetails = BlobListingDetails.All )
            imageView.DataSource = this.GetContainer().ListBlobs(new BlobRequestOptions() { UseFlatBlobListing = true, BlobListingDetails = BlobListingDetails.All });
            imageView.DataBind();
            //每次刷新時，也清除DropDownList內的資訊。
            imageList.Items.Clear();
            var blobList = this.GetContainer().ListBlobs();
            foreach (var item in blobList)
            {
                //每個Blob都有一個Uri屬性，這裡是取得Blob的檔案名稱。
                imageList.Items.Add(item.Uri.Segments[3].ToString());
            }

            //dropDownListItem其實是紀錄目前dropDownList選了哪一個item。
            //這個變數是此類別的屬性，最後整體程式碼的時候會看到。
            imageList.SelectedIndex = dropDownListItem;

        }

        //存取Image
        private void SaveImage(string id, string fileName, string contentType, byte[] data)
        {
            //利用GetBlobReference來取得Blob，第一個參數會帶進檔案名稱，
            //而此檔案名稱會化成Uri的一部分。
            CloudBlob blob = this.GetContainer().GetBlobReference(fileName);
            //檔案型態
            blob.Properties.ContentType = contentType;

            //定義MetaData
            NameValueCollection metadata = new NameValueCollection();
            metadata["Id"] = id;
            metadata["Filename"] = fileName;

            blob.Metadata.Add(metadata);
            blob.UploadByteArray(data);
        }

        //刪除
        protected void delBtn_Click(object sender, EventArgs e)
        {
            if (this.GetContainer() == null) return;

            var blobList = this.GetContainer().ListBlobs();
            foreach (var item in blobList)
            {
                string deleteImage = item.Uri.Segments[3].ToString();
                //判斷DropDownList所選擇的item名稱和Blob名稱是否相同，
                //相同就刪除。
                if (deleteImage == imageList.SelectedValue)
                {
                    //利用GetBlobReference來取得Blob
                    CloudBlob blob = this.GetContainer().GetBlobReference(item.Uri.ToString());
                    blob.DeleteIfExists();

                    //刪除完後刷新一下。
                    RefreshImage();
                    return;
                }
            }
        }
    }
}
</pre>

<p>其實，這就是Blob的範例應用，雖然看起來程式碼很長，但其實還滿簡單的。</p>
<h4 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h4><ul>
<li><a href="http://www.microsoft.com/windowsazure/Whitepapers/BlobStorage/" target="_blank" rel="noopener" title="http://www.microsoft.com/windowsazure/Whitepapers/BlobStorage/">http://www.microsoft.com/windowsazure/Whitepapers/BlobStorage/</a></li>
</ul>

      
    </div>

    <div>
      
        
      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/ASP-NET/" rel="tag">#ASP.NET</a>
          
            <a href="/tags/Azure/" rel="tag">#Azure</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2011/10/31/Windows-Azure-%E6%96%B0%E5%A2%9E%E7%A9%BA%E7%99%BDWeb-Role%E7%9A%84%E4%BD%9C%E6%B3%95/" rel="next" title="Windows Azure 新增空白Web Role的作法">
                <i class="fa fa-chevron-left"></i> Windows Azure 新增空白Web Role的作法
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2011/11/01/Windows-Azure-%E5%84%B2%E5%AD%98%E9%AB%94%E2%80%93Table/" rel="prev" title="Windows Azure 儲存體–Table">
                Windows Azure 儲存體–Table <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="//disqus.com/?ref_noscript" target="_blank" rel="noopener">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目錄
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            本站概覽
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="Sky Chang" />
          <p class="site-author-name" itemprop="name">Sky Chang</p>
          <p class="site-description motion-element" itemprop="description">雖然是垃圾場，但還是有許多好東西</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">354</span>
              <span class="site-state-item-name">文章</span>
            </a>
          </div>

          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">108</span>
                <span class="site-state-item-name">標籤</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-4"><a class="nav-link" href="#Blob架構"><span class="nav-number">1.</span> <span class="nav-text">Blob架構</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Storage-Account"><span class="nav-number">1.1.</span> <span class="nav-text">Storage Account</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Blog-Container"><span class="nav-number">1.2.</span> <span class="nav-text">Blog Container</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#來寫程式吧"><span class="nav-number">2.</span> <span class="nav-text">來寫程式吧!</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#參考資料"><span class="nav-number">3.</span> <span class="nav-text">參考資料</span></a></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Sky Chang</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io" target="_blank" rel="noopener">Hexo</a> 強力驅動
</div>

<div class="theme-info">
  主題 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next" target="_blank" rel="noopener">
    NexT.Mist
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  



  

    <script type="text/javascript">
      var disqus_shortname = 'skychang';
      var disqus_identifier = '2011/10/31/Windows-Azure-儲存體–Blob/';
      var disqus_title = 'Windows Azure 儲存體–Blob';
      var disqus_url = 'http://skychang.github.io/2011/10/31/Windows-Azure-%E5%84%B2%E5%AD%98%E9%AB%94%E2%80%93Blob/';

      function run_disqus_script(disqus_script){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }

      run_disqus_script('count.js');
      
        run_disqus_script('embed.js');
      
    </script>
  



  
  
  

  

  

</body>
</html>
