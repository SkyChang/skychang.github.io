{"componentChunkName":"component---src-templates-page-js","path":"/2014/08/21/Entity-Framework-為什麼修改的資料不用Attach/","result":{"data":{"markdownRemark":{"frontmatter":{"title":"Entity Framework -  為什麼修改的資料不用Attach","date":"21 August 2014","author":"Sky Chang","excerpt":null,"tags":["ASP.NET MVC","Entity Framework"],"coverImage":null},"id":"38bb7698-fd58-5348-82f7-43dacb0d62ff","html":"<p>這幾天在上MVC的課程，有一個同學問到一個很不錯的問題，這個問題大致上是這樣的.</p>\n<blockquote>\n<p>為什麼ASP.NET MVC的範例，修改資料的時候，不需要Attach?? </p>\n</blockquote>\n<p>程式碼在下面</p>\n<pre class=\"brush: csharp;\">[HttpPost]\n[ValidateAntiForgeryToken]\npublic ActionResult Edit([Bind(Include = \"Id,FirstName,LastName\")] Emp emp)\n{\n    if (ModelState.IsValid)\n    {\n        db.Entry(emp).State = EntityState.Modified;\n        db.SaveChanges();\n        return RedirectToAction(\"Index\");\n    }\nreturn View(emp);\n}\n</pre>\n<p>其實這個問題，很久以前有研究過，但後來並沒有寫到Blog上，所以也忘記了…而基本上，上面的程式碼，是從ASP.NET MVC範本出來的，大家可以看到，只要Emp這個物件傳進來之後，並且把Emp塞到db.Entty()裡面，在改State成Modified後，就可以了。完全不用Attach!!</p>\n<p>但是不用Attach，DBContext怎麼會知道我們要更新甚麼東西呢??</p>\n<p>其實我們去看MSDN的<a href=\"http://msdn.microsoft.com/en-us/data/jj592676.aspx\">文件</a>，官方也這樣寫的；如果你有一個Entity，並且你已經知道它存在於資料庫，但這個Entity裡面的東西已經被改變，那你可以告訴DBContext要Attach，並且將狀態設為Modified!!，如下程式碼。</p>\n<pre class=\"brush: csharp;\">var existingBlog = new Blog { BlogId = 1, Name = \"ADO.NET Blog\" }; \n\nusing (var context = new BloggingContext()) \n{ \n    context.Entry(existingBlog).State = EntityState.Modified; \n\n    // Do some more work...  \n\n    context.SaveChanges(); \n}\n</pre>\n<p>等等，我們還是沒看到Attach阿!!?…</p>\n<p>理論上應該如這篇文章的<a href=\"http://stackoverflow.com/questions/15336248/entity-framework-5-updating-a-record\">內容</a>一樣，是這樣這寫吧??..我們應該先Attach這個物件，然後再把State改為Modified…那為什麼上面的範例不用??</p>\n<pre class=\"brush: csharp;\">db.Users.Attach(updatedUser);\ndb.Entry(updatedUser).State = EntityState.Modified;\ndb.SaveChanges();\n</pre>\n<p>其實原因很簡單，那是因為背後他幫我們自動Attach了，所以我們就可以不用Attach了…</p>\n<p>那是在db.Entry()這個方法裡面進行Attach的嗎??…</p>\n<p>錯…我們可以看到下圖；當我們執行完db.Entry()後，根本就還沒開始追蹤，甚至現有物件和原始物件都還是沒東西的狀況…</p>\n<p><a href=\"http://lh5.ggpht.com/-5_rwOgsF6MI/U_Wbk8eEPMI/AAAAAAAAJrw/7zYPLj69gPQ/s1600-h/image%25255B7%25255D.png\"><img src=\"http://lh5.ggpht.com/-BuGyo3JXkgc/U_Wbl5JUKcI/AAAAAAAAJr4/1aZcZbuYrsc/image_thumb%25255B3%25255D.png?imgmax=800\" alt=\"image\" title=\"image\"></a></p>\n<p>那到底在哪邊?</p>\n<p><font face=\"Courier New\">答案就在這一行，真正會自動幫忙Attach的地點其實是在設定State的這個地方…</font></p>\n<pre class=\"brush: csharp;\">dbEntry.State = EntityState.Modified;\n</pre>\n<p><font face=\"Courier New\">其實我們反組譯看看，就可以看到如下圖。</font></p>\n<p><a href=\"http://lh3.ggpht.com/-rSaEU_lHexc/U_WbnEeVX1I/AAAAAAAAJsA/hG6awwANN-4/s1600-h/image%25255B12%25255D.png\"><img src=\"http://lh5.ggpht.com/-F1Ey26RT494/U_WboL7TNGI/AAAAAAAAJsI/l-84RLLaYDw/image_thumb%25255B6%25255D.png?imgmax=800\" alt=\"image\" title=\"image\"></a></p>\n<p>是的，其實在我們設定State的時候，會用到set，所以真正的自動執行Attach的地方，就是這裡… ( 老實說，真的意想不到阿= =|| )</p>\n<p>也因此，我們也不用多寫Attach，只要變更State的時候，他就會自動幫我們Attach去上，並開始追蹤了~~</p>\n<p>參考資料</p>\n<ul>\n<li><a href=\"http://stackoverflow.com/questions/15336248/entity-framework-5-updating-a-record\" title=\"http://stackoverflow.com/questions/15336248/entity-framework-5-updating-a-record\">http://stackoverflow.com/questions/15336248/entity-framework-5-updating-a-record</a></li>\n<li><a href=\"http://msdn.microsoft.com/en-us/data/jj592676.aspx\" title=\"http://msdn.microsoft.com/en-us/data/jj592676.aspx\">http://msdn.microsoft.com/en-us/data/jj592676.aspx</a></li>\n<li><a href=\"http://stackoverflow.com/questions/15045763/what-does-the-dbcontext-entry-do\" title=\"http://stackoverflow.com/questions/15045763/what-does-the-dbcontext-entry-do\">http://stackoverflow.com/questions/15045763/what-does-the-dbcontext-entry-do</a></li>\n<li><a href=\"http://stackoverflow.com/questions/11709266/what-exactly-does-attach-do-in-entity-framework\" title=\"http://stackoverflow.com/questions/11709266/what-exactly-does-attach-do-in-entity-framework\">http://stackoverflow.com/questions/11709266/what-exactly-does-attach-do-in-entity-framework</a></li>\n<li>*</li>\n</ul>","excerpt":"這幾天在上MVC的課程，有一個同學問到一個很不錯的問題，這個問題大致上是這樣的. 為什麼ASP.NET MVC的範例，修改資料的時候，不需要Attach??  程式碼在下面 其實這個問題，很久以前有研究過，但後來並沒有寫到Blog…"}},"pageContext":{"type":"posts","next":{"frontmatter":{"path":null,"title":"ASP.NET MVC -  使用Web Deploy佈署MVC應用程式到IIS","tags":["ASP.NET","ASP.NET MVC","IIS"]},"fields":{"slug":"/2014/08/07/ASP-NET-MVC-使用Web-Deploy佈署MVC應用程式到IIS/"},"fileAbsolutePath":"/home/runner/work/blog.sanc.idv.tw/blog.sanc.idv.tw/src/posts/blog.sanc.idv.tw/ASP-NET-MVC-使用Web-Deploy佈署MVC應用程式到IIS.md"},"previous":{"frontmatter":{"path":null,"title":"Azure - Redis Cache","tags":["ASP.NET MVC","Azure","Redis"]},"fields":{"slug":"/2014/08/24/Azure-Redis-Cache/"},"fileAbsolutePath":"/home/runner/work/blog.sanc.idv.tw/blog.sanc.idv.tw/src/posts/blog.sanc.idv.tw/Azure-Redis-Cache.md"}}}}