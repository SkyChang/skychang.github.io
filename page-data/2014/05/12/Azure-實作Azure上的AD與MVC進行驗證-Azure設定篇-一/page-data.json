{"componentChunkName":"component---src-templates-page-js","path":"/2014/05/12/Azure-實作Azure上的AD與MVC進行驗證-Azure設定篇-一/","result":{"data":{"markdownRemark":{"frontmatter":{"title":"Azure - 實作Azure上的AD與MVC進行驗證 - Azure設定篇 ( 一 )","date":"12 May 2014","author":"Sky Chang","excerpt":null,"tags":["Active Directory","ASP.NET MVC","Azure","Entity Framework"],"coverImage":null},"id":"df3beda8-42d0-52e8-a406-1e8036629004","html":"<p>隔離上次寫文章，竟然整整的拖超過一個月( 連Windows Azure都改名為Microsoft Azure了…)…實在是因為這段時間整個忙到翻掉，上班趕Code…下班查資料…最慘的是，下周起還要進行待在公司的瘋狂加班…來進行衝刺… ( 這大概是我們公司成立以來，第一次破例這樣子了…還好公司方面也覺得Developer很辛苦，所以不會用補修打發我們，而是使用加班費的方式~… ) 但不管怎樣… 還是不想加班阿QQ…</p>\n<p>好吧，前面發了一些牢騷後，我們就再偉大的母親節這天，來繼續看一下Microsoft Azure上AD與MVC如何進行整合。</p>\n<p>另外，因為整個過程很長，所以會分成好幾篇文章來撰寫…</p>\n<p>首先，我們先進入Azure管理介面，然後選擇要使用的AD。</p>\n<p><a href=\"http://lh5.ggpht.com/-2ttGBEbzfQ8/U2-pqehU-sI/AAAAAAAAI0o/z4liV6v3BjU/s1600-h/image%25255B4%25255D.png\"><img src=\"http://lh4.ggpht.com/-8koqqwy4gWw/U2-prbhLlTI/AAAAAAAAI0w/wwKMBBOMU4M/image_thumb%25255B2%25255D.png?imgmax=800\" alt=\"image\" title=\"image\"></a></p>\n<p>接下來，選擇應用程式，並且選擇加入。</p>\n<p><a href=\"http://lh5.ggpht.com/-ruicQ7TD7mE/U2-psJ7ptyI/AAAAAAAAI04/FLzzfsC9cMM/s1600-h/image%25255B9%25255D.png\"><img src=\"http://lh5.ggpht.com/-DqEinQEs19k/U2-ptETdWII/AAAAAAAAI08/xtQ-HgUoL2k/image_thumb%25255B5%25255D.png?imgmax=800\" alt=\"image\" title=\"image\"></a></p>\n<p>因為我們是要讓自己寫的應用程式可以通過AD驗證，所以要選擇\"加入我的組織正在開發的應用程式\"，如果要使用第三方應用程式來搭配Azure AD，那就要選擇\"從組件庫中新增應用程式\"。</p>\n<p><a href=\"http://lh3.ggpht.com/-Kmyxq4XECmo/U2-ptm_VaDI/AAAAAAAAI1E/__tTCMhmjnI/s1600-h/image%25255B15%25255D.png\"><img src=\"http://lh5.ggpht.com/-ZmF3YpKY-9c/U2-pumy3YyI/AAAAAAAAI1Q/qrLXNKLPCnw/image_thumb%25255B9%25255D.png?imgmax=800\" alt=\"image\" title=\"image\"></a></p>\n<p>接下來，我們要給一下名稱；因為我們是要開發Web應用程式，所以自然就是選擇\"Web應用程式和/或WEB API\"</p>\n<p><a href=\"http://lh6.ggpht.com/-yYYKNUfuvek/U2-pvY_BaVI/AAAAAAAAI1Y/RAEFkoDrx2Q/s1600-h/image%25255B19%25255D.png\"><img src=\"http://lh5.ggpht.com/-aBl6GC6mBd0/U2-pv-JqpNI/AAAAAAAAI1g/Z8UffkAfTtw/image_thumb%25255B11%25255D.png?imgmax=800\" alt=\"image\" title=\"image\"></a></p>\n<p>接下來，要填一下登入的URL和應用程式識別碼URI，基本上就是你應用程式的網址，而URI則是網址格式的一段字串，通常都是[<a href=\"https://%5BAD%E5%90%8D%E7%A8%B1%5D(https://%5BAD)%5D/%5B%E6%87%89%E7%94%A8%E7%A8%8B%E5%BC%8F%E5%90%8D%E7%A8%B1%5D%E3%80%82\">https://[AD名稱](https://[AD)]/[應用程式名稱]。</a></p>\n<p><a href=\"http://lh5.ggpht.com/-Pc46Ae8bIIs/VAXhltylKUI/AAAAAAAAJz4/odwvsaWJYmA/s1600-h/image%25255B4%25255D.png\"><img src=\"http://lh4.ggpht.com/-m-_viFAwqcI/VAXhmyG_z9I/AAAAAAAAJ0A/mTrueztxhhE/image_thumb%25255B1%25255D.png?imgmax=800\" alt=\"image\" title=\"image\"></a></p>\n<p>完成之後，還有很多工作要設定，首先，第一個要注意到的是用戶識別碼，這個地方；這個其實也等同於ID，下一篇會用到，所以要特別留意一下。接下來，金鑰的地方，記得去選擇一年或是兩年，並且儲存之後，就會出現金鑰，這個也會在第二篇的時候用到，這也就是所謂的Key ( PW )。</p>\n<p><a href=\"http://lh5.ggpht.com/-CSlkgMn556A/VAXhob1iaeI/AAAAAAAAJ0I/vIKyOncmID0/s1600-h/image%25255B9%25255D.png\"><img src=\"http://lh5.ggpht.com/-QaFtMs1ckUU/VAXhp8xQfSI/AAAAAAAAJ0Q/TYASWOQNGBc/image_thumb%25255B4%25255D.png?imgmax=800\" alt=\"image\" title=\"image\"></a></p>\n<p>接下來，最底下，要設定應用程式權限為Read Directory Data，這樣我們才讀的到資料。</p>\n<p><a href=\"http://lh3.ggpht.com/-t0b1ttN1WRo/VAXhrJp5YXI/AAAAAAAAJ0Y/dqbB4kY_uH0/s1600-h/image%25255B14%25255D.png\"><img src=\"http://lh3.ggpht.com/-LSe5pkLWJh0/VAXhsXyUYkI/AAAAAAAAJ0g/19jtNyMSPtg/image_thumb%25255B7%25255D.png?imgmax=800\" alt=\"image\" title=\"image\"></a></p>\n<p>到這邊為止，就算是Azure設定完成了。</p>\n<p>完成之後，我們就要開始進行MVC的開發…這邊我們要玩就玩大一點，所以就選擇全空的專案…</p>\n<p><a href=\"http://lh6.ggpht.com/-13QpGvOGnVU/U2-pyHqCm8I/AAAAAAAAI14/Ww_xN5jaBt4/s1600-h/image%25255B28%25255D.png\"><img src=\"http://lh5.ggpht.com/-t6cKccnJDy8/U2-pzO0Z3TI/AAAAAAAAI2A/wM54DHMslsA/image_thumb%25255B16%25255D.png?imgmax=800\" alt=\"image\" title=\"image\"></a></p>\n<p>之後，我們要用NuGet進行安裝，基本上，要安裝的有這些套件</p>\n<ol>\n<li>System.IdentityModel.Tokens.ValidatingIssuerNameRegistry  <li>Microsoft.IdentityModel.Clients.ActiveDirectory  <li>Microsoft.AspNet.Identity.EntityFramework </li>\n</ol>\n<p>首先我們要安裝Token的套件，也就是System.IdentityModel.Tokens.ValidatingIssuerNameRegistry。</p>\n<p><a href=\"http://lh4.ggpht.com/-0RMY7dUbvnY/U2-pzzT90XI/AAAAAAAAI2I/D3bXUgOiZJQ/s1600-h/image%25255B33%25255D.png\"><img src=\"http://lh3.ggpht.com/-YsxrKdE-xAM/U2-p1qDFZfI/AAAAAAAAI2Q/xc2_hKqvrdw/image_thumb%25255B19%25255D.png?imgmax=800\" alt=\"image\" title=\"image\"></a></p>\n<p>接下來，要安裝的是Microsoft.IdentityModel.Clients.ActiveDirectory。</p>\n<p><a href=\"http://lh3.ggpht.com/-WuJqwq6vDWw/VAXht0IWo4I/AAAAAAAAJ0o/4DmY70BZJfg/s1600-h/image%25255B24%25255D.png\"><img src=\"http://lh6.ggpht.com/-1b3N9G6Vj2w/VAXhvHx0ZuI/AAAAAAAAJ0w/Lx7AFKy1RM4/image_thumb%25255B12%25255D.png?imgmax=800\" alt=\"image\" title=\"image\"></a></p>\n<p>另外，畢竟是驗證，所以我們要使用Identity套件，而我們這邊使用Identity搭配Entity Framework；這邊或許有人會覺得疑惑，為什麼Azure AD的驗證還要搭配Entity Framework !?..其實不用也是可以啦，在官方現在標準的作法，會使用Entity Framework來將驗證方的相關資訊存放到DB裡面去，而不是早期的Web.config…會這樣做的原因，官方是說，它們實現了一個機制，可以利用Lib去產生驗證方的資訊；而會有這種做法，主要是因為官方覺得，早期寫到web.config的時候，是寫死的，所以當驗證方的資訊改變的時候，變成一定要手動再去調整web.config，而中間的這段時間，就有可能讓程式停擺…所以現在官方是希望透過程式自動產生資訊，並且存放到DB；而這次的文章，主要還是會透過DB，小弟我看了一下機制後，感覺還不錯，所以就繼續沿用這個機制來實作，但原則上因該也是可以透過web.config，但這塊可能就請看官大大們，自己嘗試一下嚕~~ </p>\n<p><a href=\"http://lh4.ggpht.com/-377AqiDyTAc/U2-p39DVVBI/AAAAAAAAI2o/ck-Kjn1vAj8/s1600-h/image%25255B49%25255D.png\"><img src=\"http://lh3.ggpht.com/-s8cKCGKq91M/U2-p44i4zQI/AAAAAAAAI2w/1VPMAaF8yJI/image_thumb%25255B29%25255D.png?imgmax=800\" alt=\"image\" title=\"image\"></a></p>\n<p>所以這邊會把Entity Framework通通加進去~</p>\n<p><a href=\"http://lh3.ggpht.com/-XWJEFDoUKaU/U2-p5kzNbPI/AAAAAAAAI24/ioCA6YWCdlw/s1600-h/image%25255B53%25255D.png\"><img src=\"http://lh4.ggpht.com/-V_JMkKhUuGU/U2-p6aIPtaI/AAAAAAAAI3A/G1tkRfwNuyc/image_thumb%25255B31%25255D.png?imgmax=800\" alt=\"image\" title=\"image\"></a></p>\n<p>裝完之後，我們可以先看一下Web.config，並且刪除掉一些不用的東西，原始是這樣。</p>\n<pre class=\"brush: xml;\">&lt;?xml version=\"1.0\" encoding=\"utf-8\"?&gt;\n&lt;!--\n  如需如何設定 ASP.NET 應用程式的詳細資訊，請瀏覽\n  http://go.microsoft.com/fwlink/?LinkId=301880\n  --&gt;\n&lt;configuration&gt;\n  &lt;configSections&gt;\n    &lt;!-- For more information on Entity Framework configuration, visit http://go.microsoft.com/fwlink/?LinkID=237468 --&gt;\n    &lt;section name=\"entityFramework\" type=\"System.Data.Entity.Internal.ConfigFile.EntityFrameworkSection, EntityFramework, Version=6.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089\" requirePermission=\"false\" /&gt;\n  &lt;/configSections&gt;\n  &lt;appSettings&gt;\n    &lt;add key=\"webpages:Version\" value=\"3.0.0.0\" /&gt;\n    &lt;add key=\"webpages:Enabled\" value=\"false\" /&gt;\n    &lt;add key=\"ClientValidationEnabled\" value=\"true\" /&gt;\n    &lt;add key=\"UnobtrusiveJavaScriptEnabled\" value=\"true\" /&gt;\n  &lt;/appSettings&gt;\n  &lt;system.web&gt;\n    &lt;compilation debug=\"true\" targetFramework=\"4.5\" /&gt;\n    &lt;httpRuntime targetFramework=\"4.5\" /&gt;\n  &lt;/system.web&gt;\n  &lt;entityFramework&gt;\n    &lt;defaultConnectionFactory type=\"System.Data.Entity.Infrastructure.LocalDbConnectionFactory, EntityFramework\"&gt;\n      &lt;parameters&gt;\n        &lt;parameter value=\"v12.0\" /&gt;\n      &lt;/parameters&gt;\n    &lt;/defaultConnectionFactory&gt;\n    &lt;providers&gt;\n      &lt;provider invariantName=\"System.Data.SqlClient\" type=\"System.Data.Entity.SqlServer.SqlProviderServices, EntityFramework.SqlServer\" /&gt;\n    &lt;/providers&gt;\n  &lt;/entityFramework&gt;\n&lt;/configuration&gt;\n</pre>\n<p>最終結果會被我砍成這樣。</p>\n<pre class=\"brush: xml;\">&lt;?xml version=\"1.0\" encoding=\"utf-8\"?&gt;\n&lt;!--\n  如需如何設定 ASP.NET 應用程式的詳細資訊，請瀏覽\n  http://go.microsoft.com/fwlink/?LinkId=301880\n  --&gt;\n&lt;configuration&gt;\n  &lt;configSections&gt;\n    &lt;/configSections&gt;\n  &lt;appSettings&gt;\n    &lt;add key=\"webpages:Version\" value=\"3.0.0.0\" /&gt;\n    &lt;add key=\"webpages:Enabled\" value=\"false\" /&gt;\n    &lt;add key=\"ClientValidationEnabled\" value=\"true\" /&gt;\n    &lt;add key=\"UnobtrusiveJavaScriptEnabled\" value=\"true\" /&gt;\n  &lt;/appSettings&gt;\n  &lt;system.web&gt;\n    &lt;compilation debug=\"true\" targetFramework=\"4.5\" /&gt;\n    &lt;httpRuntime targetFramework=\"4.5\" /&gt;\n  &lt;/system.web&gt;\n\n&lt;/configuration&gt;\n</pre>\n<p>我們主要是刪除了，configSections裡面的section name = “entityFramework”這個區段。</p>\n<pre class=\"brush: xml;\">&lt;configSections&gt;\n&lt;!-- For more information on Entity Framework configuration, visit http://go.microsoft.com/fwlink/?LinkID=237468 --&gt;\n&lt;section name=\"entityFramework\" type=\"System.Data.Entity.Internal.ConfigFile.EntityFrameworkSection, EntityFramework, Version=6.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089\" requirePermission=\"false\" /&gt;\n&lt;/configSections&gt;\n</pre>\n<p>和最下面的entityFramework區段…</p>\n<pre class=\"brush: xml;\">  &lt;entityFramework&gt;\n    &lt;defaultConnectionFactory type=\"System.Data.Entity.Infrastructure.LocalDbConnectionFactory, EntityFramework\"&gt;\n      &lt;parameters&gt;\n        &lt;parameter value=\"v12.0\" /&gt;\n      &lt;/parameters&gt;\n    &lt;/defaultConnectionFactory&gt;\n    &lt;providers&gt;\n      &lt;provider invariantName=\"System.Data.SqlClient\" type=\"System.Data.Entity.SqlServer.SqlProviderServices, EntityFramework.SqlServer\" /&gt;\n    &lt;/providers&gt;\n  &lt;/entityFramework&gt;\n</pre>\n<p>這兩個區段主要是用於，當沒有給連線字串的時候，EF會自動的透過LocalDbConnectionFactory來取得localdb，但因為我們會使用connectionString，所以這個兩個設定就顯得多餘了…</p>\n<p>接下來，我們還要參考兩個DLL，但這個不用從Nuget下載；分別是System.IdentityModel和System.IdentityModel.Services。</p>\n<p><a href=\"http://lh6.ggpht.com/-9loSuJLsVJg/VAXr96sx7TI/AAAAAAAAJ2Q/8aUO79WZmQw/s1600-h/image%25255B5%25255D.png\"><img src=\"http://lh6.ggpht.com/-ahBOYYe-gnw/VAXsAIr8V3I/AAAAAAAAJ2Y/3nKCtf6F7JI/image_thumb%25255B2%25255D.png?imgmax=800\" alt=\"image\" title=\"image\"></a></p>\n<p>基本上，初步的設定就到這邊，下一篇，就會針對Azure AD要使用的Web.config進行撰寫。</p>\n<h4>參考資料</h4>\n<ul>\n<li><a href=\"http://msdn.microsoft.com/zh-tw/library/azure/dn151790.aspx\" title=\"http://msdn.microsoft.com/zh-tw/library/azure/dn151790.aspx\">http://msdn.microsoft.com/zh-tw/library/azure/dn151790.aspx</a><li><a href=\"http://blogs.msdn.com/b/mvpawardprogram/archive/2014/01/20/identity-in-your-own-apps-with-windows-azure-active-directory.aspx\" title=\"http://blogs.msdn.com/b/mvpawardprogram/archive/2014/01/20/identity-in-your-own-apps-with-windows-azure-active-directory.aspx\">http://blogs.msdn.com/b/mvpawardprogram/archive/2014/01/20/identity-in-your-own-apps-with-windows-azure-active-directory.aspx</a><li><a href=\"http://blogs.msdn.com/b/mvpawardprogram/archive/2014/02/03/identity-in-your-own-apps-with-windows-azure-active-directory-part-2.aspx\" title=\"http://blogs.msdn.com/b/mvpawardprogram/archive/2014/02/03/identity-in-your-own-apps-with-windows-azure-active-directory-part-2.aspx\">http://blogs.msdn.com/b/mvpawardprogram/archive/2014/02/03/identity-in-your-own-apps-with-windows-azure-active-directory-part-2.aspx</a><li><a href=\"http://www.codeproject.com/Articles/749588/Role-Based-Access-Control-with-Azure-Active-Direct\" title=\"http://www.codeproject.com/Articles/749588/Role-Based-Access-Control-with-Azure-Active-Direct\">http://www.codeproject.com/Articles/749588/Role-Based-Access-Control-with-Azure-Active-Direct</a><li><a href=\"http://www.cloudidentity.com/blog/2013/02/08/multitenant-sts-and-token-validation-4/\" title=\"http://www.cloudidentity.com/blog/2013/02/08/multitenant-sts-and-token-validation-4/\">http://www.cloudidentity.com/blog/2013/02/08/multitenant-sts-and-token-validation-4/</a><li><a href=\"http://www.cloudidentity.com/blog/2013/04/02/auto-update-of-the-signing-keys-via-metadata/\" title=\"http://www.cloudidentity.com/blog/2013/04/02/auto-update-of-the-signing-keys-via-metadata/\">http://www.cloudidentity.com/blog/2013/04/02/auto-update-of-the-signing-keys-via-metadata/</a></li>\n</ul>","excerpt":"隔離上次寫文章，竟然整整的拖超過一個月( 連Windows Azure都改名為Microsoft Azure了…)…實在是因為這段時間整個忙到翻掉，上班趕Code…"}},"pageContext":{"type":"posts","next":{"frontmatter":{"path":null,"title":"Azure -  刪除Azure上的AD","tags":["Active Directory","Azure"]},"fields":{"slug":"/2014/05/11/Azure-刪除Azure上的AD/"},"fileAbsolutePath":"/home/runner/work/blog.sanc.idv.tw/blog.sanc.idv.tw/src/posts/blog.sanc.idv.tw/Azure-刪除Azure上的AD.md"},"previous":{"frontmatter":{"path":null,"title":"ASP.NET MVC - 限制CamalCase在特定的Web API Controller下","tags":["ASP.NET MVC"]},"fields":{"slug":"/2014/05/15/ASP-NET-MVC-限制CamalCase在特定的Web-API-Controller下/"},"fileAbsolutePath":"/home/runner/work/blog.sanc.idv.tw/blog.sanc.idv.tw/src/posts/blog.sanc.idv.tw/ASP-NET-MVC-限制CamalCase在特定的Web-API-Controller下.md"}}}}