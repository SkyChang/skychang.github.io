{"componentChunkName":"component---src-templates-page-js","path":"/2014/09/02/Azure-實作Azure上的AD與MVC進行驗證-Azure設定篇-二/","result":{"data":{"markdownRemark":{"frontmatter":{"title":"Azure - 實作Azure上的AD與MVC進行驗證 - Azure設定篇 ( 二 )","date":"02 September 2014","author":"Sky Chang","excerpt":null,"tags":["Active Directory","ASP.NET MVC","Azure"],"coverImage":null},"id":"e6551d45-2bcf-5801-9d54-367f2eb4bdab","html":"<p>繼<a href=\"http://blog.sanc.idv.tw/2014/05/azure-azureadmvc-azure.html\">上一篇</a>的文章到現在，大概也整整過了4個月了，終於有時間繼續把這篇補完…上一篇完成了基本的Nuget套件設定、DLL參考、還有Azure的設定，而這篇，我們就著重在Web.config上吧。</p>\n<p>首先，我們要在Web.config裡面的configuration底下，加入configSections區段…</p>\n<pre class=\"brush: xml;\">&lt;configuration&gt;\n  &lt;configSections&gt;\n    &lt;section name=\"system.identityModel\" type=\"System.IdentityModel.Configuration.SystemIdentityModelSection, System.IdentityModel, Version=4.0.0.0, Culture=neutral, PublicKeyToken=B77A5C561934E089\" /&gt;\n    &lt;section name=\"system.identityModel.services\" type=\"System.IdentityModel.Services.Configuration.SystemIdentityModelServicesSection, System.IdentityModel.Services, Version=4.0.0.0, Culture=neutral, PublicKeyToken=B77A5C561934E089\" /&gt;\n  &lt;/configSections&gt;</pre>\n<p>接下來，我們要在appSettings底下，加入以下資訊，比較需要注意的是，ida:Realm和ida:AudienceUri，後面的value值就是我們前一篇的輸入的應用程式識別碼URL，而ida:ClientID和ida : Password就是我們前一篇要大家記的ID和PW喔!~</p>\n<pre class=\"brush: xml;\">&lt;add key=\"ida:FederationMetadataLocation\" value=\"https://login.windows.net/study4.tw/FederationMetadata/2007-06/FederationMetadata.xml\" /&gt;\n&lt;add key=\"ida:Realm\" value=\"https://study4.tw/TestAD\" /&gt;\n&lt;add key=\"ida:AudienceUri\" value=\"https://study4.tw/TestAD\" /&gt;\n&lt;add key=\"ida:ClientID\" value=\"dce9aa7d-adf3-42dc-ac5e-d5043047adec\" /&gt;\n&lt;add key=\"ida:Password\" value=\"41O94SwvthtAs99tQIWpHhdRkXBQNjPax0fQ9orOcXc=\" /&gt;\n</pre>\n<p>所以完成的會如下。</p>\n<pre class=\"brush: xml;\">  &lt;appSettings&gt;\n    &lt;add key=\"webpages:Version\" value=\"3.0.0.0\" /&gt;\n    &lt;add key=\"webpages:Enabled\" value=\"false\" /&gt;\n    &lt;add key=\"ClientValidationEnabled\" value=\"true\" /&gt;\n    &lt;add key=\"UnobtrusiveJavaScriptEnabled\" value=\"true\" /&gt;\n    &lt;add key=\"ida:FederationMetadataLocation\" value=\"https://login.windows.net/study4.tw/FederationMetadata/2007-06/FederationMetadata.xml\" /&gt;\n    &lt;add key=\"ida:Realm\" value=\"https://study4.tw/TestAD\" /&gt;\n    &lt;add key=\"ida:AudienceUri\" value=\"https://study4.tw/TestAD\" /&gt;\n    &lt;add key=\"ida:ClientID\" value=\"dce9aa7d-adf3-42dc-ac5e-d5043047adec\" /&gt;\n    &lt;add key=\"ida:Password\" value=\"41O94SwvthtAs99tQIWpHhdRkXBQNjPax0fQ9orOcXc=\" /&gt;\n  &lt;/appSettings&gt;\n</pre>\n<p>下圖是另外一個範例，用的是Study4IdentityForAD，所以會Key成這樣。</p>\n<p><a href=\"http://lh4.ggpht.com/-TRtae7zewVk/VAXoO_8jtbI/AAAAAAAAJ1M/8iy0Ulm7e2Y/s1600-h/image%25255B61%25255D.png\"><img src=\"http://lh3.ggpht.com/-HYvl7_hbsjE/VAXoQMqpvuI/AAAAAAAAJ1U/SDeOWkB1_58/image_thumb%25255B30%25255D.png?imgmax=800\" alt=\"image\" title=\"image\"></a></p>\n<p>接下來，我們要設定驗證區段，這邊，不管哪個目錄，反正要看到網站內容，就要先登入AD…</p>\n<pre class=\"brush: xml;\">  &lt;location path=\"Account\"&gt;\n    &lt;system.web&gt;\n      &lt;authorization&gt;\n        &lt;allow users=\"*\" /&gt;\n      &lt;/authorization&gt;\n    &lt;/system.web&gt;\n  &lt;/location&gt;\n</pre>\n<p>然後system.web底下要改成如下。</p>\n<pre class=\"brush: xml;\">  &lt;system.web&gt;\n      &lt;authentication mode=\"None\" /&gt;\n      &lt;authorization&gt;\n        &lt;deny users=\"?\" /&gt;\n      &lt;/authorization&gt;\n      &lt;compilation debug=\"true\" targetFramework=\"4.5\" /&gt;\n      &lt;httpRuntime targetFramework=\"4.5\" requestValidationMode=\"4.5\" /&gt;\n</pre>\n<p>最後，我們要在加上底下的區段，畢竟Web.config一開始有設這個區段阿，所以我們還是要把這個區段補上，這個區段只要在設定identityModel的相關資訊，而這邊比較需要注意的是issuerNameRegistry這邊，後面的type要輸入的是專案名稱加上Utils.DatabaseIssuerNameRegistry，而後面的逗點之後，也要輸入專案的名稱；所以以這邊為案例，就是要輸入WebApplication2.Utils.DatabaseIssuerNameRegistry,WebApplication2。</p>\n<pre class=\"brush: xml;\">  &lt;system.identityModel&gt;\n    &lt;identityConfiguration&gt;\n      &lt;issuerNameRegistry type=\"WebApplication2.Utils.DatabaseIssuerNameRegistry, WebApplication2\" /&gt;\n      &lt;audienceUris&gt;\n        &lt;add value=\"https://study4.tw/TestAD\" /&gt;\n      &lt;/audienceUris&gt;\n      &lt;securityTokenHandlers&gt;\n        &lt;add type=\"System.IdentityModel.Services.Tokens.MachineKeySessionSecurityTokenHandler, System.IdentityModel.Services, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089\" /&gt;\n        &lt;remove type=\"System.IdentityModel.Tokens.SessionSecurityTokenHandler, System.IdentityModel, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089\" /&gt;\n      &lt;/securityTokenHandlers&gt;\n      &lt;certificateValidation certificateValidationMode=\"None\" /&gt;\n    &lt;/identityConfiguration&gt;\n  &lt;/system.identityModel&gt;\n</pre>\n<p>如下圖，用的是Study4IdentityForAD，所以要輸入Study4IdentityForAD。</p>\n<p><a href=\"http://lh3.ggpht.com/--jn9BaYNcog/VAXoResch0I/AAAAAAAAJ1c/9FL62OBiLVI/s1600-h/image%25255B53%25255D%25255B3%25255D.png\"><img src=\"http://lh5.ggpht.com/-LIp0edtNYYY/VAXoSwW8EDI/AAAAAAAAJ1k/zDd6FMrU2SA/image%25255B53%25255D_thumb%25255B1%25255D.png?imgmax=800\" alt=\"image[53]\" title=\"image[53]\"></a></p>\n<p>最後，我們還有system.webServer這個區段要設定，一樣wsFederation裡面，需要設定應用程式識別碼URL。</p>\n<pre class=\"brush: xml;\">  &lt;system.webServer&gt;\n    &lt;modules&gt;\n      &lt;add name=\"WSFederationAuthenticationModule\" type=\"System.IdentityModel.Services.WSFederationAuthenticationModule, System.IdentityModel.Services, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089\" preCondition=\"managedHandler\" /&gt;\n      &lt;add name=\"SessionAuthenticationModule\" type=\"System.IdentityModel.Services.SessionAuthenticationModule, System.IdentityModel.Services, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089\" preCondition=\"managedHandler\" /&gt;\n    &lt;/modules&gt;\n  &lt;/system.webServer&gt;\n  &lt;system.identityModel.services&gt;\n    &lt;federationConfiguration&gt;\n      &lt;cookieHandler requireSsl=\"true\" /&gt;\n      &lt;wsFederation passiveRedirectEnabled=\"true\" issuer=\"https://login.windows.net/study4.tw/wsfed\" realm=\"https://study4.tw/TestAD\" requireHttps=\"true\" /&gt;\n    &lt;/federationConfiguration&gt;\n  &lt;/system.identityModel.services&gt;\n</pre>\n<p>最後，因為我們這個專案主要是使用SSL，所以別忘了把SSL開啟喔!!~</p>\n<p><a href=\"http://lh3.ggpht.com/-liomSLh35CQ/VAXoT37S-aI/AAAAAAAAJ1s/HWNRyziZyy4/s1600-h/image%25255B68%25255D.png\"><img src=\"http://lh5.ggpht.com/-SBiaybydlzY/VAXoVXymX-I/AAAAAAAAJ10/eXN9GiFJ7Gk/image_thumb%25255B35%25255D.png?imgmax=800\" alt=\"image\" title=\"image\"></a></p>\n<p>納因為這邊給的PORT是44303，所以我們還要回到Azure那邊去改一下資料。</p>\n<p><a href=\"http://lh5.ggpht.com/-zcUHusQbX8w/VAXoWPYLgFI/AAAAAAAAJ14/XY0yOWd_oGQ/s1600-h/image%25255B73%25255D.png\"><img src=\"http://lh6.ggpht.com/-wXQtaDQ1YRY/VAXoXUR7qFI/AAAAAAAAJ2E/qwfs7E8loKo/image_thumb%25255B38%25255D.png?imgmax=800\" alt=\"image\" title=\"image\"></a></p>\n<p>到這邊為止，我們算是設定好了…接下來要開始用一些Code…</p>\n<h4>參考資料</h4>\n<ul>\n<li><a href=\"http://geeks.ms/blogs/lmanez/archive/2014/06/10/adding-windows-azure-active-directory-to-an-existing-asp-net-app.aspx\" title=\"http://geeks.ms/blogs/lmanez/archive/2014/06/10/adding-windows-azure-active-directory-to-an-existing-asp-net-app.aspx\">http://geeks.ms/blogs/lmanez/archive/2014/06/10/adding-windows-azure-active-directory-to-an-existing-asp-net-app.aspx</a></li>\n</ul>","excerpt":"繼上一篇的文章到現在，大概也整整過了4個月了，終於有時間繼續把這篇補完…上一篇完成了基本的Nuget套件設定、DLL參考、還有Azure的設定，而這篇，我們就著重在Web.config上吧。 首先，我們要在Web.config裡面的configuration…"}},"pageContext":{"type":"posts","next":{"frontmatter":{"path":null,"title":"Azure -  Application Insights","tags":["Azure","VSO"]},"fields":{"slug":"/2014/08/24/Azure-Application-Insights/"},"fileAbsolutePath":"/home/runner/work/blog.sanc.idv.tw/blog.sanc.idv.tw/src/posts/blog.sanc.idv.tw/Azure-Application-Insights.md"},"previous":{"frontmatter":{"path":null,"title":"Azure - 實作Azure上的AD與MVC進行驗證 - Azure設定篇 ( 三 )","tags":["Active Directory","ASP.NET MVC","Azure"]},"fields":{"slug":"/2014/09/03/Azure-實作Azure上的AD與MVC進行驗證-Azure設定篇-三/"},"fileAbsolutePath":"/home/runner/work/blog.sanc.idv.tw/blog.sanc.idv.tw/src/posts/blog.sanc.idv.tw/Azure-實作Azure上的AD與MVC進行驗證-Azure設定篇-三.md"}}}}