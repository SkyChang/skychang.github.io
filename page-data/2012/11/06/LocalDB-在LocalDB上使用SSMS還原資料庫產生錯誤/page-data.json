{"componentChunkName":"component---src-templates-page-js","path":"/2012/11/06/LocalDB-在LocalDB上使用SSMS還原資料庫產生錯誤/","result":{"data":{"markdownRemark":{"frontmatter":{"title":"LocalDB - 在LocalDB上使用SSMS還原資料庫產生錯誤","date":"06 November 2012","author":"Sky Chang","excerpt":null,"tags":["SQL Server"],"coverImage":null},"id":"661a4b67-abd5-5ecd-b264-63daeb90aec0","html":"<p><font color=\"#ff0000\">2012/11/09 更新 – 保哥的<a href=\"http://blog.miniasp.com/post/2012/11/08/Restore-DB-to-the-SQL-Server-LocalDb-instance-using-SSMS.aspx#continue\">這篇文章</a>，有教大家手動</font><font color=\"#ff0000\">修改註冊碼，來修正這個錯誤喔，而Terry哥也提供了<a href=\"http://www.dotblogs.com.tw/terrychuang/archive/2012/11/08/81063.aspx\">一篇文章</a>，利用T-SQL去修改註冊碼!!大家有興趣也可以連過去看看=V=</font></p>\n<p>很久很久以前，有一個案子 ( 好像在說故事一樣… )，那時後再使用SQL Server Express當作本機的資料庫開發；而最近，因為需求的關係，需要進行一些調整，老實說，我也懶的(不想)去裝SQL Server Express，畢竟用LocalDB用的好好的，為啥還要去裝呢!?於是，就先把資料從SQL Server Express備份下來 ( 不要問我，為什麼不直接拷貝mdf和log檔案..因為小弟我直覺就選擇了備份XDD )，然後拿到現在的電腦上，準備利用SSMS對LocalDB進行匯入…</p>\n<p>然後悲劇就發生了… ( 所以這是一個悲慘的故事… )</p>\n<p><a href=\"http://lh6.ggpht.com/-GprqMGJOVmg/UJky3oDyrzI/AAAAAAAAFR4/cDVQG08V9p8/s1600-h/image%25255B3%25255D.png\"><img src=\"http://lh6.ggpht.com/-UYsh0jV26MM/UJky4iWuFeI/AAAAAAAAFSA/GBD2bgAkdRU/image_thumb%25255B1%25255D.png?imgmax=800\" alt=\"image\" title=\"image\"></a></p>\n<blockquote>\n<p>設定 'Microsoft.SqlServer.Management.Smo.Settings' 無法使用屬性 BackupDirectory。此物件可能沒有此屬性，或因為存取權限不足而無法擷取。 (Microsoft.SqlServer.Smo) </p>\n</blockquote>\n<p>或是選擇還原資料庫，也是出現同樣的錯誤。( 當然，我不是要還原到msdb..這裡只是隨便選一個，重點是上面的紅色框框。 )</p>\n<p><a href=\"http://lh3.ggpht.com/-PCQxI9Apylg/UJky6fmwxbI/AAAAAAAAFSI/TPLMDJgFLUk/s1600-h/image%25255B9%25255D.png\"><img src=\"http://lh6.ggpht.com/-U7NDaiBUIHs/UJky7XYHZBI/AAAAAAAAFSQ/DtUH3mD0OAM/image_thumb%25255B5%25255D.png?imgmax=800\" alt=\"image\" title=\"image\"></a></p>\n<p>好吧，既然發生錯誤，就要去尋找怎樣解決，於是找到了<a href=\"http://dba.stackexchange.com/questions/23609/sql-server-localdb-instance-error-restoring-backup-masterdbpath-not-available\">這篇</a>；內文大致上是說，因為路徑的關係，所以要去改註冊碼，要不然就是要用T-SQL解決，而目前保哥也提供了<a href=\"http://blog.miniasp.com/post/2012/11/08/Restore-DB-to-the-SQL-Server-LocalDb-instance-using-SSMS.aspx#continue\">一篇文章</a>，來教大家如何修改註冊碼，而Terry哥也提供了<a href=\"http://www.dotblogs.com.tw/terrychuang/archive/2012/11/08/81063.aspx\">一篇文章</a>，則是利用T-SQL去修改註冊碼!!有興趣的可以連過去看看，小弟這邊就不針對註冊碼的地方做教學了 ( 沒事不要和那幾位神人PK~~ )。</p>\n<p>OK，不管怎樣，小弟是沒去改路徑，而且既然T-SQL可以解決，那就用T-SQL吧，反正小弟我也不是一天到晚要復原XDD，也順便學習一下T-SQL…( 路人 : 我看其實是寫這篇文章的時候，根本沒去測試註冊碼的方式…還那麼多理由… )。OK，不管怎樣，那些是神人的做法XDD，平民的小弟我，還是用T-SQL就好!!，接下來，我們先看一下這個T-SQL。</p>\n<pre class=\"brush: sql;\">RESTORE DATABASE FROM DISK = '' WITH NORECOVERY,\nMOVE 'example_dat' TO 'C:\\Temp\\.mdf', \nMOVE 'example_log' TO 'C:\\Temp\\.ldf'\n</pre>\n<p>OK，相信如果是DBA，大概就已經知道如何還原了，後面也可以不用往下看了XDD，( 後面就單純介紹這個指令而已了。 )。</p>\n<p>那這個T-SQL是甚麼意思呢，簡單的說，就是恢復Restore資料庫(廢話!!)，而要恢復的這個資料庫來源來自於哪邊，所有DISK後面要接位置；例如DISK = ‘C:\\Temp\\ss.bak'；接下來的WITH，表示我們後面還要加上一些還原的選項，例如這邊我們的NORECOVERY，就是代表著，要執行NORECOVERY的作業 ( 好啦，後續會講到…)；而Move表示我們要將原本SQL Server的mdf和ldf檔案的位置，改變到新的位置。</p>\n<p>嗯，有聽沒有懂!?，那我們先執行一下下面這個指令看看；我們可以利用這個指令列出備份檔案的資料。</p>\n<pre class=\"brush: sql;\">RESTORE FILELISTONLY FROM \nDISK='C:\\Temp\\SC' </pre>\n<p>會出現如下圖，大家可以看到下面第一個是LogicalName( 這邊資料很抱歉，必須隱藏一下，總之就是Sxxxx<em>Data和Sxxx</em>Log )，而第二個是PhysicalName，也就是原本mdf和ldf檔案存放的位置；那大家可以發現甚麼?是的，原本的mdf和ldf位置，是放在SQL Server Express的預設目錄下面。</p>\n<p><a href=\"http://lh6.ggpht.com/-g70xXKr3ToA/UJky83aBfeI/AAAAAAAAFSY/Py8SKpqqR_c/s1600-h/image%25255B18%25255D.png\"><img src=\"http://lh6.ggpht.com/-sEEddURKIjE/UJky-K7Ay1I/AAAAAAAAFSg/MexykTlH0Nk/image_thumb%25255B10%25255D.png?imgmax=800\" alt=\"image\" title=\"image\"></a></p>\n<p>所以我們回到剛剛的T-SQL，大家應該就可以了解的到，為什麼要用Move了吧，因為原本的備份檔，mdf和ldf檔的位置是在SQL Server Express的預設目錄下，而小弟我因為要移到新的電腦上，所以要存放mdf和ldf的位置，就和原本的不同了，所以要使用Move指令改變位置，所以我們的T-SQL會改成這樣；Move後面接的是LogicName的名稱，也就是Sxxxx_Data，而To接的就是要搬到那裡，然後也順便把DISK填入備份檔的路徑。</p>\n<pre class=\"brush: sql;\">RESTORE DATABASE FROM DISK = 'C:\\Temp\\SC' WITH NORECOVERY, \nMOVE 'Sxxxx_Data' TO 'C:\\Temp\\Sxxxx.mdf', \nMOVE 'Sxxxx_Log' TO 'C:\\Temp\\Sxxxx.ldf'</pre>\n<p>另外，備註一下，如果Sxxxx_Data填錯，則會出現以下錯誤，所以我們才要用RESTORE FILELISTONLY來列出名稱。</p>\n<blockquote>\n<p>邏輯檔案 'xx' 不屬於資料庫 xx' 的一部分。請使用 RESTORE FILELISTONLY 列出邏輯檔案名稱。</p>\n</blockquote>\n<p>所以，這樣就好了嗎!?如果這樣執行下去，你會發現，DB的確是還原了…但會出現如下圖；式的會一直卡在\"正在還原\"。</p>\n<p><a href=\"http://lh5.ggpht.com/-eO8unVEtEms/UJky_U8aRVI/AAAAAAAAFSk/gJFhI1VZ2rU/s1600-h/image%25255B22%25255D.png\"><img src=\"http://lh4.ggpht.com/-aEtSJKM2PNg/UJkzAmV4K6I/AAAAAAAAFSw/HR9-Q0qDJEo/image_thumb%25255B12%25255D.png?imgmax=800\" alt=\"image\" title=\"image\"></a></p>\n<p>那是為什麼呢?其實是因為NORECOVERY這個參數的關係，這個參數的意思，官方是這樣寫的。</p>\n<blockquote>\n<p>指示還原作業不回復任何未認可的交易。 如果稍後必須套用另一個交易記錄，請指定 NORECOVERY 或 STANDBY 選項。 如果 NORECOVERY、RECOVERY 和 STANDBY 三者都沒有指定，預設值就是 RECOVERY。 在使用 NORECOVERY 選項的離線還原作業期間，無法使用資料庫。</p>\n</blockquote>\n<p>就如官方的最後段話，使用NORECOVERY後，會無法使用資料庫；其實那是因為SQL Server的還原機制有三種，不過再談下去，就越拉越遠了XDD，大家可以參考Cary的<a href=\"http://caryhsu.blogspot.tw/2011/10/sql-server.html\">這篇</a>，或是Funkent的<a href=\"http://ithelp.ithome.com.tw/question/10028731\">這篇</a>。</p>\n<p>總之，因為小弟我的備份，是全部備份下來，也沒使用差異備份，所以我們要把NORECOVERY改成RECOVERY，要把T-SQL改成這樣。</p>\n<pre class=\"brush: sql;\">RESTORE DATABASE SDB\nFROM DISK = 'C:\\Temp\\SC' \nWITH RECOVERY,\nMOVE 'Sxxxx_Data' TO 'C:\\Temp\\Sxxxx.mdf', \nMOVE 'Sxxxx_Log' TO 'C:\\Temp\\Sxxxx.ldf' \n</pre>\n<p>這樣又可以了，如下圖，因為SQL Server Express是舊版的db，所以也會自動升級。</p>\n<p><a href=\"http://lh4.ggpht.com/-pmMG4LPXgCw/UJkzB1jDNNI/AAAAAAAAFS0/bMOyNJ0Bo98/s1600-h/image%25255B26%25255D.png\"><img src=\"http://lh3.ggpht.com/-rjbJF7cgOao/UJkzDKR9mAI/AAAAAAAAFTA/lCcONJSnn28/image_thumb%25255B14%25255D.png?imgmax=800\" alt=\"image\" title=\"image\"></a></p>\n<p>就這樣，完成了人生第一次的T-SQL 備份還原XDDD ( 話說有點撈過界了XDDD )</p>\n<h4>後記</h4>\n<p>老實說，雖然有點撈過界XDD，但也學習到不少東西，希望DBA高手們，不要鞭我喔XDDD</p>\n<h4>參考資料</h4>\n<ul>\n<li><a href=\"http://dba.stackexchange.com/questions/23609/sql-server-localdb-instance-error-restoring-backup-masterdbpath-not-available\" title=\"http://dba.stackexchange.com/questions/23609/sql-server-localdb-instance-error-restoring-backup-masterdbpath-not-available\">http://dba.stackexchange.com/questions/23609/sql-server-localdb-instance-error-restoring-backup-masterdbpath-not-available</a><li><a href=\"http://connect.microsoft.com/SQLServer/feedback/details/726826/management-studio-exception-for-localdb-instance\" title=\"http://connect.microsoft.com/SQLServer/feedback/details/726826/management-studio-exception-for-localdb-instance\">http://connect.microsoft.com/SQLServer/feedback/details/726826/management-studio-exception-for-localdb-instance</a><li><a href=\"http://ithelp.ithome.com.tw/question/10030539\" title=\"http://ithelp.ithome.com.tw/question/10030539\">http://ithelp.ithome.com.tw/question/10030539</a><li><a href=\"http://ithelp.ithome.com.tw/question/10028731\" title=\"http://ithelp.ithome.com.tw/question/10028731\">http://ithelp.ithome.com.tw/question/10028731</a><li><a href=\"http://sharedderrick.blogspot.tw/2008/12/sql-server-restoring.html\" title=\"http://sharedderrick.blogspot.tw/2008/12/sql-server-restoring.html\">http://sharedderrick.blogspot.tw/2008/12/sql-server-restoring.html</a><li><a href=\"http://msdn.microsoft.com/zh-tw/library/ms178615.aspx\" title=\"http://msdn.microsoft.com/zh-tw/library/ms178615.aspx\">http://msdn.microsoft.com/zh-tw/library/ms178615.aspx</a><li><a href=\"http://caryhsu.blogspot.tw/2011/10/sql-server.html\" title=\"http://caryhsu.blogspot.tw/2011/10/sql-server.html\">http://caryhsu.blogspot.tw/2011/10/sql-server.html</a></li>\n</ul>","excerpt":"2012/11/09 更新 – 保哥的這篇文章，有教大家手動修改註冊碼，來修正這個錯誤喔，而Terry哥也提供了一篇文章，利用T-SQL去修改註冊碼!!大家有興趣也可以連過去看看=V= 很久很久以前，有一個案子 ( 好像在說故事一樣… )，那時後再使用SQL Server…"}},"pageContext":{"type":"posts","next":{"frontmatter":{"path":null,"title":"Window Azure - Git與Web Site的自動佈署","tags":["Azure","Git"]},"fields":{"slug":"/2012/11/05/Window-Azure-Git與Web-Site的自動佈署/"},"fileAbsolutePath":"/home/runner/work/blog.sanc.idv.tw/blog.sanc.idv.tw/src/posts/blog.sanc.idv.tw/Window-Azure-Git與Web-Site的自動佈署.md"},"previous":{"frontmatter":{"path":null,"title":"ASP.NET MVC – ASP.NET MVC 4 2012 Fall Update","tags":["ASP.NET","ASP.NET MVC","Azure"]},"fields":{"slug":"/2012/11/08/ASP-NET-MVC-–-ASP-NET-MVC-4-2012-Fall-Update/"},"fileAbsolutePath":"/home/runner/work/blog.sanc.idv.tw/blog.sanc.idv.tw/src/posts/blog.sanc.idv.tw/ASP-NET-MVC-–-ASP-NET-MVC-4-2012-Fall-Update.md"}}}}