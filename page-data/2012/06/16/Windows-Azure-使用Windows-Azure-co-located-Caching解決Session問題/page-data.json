{"componentChunkName":"component---src-templates-page-js","path":"/2012/06/16/Windows-Azure-使用Windows-Azure-co-located-Caching解決Session問題/","result":{"data":{"markdownRemark":{"frontmatter":{"title":"Windows Azure - 使用Windows Azure co-located Caching解決Session問題","date":"16 June 2012","author":"Sky Chang","excerpt":null,"tags":["ASP.NET","ASP.NET MVC","Azure"],"coverImage":null},"id":"1a284688-32df-5128-a35c-257b1b2df011","html":"<p>co-located Caching是新的Cache架構，不清楚的人可以看一下<a href=\"http://blog.sanc.idv.tw/2012/06/windows-azure-overview-of-caching-in.html\">這篇</a>。</p>\n<p>之前有寫過一篇\"<a href=\"http://blog.sanc.idv.tw/2012/04/windows-azure-windows-azure_21.html\">Windows Azure - 使用Windows Azure Storage解決Sessios問題</a>\"主要在講Windows Azure架構下Load Balance機制可能會讓Session抓不到的問題，而那篇的文章主要是使用Windows Azure Storage來解決問題，當然文中也講到，其實微軟官方也不建議使用Windows Azure Storage來解決，而今天隨著1.7的發佈，我們就使用新的Cache機制來解決吧。</p>\n<p>這次我們的範例，使用這篇\"<a href=\"http://blog.sanc.idv.tw/2012/05/aspnet-mvc-windows-azuretempdata.html\">ASP.NET MVC - 在Windows Azure使用TempData要小心!</a>\"的範例，其實沒看過的人也沒關係，因為這個機制，真的是簡單到爆掉XDD。</p>\n<h4>啟動Cache機制 ( 使用Co-located Role )</h4>\n<p>首先，我們在Azure專案底下，並且打開Role的設定，如下圖位置。</p>\n<p><a href=\"http://lh5.ggpht.com/-SGGtAWWPOHk/T9ts7MQ1q9I/AAAAAAAADM8/z9e8AWoagbQ/s1600-h/image3.png\"><img src=\"http://lh4.ggpht.com/-grwnFKS0lR0/T9ts8LIo98I/AAAAAAAADNE/voB_fQSdSqg/image_thumb1.png?imgmax=800\" alt=\"image\" title=\"image\"></a></p>\n<p>然後在Caching這邊，就可以啟動Caching設定 ( 於Enable Caching處打勾 )，我們這邊選擇使用Co-located Role，並且使用30%，另外，因為目前是本機進行測試，所以沒有特別選擇Windows Azure Storage，不然這邊也要選擇一下Windows Azure Storage ( 這裡會使用到Windows Azure Storage的原因是因為，每個Cache cluster會將runtime的資訊分享在Storage，所以這邊一定要設定 )，最後要注意一下Name的地方，預設是default，你也可以自己去命名，或是自己新增加一個設定，這邊的用意就像是讓Cache更有彈性。( 此外現在此機制是屬於Preview，要啟用此機制，也要先去<a href=\"http://www.windowsazure.com\">官網</a>申請Preview )</p>\n<p><a href=\"http://lh6.ggpht.com/-t8CTIKyYY_8/T9ts9NpmTCI/AAAAAAAADNM/sydI32yjTxY/s1600-h/image12.png\"><img src=\"http://lh3.ggpht.com/-WcPT4l2gC0s/T9ts-Mh3awI/AAAAAAAADNU/i8YxyC603U8/image_thumb6.png?imgmax=800\" alt=\"image\" title=\"image\"></a></p>\n<p>我們可以看到ServiceConfiguration.Local.cscfg增加了很多的東西，主要都是在設定Cache，不過小弟我還是喜歡在上面的界面修修改改=v=。</p>\n<pre class=\"brush: xml;\">&lt;?xml version=\"1.0\" encoding=\"utf-8\"?&gt;\n&lt;ServiceConfiguration serviceName=\"AzureAndMvcUseTempDataTest\" xmlns=\"http://schemas.microsoft.com/ServiceHosting/2008/10/ServiceConfiguration\" osFamily=\"1\" osVersion=\"*\" schemaVersion=\"2012-05.1.7\"&gt;\n  &lt;Role name=\"MvcWebRole1\"&gt;\n    &lt;Instances count=\"2\" /&gt;\n    &lt;ConfigurationSettings&gt;\n      &lt;Setting name=\"Microsoft.WindowsAzure.Plugins.Diagnostics.ConnectionString\" value=\"UseDevelopmentStorage=true\" /&gt;\n      &lt;Setting name=\"Microsoft.WindowsAzure.Plugins.Caching.NamedCaches\" value=\"{&amp;quot;caches&amp;quot;:[{&amp;quot;name&amp;quot;:&amp;quot;default&amp;quot;,&amp;quot;policy&amp;quot;:{&amp;quot;eviction&amp;quot;:{&amp;quot;type&amp;quot;:0},&amp;quot;expiration&amp;quot;:{&amp;quot;defaultTTL&amp;quot;:10,&amp;quot;isExpirable&amp;quot;:true,&amp;quot;type&amp;quot;:1},&amp;quot;serverNotification&amp;quot;:{&amp;quot;isEnabled&amp;quot;:false}},&amp;quot;secondaries&amp;quot;:0}]}\" /&gt;\n      &lt;Setting name=\"Microsoft.WindowsAzure.Plugins.Caching.Loglevel\" value=\"\" /&gt;\n      &lt;Setting name=\"Microsoft.WindowsAzure.Plugins.Caching.CacheSizePercentage\" value=\"30\" /&gt;\n      &lt;Setting name=\"Microsoft.WindowsAzure.Plugins.Caching.ConfigStoreConnectionString\" value=\"UseDevelopmentStorage=true\" /&gt;\n    &lt;/ConfigurationSettings&gt;\n  &lt;/Role&gt;\n&lt;/ServiceConfiguration&gt;\n</pre>\n<p>此外ServiceDefinition.csdef也有了改變，主要是多了import module=”Caching”這段，並且設定1G的本地儲存。</p>\n<pre class=\"brush: xml;\">&lt;?xml version=\"1.0\" encoding=\"utf-8\"?&gt;\n&lt;ServiceDefinition name=\"AzureAndMvcUseTempDataTest\" xmlns=\"http://schemas.microsoft.com/ServiceHosting/2008/10/ServiceDefinition\" schemaVersion=\"2012-05.1.7\"&gt;\n  &lt;WebRole name=\"MvcWebRole1\" vmsize=\"ExtraSmall\"&gt;\n    &lt;Sites&gt;\n      &lt;Site name=\"Web\"&gt;\n        &lt;Bindings&gt;\n          &lt;Binding name=\"Endpoint1\" endpointName=\"Endpoint1\" /&gt;\n        &lt;/Bindings&gt;\n      &lt;/Site&gt;\n    &lt;/Sites&gt;\n    &lt;Endpoints&gt;\n      &lt;InputEndpoint name=\"Endpoint1\" protocol=\"http\" port=\"80\" /&gt;\n    &lt;/Endpoints&gt;\n    &lt;Imports&gt;\n      &lt;Import moduleName=\"Diagnostics\" /&gt;\n      &lt;Import moduleName=\"Caching\" /&gt;\n    &lt;/Imports&gt;\n    &lt;LocalResources&gt;\n      &lt;LocalStorage name=\"Microsoft.WindowsAzure.Plugins.Caching.FileStore\" sizeInMB=\"1000\" cleanOnRoleRecycle=\"false\" /&gt;\n    &lt;/LocalResources&gt;\n  &lt;/WebRole&gt;\n&lt;/ServiceDefinition&gt;\n</pre>\n<p>到這邊就已經準備好了Cache機制</p>\n<h4>設定組態</h4>\n<p>接下來我們只需要在Web Role專案 ( 可能是ASP.NET或是ASP.NET MVC專案 )，使用管理NuGet套件。</p>\n<p><a href=\"http://lh4.ggpht.com/-y0Tb6f0XIvM/T9ts_BfURtI/AAAAAAAADNc/24hLS066RlU/s1600-h/image%25255B5%25255D.png\"><img src=\"http://lh4.ggpht.com/-uHVdgq5BdXM/T9ttAfc_OsI/AAAAAAAADNg/3Vl0jtcbbUw/image_thumb%25255B2%25255D.png?imgmax=800\" alt=\"image\" title=\"image\"></a></p>\n<p>然後從線上中尋找\"windowsazure.caching\"，並且安裝Windows Azure Caching Preview。</p>\n<p><a href=\"http://lh4.ggpht.com/-ZrPxRXPuo4g/T9ttBT_b9II/AAAAAAAADNs/meGxViwX9iM/s1600-h/image%25255B10%25255D.png\"><img src=\"http://lh4.ggpht.com/-cjC7NMarC9Y/T9ttCaNXykI/AAAAAAAADN0/L8088JtXeps/image_thumb%25255B5%25255D.png?imgmax=800\" alt=\"image\" title=\"image\"></a></p>\n<p>安裝完後，他會幫我們加上:</p>\n<ul>\n<li>Microsoft.ApplicationServer.Caching.Client.dll<li>Microsoft.ApplicationServer.Caching.Core.dll<li>Microsoft.WindowsFabric.Common.dll<li>Microsoft.WindowsFabric.Data.Common.dll</li>\n</ul>\n<p>這些dll，而如果你是使用ASP.NET，還會加上:</p>\n<ul>\n<li>Microsoft.Web.DistributedCache.dll</li>\n</ul>\n<p>如果想要手動添加，可以到這個目錄。</p>\n<p>C:\\Program Files\\Microsoft SDKs\\Windows Azure.NET SDK\\2012-06\\ref\\CachingPreview</p>\n<p>如果是使用NuGet，他也會自動在app.config或是web.config加上兩段，下面這段會加在&#x3C;configuration>之下。</p>\n<pre class=\"brush: xml;\">&lt;configSections&gt;\n  &lt;section name=\"dataCacheClients\"\n    type=\"Microsoft.ApplicationServer.Caching.DataCacheClientsSection, Microsoft.ApplicationServer.Caching.Core\"\n    allowLocation=\"true\"\n    allowDefinition=\"Everywhere\"/&gt;\n&lt;/configSections&gt;\n</pre>\n<p>和這段，也是加在&#x3C;/configuration>之下。</p>\n<pre class=\"brush: xml;\">&lt;dataCacheClients&gt;\n  &lt;tracing sinkType=\"DiagnosticSink\" traceLevel=\"Error\" /&gt;\n  &lt;dataCacheClient name=\"default\"&gt;\n    &lt;autoDiscover isEnabled=\"true\" identifier=\"[cache cluster role name]\" /&gt;\n    &lt;!--&lt;localCache isEnabled=\"true\" sync=\"TimeoutBased\" objectCount=\"100000\" ttlValue=\"300\" /&gt;--&gt;\n  &lt;/dataCacheClient&gt;\n&lt;/dataCacheClients&gt;\n</pre>\n<p>其中，上面那段程式碼，裡面有個\"[cache cluster role name]\"字串，這邊要特別注意，需要把這個字串改成你要使用Role的名稱，如下圖，我們就必須改成\"MvcWebRole1\"，這樣就可以了。( 記住，這[ ]兩個符號也要一併的替換掉喔! )。</p>\n<p><a href=\"http://lh5.ggpht.com/-SGGtAWWPOHk/T9ts7MQ1q9I/AAAAAAAADM8/z9e8AWoagbQ/s1600-h/image3.png\"><img src=\"http://lh4.ggpht.com/-grwnFKS0lR0/T9ts8LIo98I/AAAAAAAADNE/voB_fQSdSqg/image_thumb1.png?imgmax=800\" alt=\"image\" title=\"image\"></a></p>\n<p>所以會變成這樣，另外，如果有在最前面，有自己加了一個新的名稱，就必須在這邊把&#x3C;dataCacheClient name=”default”>裡面的default改為自己設定的名子。</p>\n<pre class=\"brush: xml;\">&lt;dataCacheClients&gt;\n    &lt;tracing sinkType=\"DiagnosticSink\" traceLevel=\"Error\" /&gt;\n    &lt;dataCacheClient name=\"default\"&gt;\n      &lt;autoDiscover isEnabled=\"true\" identifier=\"MvcWebRole1\" /&gt;\n      &lt;!--&lt;localCache isEnabled=\"true\" sync=\"TimeoutBased\" objectCount=\"100000\" ttlValue=\"300\" /&gt;--&gt;\n    &lt;/dataCacheClient&gt;\n&lt;/dataCacheClients&gt;\n</pre>\n<p>到這邊就完成了設定組態。</p>\n<h4>將ASP.NET的Session指向Cache</h4>\n<p>最後，我們在修改一下web.config，讓Session改成自訂，把這段加到&#x3C;system.web>之下就可以了，同樣的，如果有自行設定Cache的名字，也別忘了把dataCacheClientName的名稱改一下。</p>\n<pre class=\"brush: xml;\">&lt;sessionState mode=\"Custom\" customProvider=\"AppFabricCacheSessionStoreProvider\"&gt;\n  &lt;providers&gt;\n    &lt;add name=\"AppFabricCacheSessionStoreProvider\"\n          type=\"Microsoft.Web.DistributedCache.DistributedCacheSessionStateStoreProvider, Microsoft.Web.DistributedCache\"\n          cacheName=\"default\"\n          useBlobMode=\"true\"\n          dataCacheClientName=\"default\" /&gt;\n  &lt;/providers&gt;\n&lt;/sessionState&gt;\n</pre>\n<p>這樣就完成了，夠簡單吧。</p>\n<h4>參考資料</h4>\n<ul>\n<li><a href=\"http://www.windowsazure.com/en-us/develop/net/how-to-guides/cache/\" title=\"http://www.windowsazure.com/en-us/develop/net/how-to-guides/cache/\">http://www.windowsazure.com/en-us/develop/net/how-to-guides/cache/</a><li><a href=\"http://msdn.microsoft.com/en-us/library/hh914128\" title=\"http://msdn.microsoft.com/en-us/library/hh914128\">http://msdn.microsoft.com/en-us/library/hh914128</a></li>\n</ul>","excerpt":"co-located Caching是新的Cache架構，不清楚的人可以看一下這篇。 之前有寫過一篇\"Windows Azure - 使用Windows Azure Storage解決Sessios問題\"主要在講Windows Azure架構下Load Balance…"}},"pageContext":{"type":"posts","next":{"frontmatter":{"path":null,"title":"Windows Azure - Overview of Caching in Windows Azure","tags":["Azure"]},"fields":{"slug":"/2012/06/16/Windows-Azure-Overview-of-Caching-in-Windows-Azure/"},"fileAbsolutePath":"/home/runner/work/blog.sanc.idv.tw/blog.sanc.idv.tw/src/posts/blog.sanc.idv.tw/Windows-Azure-Overview-of-Caching-in-Windows-Azure.md"},"previous":{"frontmatter":{"path":null,"title":"Windows Azure - 使用Windows Azure Cache的Dedicated Caching解決Session問題","tags":["ASP.NET","ASP.NET MVC","Azure"]},"fields":{"slug":"/2012/06/20/Windows-Azure-使用Windows-Azure-Cache的Dedicated-Caching解決Session問題/"},"fileAbsolutePath":"/home/runner/work/blog.sanc.idv.tw/blog.sanc.idv.tw/src/posts/blog.sanc.idv.tw/Windows-Azure-使用Windows-Azure-Cache的Dedicated-Caching解決Session問題.md"}}}}