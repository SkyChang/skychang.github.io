{"componentChunkName":"component---src-templates-page-js","path":"/2012/05/09/ASP-NET-MVC-在Windows-Azure使用TempData要小心/","result":{"data":{"markdownRemark":{"frontmatter":{"title":"ASP.NET MVC -  在Windows Azure使用TempData要小心!","date":"09 May 2012","author":"Sky Chang","excerpt":null,"tags":["ASP.NET MVC","Azure"],"coverImage":null},"id":"ca4bd048-b405-5d6a-a986-6f982244e0b5","html":"<p>其實這篇是延續之前寫的\"<a href=\"http://blog.sanc.idv.tw/2012/04/windows-azure-windows-azure_21.html\">Windows Azure - 使用Windows Azure Storage解決Sessios問題</a>\"這個主題，前一篇提到Session在Windows Azure可能會遇到的問題 ( 如果口袋很深的話=v= )，而如果對於ASP.NET MVC比較熟的人，可能就會發現一件事情；沒錯，Session會遇到的問題，在ASP.NET MVC的TempData也會碰到，那是因為TempData是利用Session來進行實作 ( 但詳細的情況小弟我並沒有真的去翻原始碼認證，所以有錯也請告知 )，所以Session抓不到的問題，在ASP.NET MVC的TempData當然也會發生。</p>\n<p>同樣的，沒圖沒真相，我們還是稍微實驗一下吧。</p>\n<h4>開始實驗!</h4>\n<p>首先，整個專案的檔案大致是這樣，既然是要測試Windows Azure，所以當然要有Windows Azure的專案，然後也別忘了，要將Web Role設定兩個以上，如果只設一個，當然不會發生任何問題了；接下來，我們只利用一個HomeController就可以了；因為要切換頁面，所以我們要ˇ兩個View，一個就是Index，另外一個就是Index2。</p>\n<p><a href=\"http://lh6.ggpht.com/-9D2ikjMT_fo/T6pyFWT6m3I/AAAAAAAACeE/W1qPuMAVhIc/s1600-h/image%25255B4%25255D.png\"><img src=\"http://lh3.ggpht.com/-9bvEh5W-keo/T6pyGqQKDmI/AAAAAAAACeI/_thsXcggXn0/image_thumb%25255B2%25255D.png?imgmax=800\" alt=\"image\" title=\"image\"></a></p>\n<p>反正是本機模擬，執行個體開四個也沒差了，但千萬不要發布上去喔!</p>\n<p><a href=\"http://lh3.ggpht.com/-PRa-2iDqZc0/T6pyHaQbJLI/AAAAAAAACeQ/RzBAvGVoraY/s1600-h/image%25255B9%25255D.png\"><img src=\"http://lh3.ggpht.com/-yNpQGplWv9k/T6pyIZ2XoTI/AAAAAAAACec/f8rtD22QPU0/image_thumb%25255B5%25255D.png?imgmax=800\" alt=\"image\" title=\"image\"></a></p>\n<h4>HomeControl的程式碼</h4>\n<p>HomeControl的程式碼很簡單，我們在第一個View (Index)，設定了Session、ViewData、ViewBag、TempData來做測試，至於為什麼還要設定ViewData和ViewBag，那是因為小弟之前太蠢了，想說ViewData和ViewBag會不會也和TempData一樣有問題，當初還跑去問<a href=\"http://studyhost.blogspot.com/\">David老師</a>，只看到David老師一臉疑惑的看著我XDD；後來回到家裡仔細想想，其實ViewData和ViewBag當然不會有這個問題，理由很簡單，從Control到View這段，其實還在同一台機器上，所以自然不會有這種問題啊!! ( David老師對不起，問了蠢問題QQ )，所以這邊的ViewData和ViewBag看看就好..，其次，我們使用RoleEnvironment.CurrentRoleInstance.Id來取得目前Windows Azure的機器id，用來判斷是否不同台。</p>\n<pre class=\"brush: csharp;\">using System;\nusing System.Collections.Generic;\nusing System.Linq;\nusing System.Web;\nusing System.Web.Mvc;\nusing Microsoft.WindowsAzure.ServiceRuntime;\n\nnamespace MvcWebRole1.Controllers\n{\n    public class HomeController : Controller\n    {\n        //\n        // GET: /Home/\n\n        public ActionResult Index()\n        {\n            ViewBag.id = RoleEnvironment.CurrentRoleInstance.Id;\n            Session[\"Test\"] = \"Have Value\";\n            ViewData[\"Test\"] = \"Have Value\";\n            ViewBag.Test = \"Have Value\";\n            TempData[\"Test\"] = \"Have Value\";\n            return View();\n        }\n\n        public ActionResult Index2()\n        {\n            ViewBag.id = RoleEnvironment.CurrentRoleInstance.Id;\n            return View();\n        }\n    }\n}\n</pre>\n<p>這樣子Controller就寫好了，接下來我們來看看View。</p>\n<h4>Index的程式碼</h4>\n<p>Index裡面很簡單，就是把剛剛那個很糗的ViewData和ViewBag秀出來，基本上，是沒甚麼意義可言啦…，但是ViewBag.id就是有意義的，我們把剛剛抓到的Windows Azure機器id給Show出來，另外，我們最後面加上一個連結，準備連到另外一個View。</p>\n<pre class=\"brush: xml;\">@{\n    Layout = null;\n}\n\n&lt;!DOCTYPE html&gt;\n\n&lt;html&gt;\n&lt;head&gt;\n    &lt;meta name=\"viewport\" content=\"width=device-width\" /&gt;\n    &lt;title&gt;Index&lt;/title&gt;\n&lt;/head&gt;\n&lt;body&gt;\n&lt;h1&gt;@ViewBag.id&lt;/h1&gt;\n    &lt;div&gt;\n    Session:\n    @if(Session[\"Test\"] == null)\n    {\n        @:Session is null &lt;br /&gt;\n    }else\n    {\n        @Session[\"Test\"]; &lt;br /&gt;\n    }\n    ViewData:\n    @if (ViewData[\"Test\"] == null)\n    { \n        @:ViewData is null &lt;br /&gt;\n    }\n    else\n    { \n        @ViewData[\"Test\"]; &lt;br /&gt;\n    }\n    ViewBag\n    @if (ViewBag.Test == null)\n    { \n        @:ViewBag is null &lt;br /&gt;\n    }\n    else\n    { \n        @ViewBag.Test;&lt;br /&gt;\n    }\n\n    @Html.ActionLink(\"Next\", \"Index2\", \"Home\");\n    &lt;/div&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n</pre>\n<p>到這邊，第一個View就結束了，接下來，我們來看看Index2。</p>\n<h4>Index2的程式碼</h4>\n<p>接下來是Index2，我們把剛剛設定好的Session和TempData，Show出在Index2頁面，當然，這邊也要使用ViewBag.id來把Windows Azure上的機器id給Show出來。</p>\n<pre class=\"brush: xml;\">@{\n    Layout = null;\n}\n\n&lt;!DOCTYPE html&gt;\n\n&lt;html&gt;\n&lt;head&gt;\n    &lt;meta name=\"viewport\" content=\"width=device-width\" /&gt;\n    &lt;title&gt;Index2&lt;/title&gt;\n&lt;/head&gt;\n&lt;body&gt;\n    &lt;h1&gt;@ViewBag.id&lt;/h1&gt;\n    &lt;div&gt;\n    Session:\n    @if(Session[\"Test\"] == null)\n    {\n        @:Session is null &lt;br /&gt;\n    }else\n    {\n        @Session[\"Test\"]; &lt;br /&gt;\n        Session.Clear();\n    }\n    TempData:\n    @if (TempData[\"Test\"] == null)\n    {\n        @:TempData is null &lt;br /&gt;\n    }\n    else\n    {\n        @TempData[\"Test\"]; &lt;br /&gt;\n    }\n    &lt;/div&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n</pre>\n<p>這樣又完成了範例，接下來我們就執行看看。</p>\n<p>Run</p>\n<p>我們可以發現，目前是在編號1的Windows Azure之下，接下來，我們按下Next，看看下一頁會怎樣。</p>\n<p><a href=\"http://lh5.ggpht.com/-vPUx6PZ8f7E/T6pyKFme9aI/AAAAAAAACek/tthmEwWw_Zg/s1600-h/image%25255B14%25255D.png\"><img src=\"http://lh3.ggpht.com/-aIgsQ2hIMA0/T6pyLH4QKFI/AAAAAAAACes/d1dsxEcdZ80/image_thumb%25255B8%25255D.png?imgmax=800\" alt=\"image\" title=\"image\"></a></p>\n<p>到了第二頁，我們可以發現目前的id是0，也就是說和第一台是不同台，而這邊我們也可以發現Session是空的，而比較重要的是TempData也為空。</p>\n<p><a href=\"http://lh5.ggpht.com/-oRqohBcs_oo/T6pyMbOl9kI/AAAAAAAACe0/p_nPldEefU8/s1600-h/image%25255B19%25255D.png\"><img src=\"http://lh3.ggpht.com/-DWw6osIqF0U/T6pyNSpzYCI/AAAAAAAACe8/0-qRbPkg1zc/image_thumb%25255B11%25255D.png?imgmax=800\" alt=\"image\" title=\"image\"></a></p>\n<p>到這邊，實驗就算結束了。</p>\n<h4>後記</h4>\n<p>當然，這篇的用意是想提醒大家，使用ASP.NET MVC丟到Windows Azure的時候，使用TempData需要特別的注意，至於解法，可以參考<a href=\"http://blog.sanc.idv.tw/2012/04/windows-azure-windows-azure_21.html\">上一篇</a>喔。</p>","excerpt":"其實這篇是延續之前寫的\"Windows Azure - 使用Windows Azure Storage解決Sessios問題\"這個主題，前一篇提到Session在Windows Azure可能會遇到的問題 ( 如果口袋很深的話=v= )，而如果對於ASP.NET MVC…"}},"pageContext":{"type":"posts","next":{"frontmatter":{"path":null,"title":"SQL Azure - 使用SSIS將SQL Azure的資料複製到Local","tags":["Azure","SQL Server","Tools"]},"fields":{"slug":"/2012/04/22/SQL-Azure-使用SSIS將SQL-Azure的資料複製到Local/"},"fileAbsolutePath":"/home/runner/work/blog.sanc.idv.tw/blog.sanc.idv.tw/src/posts/blog.sanc.idv.tw/SQL-Azure-使用SSIS將SQL-Azure的資料複製到Local.md"},"previous":{"frontmatter":{"path":null,"title":"Silverlight -  繼承UserControl的作法","tags":["Silveright","WPF"]},"fields":{"slug":"/2012/05/09/Silverlight-繼承UserControl的作法/"},"fileAbsolutePath":"/home/runner/work/blog.sanc.idv.tw/blog.sanc.idv.tw/src/posts/blog.sanc.idv.tw/Silverlight-繼承UserControl的作法.md"}}}}