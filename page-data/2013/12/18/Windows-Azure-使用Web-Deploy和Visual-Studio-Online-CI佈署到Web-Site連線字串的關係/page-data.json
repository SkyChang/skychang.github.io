{"componentChunkName":"component---src-templates-page-js","path":"/2013/12/18/Windows-Azure-使用Web-Deploy和Visual-Studio-Online-CI佈署到Web-Site連線字串的關係/","result":{"data":{"markdownRemark":{"frontmatter":{"title":"Windows Azure -  使用Web Deploy和Visual Studio Online CI佈署到Web Site連線字串的關係","date":"18 December 2013","author":"Sky Chang","excerpt":null,"tags":["ASP.NET MVC","Azure","SQL Server","Visual Studio"],"coverImage":null},"id":"3b6500d2-d2f1-5a4b-bd4e-f22f9208c8f5","html":"<p>最近有空的時候，剛好在追一個小小的問題 ( 其實也不小，搞了好幾天釐清… )，這個問題主要是當使用Visual Studio Online搭配CI並使用從Web Site下載下來的Deploy檔案時，佈署到Web Site時，到底會使用哪個連線字串的實驗…</p>\n<p>原本使用CI、或是Deploy的時候是很單純的，但是兩個混再一起，就有一點點小麻煩了，所以既然實驗了，那就在這邊把紀錄記一下嚕…</p>\n<p>首先最單純的，如果使用Web Deploy，那我們可以從這邊去指定資料庫的連線字串變更，那這樣就算Web.config裡面的debug或是release沒寫甚麼，最後還是會改成如下圖的字串。</p>\n<p><a href=\"http://lh3.ggpht.com/-E_5IIbF4z30/UrG_3_F6iBI/AAAAAAAAIVo/zksoZtb2zl8/s1600-h/image%25255B9%25255D.png\"><img src=\"http://lh5.ggpht.com/-IzYTIMjnTGk/UrG_4nqZemI/AAAAAAAAIVw/9bKzbf6i0yU/image_thumb%25255B5%25255D.png?imgmax=800\" alt=\"image\" title=\"image\"></a></p>\n<p>所以佈署上去後，字串的確會變成如Web Deploy所設定的…</p>\n<p><a href=\"http://lh6.ggpht.com/-Fdp7LNJ6okA/UrG_5QnjDqI/AAAAAAAAIV4/wo-jzMWY8dQ/s1600-h/image%25255B13%25255D.png\"><img src=\"http://lh5.ggpht.com/-Co8MmfgASWs/UrG_6EUvM6I/AAAAAAAAIWA/eoc1KFnOxV0/image_thumb%25255B7%25255D.png?imgmax=800\" alt=\"image\" title=\"image\"></a></p>\n<p>那如果加上CI，並且在Web.config的debug和release加上連線字串的變更，會變成怎樣呢??</p>\n<p>首先，我們先來看看Web.Debug.config</p>\n<pre class=\"brush: xml;\">&lt;connectionStrings&gt;\n&lt;add name=\"ShihChanDBContext\"\n  connectionString=\"Data Source=tcp:web.debug.database.windows.net,1433;\"\n  xdt:Transform=\"SetAttributes\" xdt:Locator=\"Match(name)\"/&gt;\n&lt;/connectionStrings&gt;\n</pre>\n<p>然後是Web.Release.config</p>\n<pre class=\"brush: xml;\">&lt;connectionStrings&gt;\n&lt;add name=\"ShihChanDBContext\"\n  connectionString=\"Data Source=tcp:web.release.database.windows.net,1433;\"\n  xdt:Transform=\"SetAttributes\" xdt:Locator=\"Match(name)\"/&gt;\n&lt;/connectionStrings&gt;\n</pre>\n<p>當然，如果直接透過CI做佈署，沒透過Web Deploy當然沒甚麼問題，但我們這邊要對CI做設定，讓他使用Web Deploy。</p>\n<p><a href=\"http://lh3.ggpht.com/-5uCYDTr9-L4/UrG_62x6OjI/AAAAAAAAIWI/l4L_lSZVuBk/s1600-h/image%25255B18%25255D.png\"><img src=\"http://lh5.ggpht.com/-LbjLiQh37wI/UrG_7ubBrLI/AAAAAAAAIWQ/bvltW3RJW8Q/image_thumb%25255B10%25255D.png?imgmax=800\" alt=\"image\" title=\"image\"></a></p>\n<p>等待佈署完後，我們再重新檢查佈署出去的Web.config。</p>\n<p><a href=\"http://lh6.ggpht.com/-ZnfdBHYUA38/UrG_8J6M60I/AAAAAAAAIWU/oBu3aZlqhOk/s1600-h/image%25255B22%25255D.png\"><img src=\"http://lh4.ggpht.com/-BHApL9wIKZw/UrG_8hl4orI/AAAAAAAAIWg/3fe14IH4Eu8/image_thumb%25255B12%25255D.png?imgmax=800\" alt=\"image\" title=\"image\"></a></p>\n<p>是的，也還是l0這組，所以從這邊可以得知，我們改的Web.debug.config和Web.Release.config被覆蓋掉了。</p>\n<p>那真的被覆蓋掉了嗎??..我們現在針對Web.config重新拉一個connection string。</p>\n<pre class=\"brush: xml;\">&lt;add name=\"ShihChanDBContext\" connectionString=\"Data Source=(localdb)\\v11.0;Initial Catalog=ShihChanDB;Integrated Security=True;MultipleActiveResultSets=True\" providerName=\"System.Data.SqlClient\" /&gt;\n&lt;add name=\"ShihChanDBContext2\" connectionString=\"Data Source=(localdb)\\v11.0;Initial Catalog=ShihChanDB;Integrated Security=True;MultipleActiveResultSets=True\" providerName=\"System.Data.SqlClient\" /&gt;\n</pre>\n<p>然後Web.Debug.config為</p>\n<pre class=\"brush: xml;\">&lt;connectionStrings&gt;\n&lt;add name=\"ShihChanDBContext2\"\n  connectionString=\"Data Source=tcp:web.debug.database.windows.net,1433;\"\n  xdt:Transform=\"SetAttributes\" xdt:Locator=\"Match(name)\"/&gt;\n&lt;/connectionStrings&gt;\n</pre>\n<p>Web.Release.config為</p>\n<pre class=\"brush: xml;\">&lt;connectionStrings&gt;\n&lt;add name=\"ShihChanDBContext2\"\n  connectionString=\"Data Source=tcp:web.release.database.windows.net,1433;\"\n  xdt:Transform=\"SetAttributes\" xdt:Locator=\"Match(name)\"/&gt;\n&lt;/connectionStrings&gt;\n</pre>\n<p>我們來看看最後產出的結果是…嗯…圖有點小…但基本上，第一組Connection String是Web Deploy所設定的，而第二組的Connection String則是從Web.Debug.config來的；所以我們可以確定Web Deploy的設定會蓋掉Web.config的設定。</p>\n<p><a href=\"http://lh3.ggpht.com/-AfmOyMhZv-w/UrG_9Wxki0I/AAAAAAAAIWo/AtakLhu5wnI/s1600-h/image%25255B26%25255D.png\"><img src=\"http://lh6.ggpht.com/--nbtBewo8gY/UrG_-CYccWI/AAAAAAAAIWs/w0yNhXcHI4o/image_thumb%25255B14%25255D.png?imgmax=800\" alt=\"image\" title=\"image\"></a></p>\n<p>嗯，等等，眼尖的你發現了嗎??..他替換的是Web.Debug.config而不是Web.Release.config，但我們第一張圖所設定的組態是Release阿!!!!?</p>\n<p><a href=\"http://lh6.ggpht.com/-VGzc2ku1MWo/UrG_-qQiKiI/AAAAAAAAIW4/z08xpIkSwKQ/s1600-h/image%25255B31%25255D.png\"><img src=\"http://lh6.ggpht.com/-p9mS9BXoqxw/UrG__PWwzwI/AAAAAAAAIXA/jFQ9v3Pd5mc/image_thumb%25255B17%25255D.png?imgmax=800\" alt=\"image\" title=\"image\"></a></p>\n<p>是的，這是第二個坑…雖然Web Deploy設定的是Release，但實際上CI不會吃到這個設定，而是會依據CI上的設定；CI上預設是空的，所以預設是使用Debug模式…</p>\n<p><a href=\"http://lh4.ggpht.com/-O2BeuQps6So/UrG__72nDfI/AAAAAAAAIXI/YON6u7cUE1A/s1600-h/image%25255B36%25255D.png\"><img src=\"http://lh6.ggpht.com/-Pb8nGLpaC2o/UrHAAtDKo9I/AAAAAAAAIXQ/XyIJzzXnpcs/image_thumb%25255B20%25255D.png?imgmax=800\" alt=\"image\" title=\"image\"></a></p>\n<p>其實我們也可以從佈署成功的畫面看到</p>\n<p><a href=\"http://lh3.ggpht.com/-Zpc-XsNIOLk/UrHABR3sMwI/AAAAAAAAIXY/zXMAxMnF8fg/s1600-h/image%25255B40%25255D.png\"><img src=\"http://lh3.ggpht.com/-FBV_skTl4JU/UrHACEXthLI/AAAAAAAAIXg/xZ_WAt4FK3k/image_thumb%25255B22%25255D.png?imgmax=800\" alt=\"image\" title=\"image\"></a></p>\n<p>那如果要改成Release呢??就只能從CI那邊下手了。</p>\n<p><a href=\"http://lh6.ggpht.com/-zyQGST6N4u0/UrHAC_C5lsI/AAAAAAAAIXk/rki3eNZY4Dc/s1600-h/image%25255B45%25255D.png\"><img src=\"http://lh3.ggpht.com/-IasF_MIL5SM/UrHADf7wptI/AAAAAAAAIXs/HiBhz35PRKg/image_thumb%25255B25%25255D.png?imgmax=800\" alt=\"image\" title=\"image\"></a></p>\n<p>發行後，我們就可以看到已經正確的替換成Release了…</p>\n<p><a href=\"http://lh5.ggpht.com/-G9Aj3RpiqGM/UrHAEC0P7CI/AAAAAAAAIX4/ImECIKwd7Sg/s1600-h/image%25255B49%25255D.png\"><img src=\"http://lh3.ggpht.com/-hl_oATBBv8g/UrHAE2xGyLI/AAAAAAAAIX8/SOmF1JXbe1s/image_thumb%25255B27%25255D.png?imgmax=800\" alt=\"image\" title=\"image\"></a></p>\n<p>大致上就這樣，所以設定的時候要小心啊QQ…</p>","excerpt":"最近有空的時候，剛好在追一個小小的問題 ( 其實也不小，搞了好幾天釐清… )，這個問題主要是當使用Visual Studio Online搭配CI並使用從Web Site下載下來的Deploy檔案時，佈署到Web Site時，到底會使用哪個連線字串的實驗… 原本使用CI…"}},"pageContext":{"type":"posts","next":{"frontmatter":{"path":null,"title":"Windows Azure -  與Visual Studio Online連線時，找不到AzureContinuousDeployment.11.xaml檔案","tags":["Azure","TFS"]},"fields":{"slug":"/2013/12/13/Windows-Azure-與Visual-Studio-Online連線時，找不到AzureContinuousDeployment-11-xaml檔案/"},"fileAbsolutePath":"/home/runner/work/blog.sanc.idv.tw/blog.sanc.idv.tw/src/posts/blog.sanc.idv.tw/Windows-Azure-與Visual-Studio-Online連線時，找不到AzureContinuousDeployment-11-xaml檔案.md"},"previous":{"frontmatter":{"path":null,"title":"CSS - Structural Pseudo-Classes 的nth-of-type和nth-child","tags":["CSS"]},"fields":{"slug":"/2013/12/27/CSS-Structural-Pseudo-Classes-的nth-of-type和nth-child/"},"fileAbsolutePath":"/home/runner/work/blog.sanc.idv.tw/blog.sanc.idv.tw/src/posts/blog.sanc.idv.tw/CSS-Structural-Pseudo-Classes-的nth-of-type和nth-child.md"}}}}