{"componentChunkName":"component---src-templates-page-js","path":"/2013/06/17/SQL-Server-神奇又好用的File-Table/","result":{"data":{"markdownRemark":{"frontmatter":{"title":"SQL Server -  神奇又好用的File Table","date":"17 June 2013","author":"Sky Chang","excerpt":null,"tags":["SQL Server"],"coverImage":null},"id":"8d81814b-ec36-573d-9c2a-5bf31782212a","html":"<p>老實說，完全沒想到，會寫到SQL Server的這個功能，也多虧了公司內，強大的DBA同事Winnie，和神人<a href=\"http://byronhu.wordpress.com/\">百敬老師</a>的一步一步指導，所以就在這邊紀錄一下，不然根據小弟的老人痴呆，大概過幾天就忘記了吧- -…</p>\n<p>但是開始前，還是要敘述一下，甚麼是File Table，是的，顧名思義，就是存放檔案的Table，但存放的不是超級大的二進位檔案，而是這個檔案的資料，例如，檔名等資訊。</p>\n<p>不過就只存放這些東西，好像也沒甚麼大不了的?，但File Table真正神奇的是，它可以和目錄去做關聯!!是的，簡單的說，就是某個路徑下，存放了某個檔案後，Table就會自動新增這筆資料，如果砍掉，這筆資料就會自動消失!!</p>\n<p>沒錯，就是這樣的神奇，所以，基於小弟要朝向\"潮\"的型男之路邁進，所以決定嘗試一下這個很\"潮\"的技術…</p>\n<p>首先，開始前先提醒大家，目前LocalDB是不支援此功能的，如有興趣，可以裝SQL Server 2012的正式版本，或是SQL Server 2012 Express，目前小弟是裝Express版本。</p>\n<p>如果是第一次安裝，其實可以看到FILESTREAM，預設是沒有安裝的，其實File Table底層就是FILESTREAM，如果這邊不知道該怎麼輸入，也可以先略過，未來再開啟。</p>\n<p><a href=\"http://lh3.ggpht.com/-Gk_nQUrCuFc/Ub8xxBU7kGI/AAAAAAAAGOk/ygfDnY3gqrY/s1600-h/image%25255B4%25255D.png\"><img src=\"http://lh4.ggpht.com/-inKlPO95WkM/Ub8xx_n1SkI/AAAAAAAAGOs/ysuJTjiZktE/image_thumb%25255B1%25255D.png?imgmax=800\" alt=\"image\" title=\"image\"></a></p>\n<p>當裝完後，要使用File Table，就一定要打開FILESTREAM，要打開FILESTREAM就必須先打開SQL Server組態管理員(如下圖)，其中最後面允許遠端存取，通常都會打勾，但下圖沒截到圖，所以這邊提醒一下大家。另外要注意的是windows共用名稱，這個名稱未來會變成目錄結構之一，所以也在這邊提醒大家一下。</p>\n<p><a href=\"http://lh4.ggpht.com/-VFz3jNzmBp4/Ub8xy5gB4sI/AAAAAAAAGO0/oSIEuuciVxQ/s1600-h/image%25255B8%25255D.png\"><img src=\"http://lh5.ggpht.com/-97njx5YBgJg/Ub8xzslDsnI/AAAAAAAAGO8/1CMWevdRcLM/image_thumb%25255B3%25255D.png?imgmax=800\" alt=\"image\" title=\"image\"></a></p>\n<p>接下來，用SSMS登入後，我們要執行一下如下指令。</p>\n<pre class=\"brush: sql;\">EXEC sp_configure filestream_access_level, 2 \nRECONFIGURE\n</pre>\n<p>完成如下圖，完成之後，我們再重新開一下SQL Server。</p>\n<p><a href=\"http://lh3.ggpht.com/-ML282Tvz1Rs/Ub8x0eZSxAI/AAAAAAAAGPE/9c3lqWhJrIc/s1600-h/image%25255B12%25255D.png\"><img src=\"http://lh3.ggpht.com/-xUOev_r1n_g/Ub8x1YqW_DI/AAAAAAAAGPM/nLGWxxwX2_s/image_thumb%25255B5%25255D.png?imgmax=800\" alt=\"image\" title=\"image\"></a></p>\n<p>接下來，我們要用SSMS來進行設定，我們先選擇我們這台SQL Server，並且設定伺服器屬性，先去如下圖的位置，確定FILESTREAM存取權限是否已啟用完整存取。</p>\n<p><a href=\"http://lh3.ggpht.com/-oVJdx5KFiiM/Ub8x24qAfnI/AAAAAAAAGPU/2X7XK2VQilM/s1600-h/image%25255B16%25255D.png\"><img src=\"http://lh6.ggpht.com/-XdgmgJ0mTZ8/Ub8x3jGgz9I/AAAAAAAAGPc/ZmLdUyGo-90/image_thumb%25255B7%25255D.png?imgmax=800\" alt=\"image\" title=\"image\"></a></p>\n<p>SQL Server設定完後，我們要針對要執行的DB，進行設定，以下圖，我們要針對Test的db進行設定。我們這邊要設定檔案群組。</p>\n<p><a href=\"http://lh4.ggpht.com/-7MAusU_AvmU/Ub8x4eNfTkI/AAAAAAAAGPk/irkCgm0ypUo/s1600-h/image%25255B20%25255D.png\"><img src=\"http://lh3.ggpht.com/-1z_e3vZAtf0/Ub8x5f_OVjI/AAAAAAAAGPs/wyIGxGLKoY0/image_thumb%25255B9%25255D.png?imgmax=800\" alt=\"image\" title=\"image\"></a></p>\n<p>設定完檔案群組後，我們要繼續設定檔案的部分。我們要新增一個FILESTREAM的檔案。</p>\n<p><a href=\"http://lh5.ggpht.com/-VQVIt8_gl5M/Ub8x6F0dEcI/AAAAAAAAGP0/Ic0wwy7itZQ/s1600-h/image%25255B24%25255D.png\"><img src=\"http://lh5.ggpht.com/-wZ6-TxtlWYs/Ub8x68TOIII/AAAAAAAAGP8/d1YK3qVAYD0/image_thumb%25255B11%25255D.png?imgmax=800\" alt=\"image\" title=\"image\"></a></p>\n<p>接下來，我們再到選項的地方，我們要填入FILESTREAM目錄名稱，並且把FILESTREAM非交易式存取設定為Full，這樣才能讓檔案總管來存取，如果沒有設定Full，就只能透過SQL Server來進行檔案的存取，但透過SQL Server進行檔案的存取，其實是會消耗SQL Server的IO的，所以沒有特別需要，還是利用檔案總管來存取比較好；其次，目錄名稱也請特別注意，這個部分未來也會形成存取檔案的目錄結構之一。</p>\n<p><a href=\"http://lh4.ggpht.com/-u_Rl9dlnbZc/Ub8x7uJuh6I/AAAAAAAAGQE/A93gm9ZTD-M/s1600-h/image%25255B29%25255D.png\"><img src=\"http://lh6.ggpht.com/-oaEgI_aNLGA/Ub8x8cdl9PI/AAAAAAAAGQM/tpPGdiY0A5A/image_thumb%25255B14%25255D.png?imgmax=800\" alt=\"image\" title=\"image\"></a></p>\n<p>最後，我們就使用T-SQL語法來建立File Table。</p>\n<p><a href=\"http://lh6.ggpht.com/-rnhhQzwSF9M/Ub8x9DDW5sI/AAAAAAAAGQU/Aawlf2lD_Lk/s1600-h/image%25255B33%25255D.png\"><img src=\"http://lh4.ggpht.com/-FDXlwLdF0o8/Ub8x9wj1aeI/AAAAAAAAGQc/AeYM_eXds-E/image_thumb%25255B16%25255D.png?imgmax=800\" alt=\"image\" title=\"image\"></a></p>\n<p>當然，他會產生一長串的T-SQL如下圖，我們只要稍微編修一下。</p>\n<p><a href=\"http://lh6.ggpht.com/-_oBZ0DX583o/Ub8x-jZQbOI/AAAAAAAAGQk/3u-aMmKWCF4/s1600-h/image%25255B37%25255D.png\"><img src=\"http://lh3.ggpht.com/-NPfTB2Gxxq0/Ub8x_Z_izpI/AAAAAAAAGQs/8j7x17cXOII/image_thumb%25255B18%25255D.png?imgmax=800\" alt=\"image\" title=\"image\"></a></p>\n<p>編修後的Code如下，基本上，比較需要注意的是FILETABLE_DIRECTORY的這個設定，這個設定也會牽涉到目錄結構，如果大家對其他語法有不懂的，底下的參考連結有MSDN的網址，大家可以去看看喔。</p>\n<pre class=\"brush: sql;\">-- =========================================\n-- Create FileTable template\n-- =========================================\nUSE Test\nGO\n\nIF OBJECT_ID('dbo.FileTable', 'U') IS NOT NULL\n  DROP TABLE dbo.FileTable\nGO\n\nCREATE TABLE dbo.FileTable AS FILETABLE\n  WITH\n  (\n    FILETABLE_DIRECTORY = 'FS',\n    FILETABLE_COLLATE_FILENAME = database_default\n  )\nGO\n</pre>\n<p>建立完成後，就會看到新的Table了。</p>\n<p><a href=\"http://lh5.ggpht.com/-XM8csQ7-IXo/Ub8yAJG1aoI/AAAAAAAAGQ0/ZL5TEgo3zAY/s1600-h/image%25255B41%25255D.png\"><img src=\"http://lh5.ggpht.com/-EtLMHel8oBs/Ub8yAxbiNhI/AAAAAAAAGQ8/t5RJU-A-9Rs/image_thumb%25255B20%25255D.png?imgmax=800\" alt=\"image\" title=\"image\"></a></p>\n<p>最後，我們只要用檔案總管，就可以來新增檔案；這時候，大家可以發現，必須要用網路芳鄰的方式來存取檔案，而這個路徑，就是我們一路設定過來的路徑名稱。</p>\n<p><a href=\"http://lh5.ggpht.com/-DY2sZpwm_Kc/Ub8yBo77djI/AAAAAAAAGRE/qaF6W9HXW2s/s1600-h/image%25255B45%25255D.png\"><img src=\"http://lh6.ggpht.com/-Xc5ZT6GBX1Y/Ub8yCXYtc4I/AAAAAAAAGRM/UPcTBg7vrMw/image_thumb%25255B22%25255D.png?imgmax=800\" alt=\"image\" title=\"image\"></a></p>\n<p>最後，如果我們在這個資料夾，新增一個txt檔案，再回到Table裡面去看，我們可以發現，Table已經同步更新了喔!!</p>\n<p><a href=\"http://lh6.ggpht.com/-6OX1l67mUwA/Ub8yDPWqkKI/AAAAAAAAGRU/GnRwwqB_Qsk/s1600-h/image%25255B49%25255D.png\"><img src=\"http://lh4.ggpht.com/-5BKvPj1FRxE/Ub8yDxWR5MI/AAAAAAAAGRc/uHENJwRZct0/image_thumb%25255B24%25255D.png?imgmax=800\" alt=\"image\" title=\"image\"></a></p>\n<p>此外，如果我們從資料庫刪除了此筆資料，那檔案也會同步不見喔!!有沒有超級方便的!?</p>\n<p>到這邊就完成了，當然，除了透過檔案總管外，也可以透過資料庫來存取資料，如果想知道更詳細的作法，可以參考MSDN喔!!</p>\n<h4>後記</h4>\n<p>還是要感謝老師們，不捨棄我的教我一步一步完成QQ…</p>\n<h4>參考資料</h4>\n<ul>\n<li><a href=\"http://msdn.microsoft.com/zh-tw/library/cc645923.aspx\" title=\"http://msdn.microsoft.com/zh-tw/library/cc645923.aspx\">http://msdn.microsoft.com/zh-tw/library/cc645923.aspx</a></li>\n<li><a href=\"http://msdn.microsoft.com/zh-tw/library/gg509088.aspx\" title=\"http://msdn.microsoft.com/zh-tw/library/gg509088.aspx\">http://msdn.microsoft.com/zh-tw/library/gg509088.aspx</a></li>\n<li><a href=\"http://beyondrelational.com/modules/2/blogs/28/posts/10370/filestream-error-default-filestream-filegroup-is-not-available-in-database-quotdbnamequot.aspx\" title=\"http://beyondrelational.com/modules/2/blogs/28/posts/10370/filestream-error-default-filestream-filegroup-is-not-available-in-database-quotdbnamequot.aspx\">http://beyondrelational.com/modules/2/blogs/28/posts/10370/filestream-error-default-filestream-filegroup-is-not-available-in-database-quotdbnamequot.aspx</a></li>\n</ul>","excerpt":"老實說，完全沒想到，會寫到SQL Server的這個功能，也多虧了公司內，強大的DBA同事Winnie，和神人百敬老師的一步一步指導，所以就在這邊紀錄一下，不然根據小弟的老人痴呆，大概過幾天就忘記了吧- -… 但是開始前，還是要敘述一下，甚麼是File Table…"}},"pageContext":{"type":"posts","next":{"frontmatter":{"path":null,"title":"Entity Framework - 使用Code First模式 Ver 5.0","tags":["ASP.NET MVC","Entity Framework","SQL Server"]},"fields":{"slug":"/2013/05/30/Entity-Framework-使用Code-First模式-Ver-5-0/"},"fileAbsolutePath":"/home/runner/work/blog.sanc.idv.tw/blog.sanc.idv.tw/src/posts/blog.sanc.idv.tw/Entity-Framework-使用Code-First模式-Ver-5-0.md"},"previous":{"frontmatter":{"path":null,"title":"Scrum - 台灣第一次的敏捷國際研討會","tags":["Scrum","TFS"]},"fields":{"slug":"/2013/06/23/Scrum-台灣第一次的敏捷國際研討會/"},"fileAbsolutePath":"/home/runner/work/blog.sanc.idv.tw/blog.sanc.idv.tw/src/posts/blog.sanc.idv.tw/Scrum-台灣第一次的敏捷國際研討會.md"}}}}