{"componentChunkName":"component---src-templates-page-js","path":"/2013/04/02/Windows-Azure-在Cloud-Service中，使用多個Instance會導致IIS-Express錯誤/","result":{"data":{"markdownRemark":{"frontmatter":{"title":"Windows Azure - 在Cloud Service中，使用多個Instance會導致IIS Express錯誤","date":"02 April 2013","author":"Sky Chang","excerpt":null,"tags":["Azure","IIS","Visual Studio"],"coverImage":null},"id":"9e1f6c10-9973-5277-acef-240a88bb4393","html":"<p>這個問題，卡了我超級無敵久，可以說從去年12月開始，就出現了這個問題，直到最近，才終於請Microsoft的CSS部門的<a href=\"http://nettecharticles.blogspot.tw/\">Michael</a>幫忙解決…</p>\n<p>至於為什麼會發生這個問題，老實說，也沒辦法還原了，只能歸咎，可能因為平常裝了太多測試版本的東西而導致。</p>\n<p>這個錯誤大致上是這樣子的，平常我們在本地端使用Cloud Serivce開發時，會啟用IIS Express並帶起模擬器，平常使用都沒問題，但當我們啟用超過一個instance的時候就會發生錯誤；如下圖設定時，再啟用模擬器的時候，就會發生錯誤。</p>\n<p><a href=\"http://lh6.ggpht.com/-Pm0IxfhQkWs/UVrhBcJumaI/AAAAAAAAF68/x4B72FThWtU/s1600-h/image%25255B3%25255D.png\"><img src=\"http://lh4.ggpht.com/-Eu5rNB-e0qQ/UVrhCPDpAoI/AAAAAAAAF7E/rMu3gVUmttQ/image_thumb%25255B1%25255D.png?imgmax=800\" alt=\"image\" title=\"image\"></a></p>\n<p>當設定一個instance以上，並啟用偵錯的時候，正常應該是開開心心的看到模擬器起來，但這次的問題就是，模擬器雖然起來了，但是IIS Express報錯了…</p>\n<p>會出現 IIS Express Worker Process 已經停止運作…然後任何的錯誤訊息都不給我 ( 翻 )。</p>\n<p><a href=\"http://lh6.ggpht.com/-7sWGM1jSd8A/UVrhCus1q3I/AAAAAAAAF7M/wJPj1ZWy6RA/s1600-h/IIS%252520Express%252520Work%252520Process%252520Error%25255B4%25255D.jpg\"><img src=\"http://lh3.ggpht.com/-HKaO07-G6w8/UVrhDUwnRiI/AAAAAAAAF7U/kqAZl-3-YLs/IIS%252520Express%252520Work%252520Process%252520Error_thumb%25255B2%25255D.jpg?imgmax=800\" alt=\"IIS Express Work Process Error\" title=\"IIS Express Work Process Error\"></a></p>\n<p>當然，這個過程，其實也找了很久，而且如果開模擬器來看，也會發現兩個Role阿，很正常啊。</p>\n<p><a href=\"http://lh3.ggpht.com/-ojon095NXaQ/UVrhEKmovAI/AAAAAAAAF7c/WYYlGTbATgw/s1600-h/Azure%252520Computer%25255B4%25255D.jpg\"><img src=\"http://lh5.ggpht.com/-GmsCmSDhM2s/UVrhFJt61EI/AAAAAAAAF7k/Yuu0Iv0ItyQ/Azure%252520Computer_thumb%25255B2%25255D.jpg?imgmax=800\" alt=\"Azure Computer\" title=\"Azure Computer\"></a></p>\n<p>但實際上，如果有真的去測試，會發現，只會進到一台Role，死都不會進入到另外一台Role…後來抽絲剝繭，終於發現一個明顯的錯誤，如下圖；我們可以發現，原本啟用兩個Instance，應該會出現兩個站台才對，但這邊才出現一個站台。</p>\n<p><a href=\"http://lh3.ggpht.com/-xaB14zQauPU/UVrhF6p1sVI/AAAAAAAAF7s/-eFmyIwUpuw/s1600-h/IIS%252520IP%252520Error%25255B7%25255D.jpg\"><img src=\"http://lh6.ggpht.com/-YobcOTNPp8c/UVrhGn35iNI/AAAAAAAAF70/P0Bva2rEoq8/IIS%252520IP%252520Error_thumb%25255B3%25255D.jpg?imgmax=800\" alt=\"IIS IP Error\" title=\"IIS IP Error\"></a></p>\n<p>或許這樣感覺不出來，所以我用Azure的VM，建立了一台正常的機器來比對；如以下兩張圖…可以發現到甚麼!?嗯，沒錯，第一個是少了站台，第二個是IP位置不同!!?</p>\n<p><a href=\"http://lh4.ggpht.com/-4j4apY8RbzY/UVrhHSFMNXI/AAAAAAAAF78/ODUejzrBigo/s1600-h/IIP%252520IP%252520Correct%2525201%25255B4%25255D.jpg\"><img src=\"http://lh3.ggpht.com/-m-ILa356SwI/UVrhIP1ggXI/AAAAAAAAF8E/rhjDDfoY5JU/IIP%252520IP%252520Correct%2525201_thumb%25255B2%25255D.jpg?imgmax=800\" alt=\"IIP IP Correct 1\" title=\"IIP IP Correct 1\"></a></p>\n<p><a href=\"http://lh5.ggpht.com/-xeIJsaW5bt8/UVrhIiOgOKI/AAAAAAAAF8M/w09hizBsFS4/s1600-h/IIP%252520IP%252520Correct%2525202%25255B7%25255D.jpg\"><img src=\"http://lh4.ggpht.com/-rVSKG38nnI8/UVrhJpR3yCI/AAAAAAAAF8U/RURJWuzZep0/IIP%252520IP%252520Correct%2525202_thumb%25255B3%25255D.jpg?imgmax=800\" alt=\"IIP IP Correct 2\" title=\"IIP IP Correct 2\"></a></p>\n<p>當然，我產生的第一個疑問是，為什麼正常的機器上，IP位置是127.255.0.0和127.255.0.1，後來查了文發現，原來現在的Azure SDK已經改成127.255.0.0和127.255.0.1的方式來區分不同的站台，而非以前用port來區分 ( 據說是1.5就改了，完全沒注意阿= =||| )；另外，雖然站台的ip不同，但瀏覽器還是會顯示出127.0.0.1。</p>\n<p>當發現這個問題，當然就是又驚又喜，想說已經查出問題，可以解決了，但實際上，根本沒那麼簡單QQ…</p>\n<p>找到這個問題後，小弟我第一個想到的就是，既然是IIS Express的問題，那能不能從Visual Studio的建置過程Log，查到一點蛛絲馬跡，結果翻到眼睛快脫窗，終於找到這行，下圖可能沒有全部擷取到畫面，但細節大概是這樣。</p>\n<blockquote>\n<p>Starting process 'C:\\Program Files (x86)\\Microsoft Visual Studio 11.0\\Common7\\IDE\\Extensions\\Microsoft\\Windows Azure Tools\\v1.8\\Debugger\\WindowsAzureDebugger.exe' with arguments '\"C:\\Program Files\\IIS Express\\iisexpress.exe\" /trace:error /config:\"C:\\Users\\San.Sky\\AppData\\Local\\dftmp\\Resources\\6413450b-a6af-4534-a5ae-9b3775b20072\\temp\\temp\\RoleTemp\\applicationHost.config\" /site:\"deployment18(23).WindowsAzure1.MvcWebRole1<em>IN</em>0<em>Web\"'...\n'WaIISHost.exe' (Managed (v4.0.30319)): 已載入 'C:\\Windows\\Microsoft.Net\\assembly\\GAC</em>MSIL\\System.Net.Http\\v4.0<em>4.0.0.0__b03f5f7f11d50a3a\\System.Net.Http.dll'，並略過載入符號。模組已最佳化，並已啟用 [Just My Code] 偵錯工具選項。\nStarting process 'C:\\Program Files (x86)\\Microsoft Visual Studio 11.0\\Common7\\IDE\\Extensions\\Microsoft\\Windows Azure Tools\\v1.8\\Debugger\\WindowsAzureDebugger.exe' with arguments '\"C:\\Program Files\\IIS Express\\iisexpress.exe\" /trace:error /config:\"C:\\Users\\San.Sky\\AppData\\Local\\dftmp\\Resources\\4ef06da0-aee0-46cc-a10b-3fa06f73b6ef\\temp\\temp\\RoleTemp\\applicationHost.config\" /site:\"deployment18(23).WindowsAzure1.MvcWebRole1</em>IN<em>1</em>Web\"'... </p>\n</blockquote>\n<p><a href=\"http://lh6.ggpht.com/-fjFcIoygkd8/UVrhKfEi25I/AAAAAAAAF8c/cEKlF2M5biI/s1600-h/%25255B3%25255D.jpg\"><img src=\"http://lh4.ggpht.com/-FI_FCOk_Qrk/UVrhLNOhbWI/AAAAAAAAF8k/wBpEk9C3ltg/_thumb%25255B1%25255D.jpg?imgmax=800\" alt=\"偵錯\" title=\"偵錯\"></a></p>\n<p>所以可以上面看到，IIS Express的建置指令… ( Orz…也順便把IIS Express的建置過程給學會了… )；而也從這邊看到，IIS Express的設定檔位置。</p>\n<p>所以繼續追進去，把裡面的一些log看過一遍 ( 眼睛又脫窗了一次… )，這次，終於發現，設定檔有錯誤了!!如下圖。</p>\n<p><a href=\"http://lh3.ggpht.com/-Xu-qUCgF3dQ/UVrhL7ENPBI/AAAAAAAAF8s/UG5eLfg14Nw/s1600-h/applicationHost%252520Error%25255B4%25255D.jpg\"><img src=\"http://lh4.ggpht.com/-ReQd3NrTnQQ/UVrhMu_zSMI/AAAAAAAAF80/BlI-0LHNEVg/applicationHost%252520Error_thumb%25255B2%25255D.jpg?imgmax=800\" alt=\"applicationHost Error\" title=\"applicationHost Error\"></a></p>\n<p>正確的應該是長這樣。</p>\n<p><a href=\"http://lh6.ggpht.com/-zLGQXq6gBIY/UVrhNnZ9QSI/AAAAAAAAF88/YbPbEVCmwAM/s1600-h/applicationHost%252520Correct%25255B3%25255D.jpg\"><img src=\"http://lh4.ggpht.com/-0eVlkUIgfwM/UVrhOZ_MAoI/AAAAAAAAF9E/2VSf6jR_TIQ/applicationHost%252520Correct_thumb%25255B1%25255D.jpg?imgmax=800\" alt=\"applicationHost Correct\" title=\"applicationHost Correct\"></a></p>\n<p>燈燈燈，所以可以發現，是在建置過程中，產生的設定檔發生錯誤；而為了證實，真的是這個設定檔的問題，我還把整個產生出的IIS Express設定拷貝一份，並且重新用IIS Express來Run一次，結果發現是可以的!!</p>\n<p>後來我又把錯誤的設定檔用IIS Express跑一次，就產生了IIS Express的錯誤，所以，真正發生錯誤的點就是IIS Express的設定檔，而原因就是<font color=\"#ff0000\">因為兩個站台用到同樣的IP和Port</font>!! ( 我要用紅色字，代表我的激動XDD )。</p>\n<p>所以我們來整理一下發生錯誤的原因，當Visual Studio開始偵錯的時候，會產生給IIS Express用的兩個設定檔，而不知道甚麼原因，設定檔的內容，都是指向port 81和localhost，所以用一個Instance起得來，但用兩個Instance，就會因為IP和Port相衝，而產生錯誤!!!</p>\n<p>好，知道原因後，我懷疑是不是Azure SDK封裝Cloud Service的問題，但經過測試，和移到正常的機器測試等等，都沒有問題；所以可想而知!!!!</p>\n<p>是的…我卡關了XDDDD</p>\n<p>後來也是過了好幾個月後，問了<a href=\"http://nettecharticles.blogspot.tw/\">Michael</a>，後來<a href=\"http://nettecharticles.blogspot.tw/\">Michael</a>也查到一些資料，解法是要註冊碼去改值</p>\n<blockquote>\n<p>HKEY<em>LOCAL</em>MACHINE\\SOFTWARE\\Wow6432Node\\Microsoft\\DevDiv\\vs\\Servicing\\10.0\\SP的值改為10。 </p>\n</blockquote>\n<p>如下圖。</p>\n<p><a href=\"http://lh6.ggpht.com/-gl1WVZbArTg/UVrhPtCZ8SI/AAAAAAAAF9M/29kPAamLpdo/s1600-h/image%25255B8%25255D.png\"><img src=\"http://lh6.ggpht.com/-KYatIOQhg4o/UVrhRUJ-VEI/AAAAAAAAF9U/7WaEKfxawxs/image_thumb%25255B4%25255D.png?imgmax=800\" alt=\"image\" title=\"image\"></a></p>\n<p>改完後，很神奇的，就沒發生了…，就這樣，雖然不知道原因，但至少解決了多年的困擾…</p>\n<h4>後記</h4>\n<p>後面連結，有給一些國外針對此問題的解法和看法，還有整個Azure模擬器的建置過程( 我還沒看就是了XDD，有空再來補成一篇 )；當然，這個問題，有可能歸咎於小弟我安裝了過太多的Azure SDK，或是裝來裝去，裝了一堆的CTP、Beta、等等開發中版本，才發生這樣的問題，但這個過程還是滿有趣的，所以也在這邊記錄下來。</p>\n<p>最後，過了半年，很多朋友也覺得我很神奇XDD，案發現場能保留那麼久…但說真的，我相信只要不放棄，就一定可以找到原因 ( 至少是解法~~ )，所以，如果有發現問題，也不要輕易放棄喔!! ( 其實是我懶得重灌= =… )</p>\n<h4>參考網址</h4>\n<ul>\n<li><a href=\"http://connect.microsoft.com/VisualStudio/feedback/details/773786/azure-sdk-1-8-binds-several-web-roles-to-the-same-port-on-local-emulator\" title=\"http://connect.microsoft.com/VisualStudio/feedback/details/773786/azure-sdk-1-8-binds-several-web-roles-to-the-same-port-on-local-emulator\">http://connect.microsoft.com/VisualStudio/feedback/details/773786/azure-sdk-1-8-binds-several-web-roles-to-the-same-port-on-local-emulator</a>  <li><a href=\"http://blogs.msdn.com/b/kwill/archive/2011/05/05/windows-azure-role-architecture.aspx\" title=\"http://blogs.msdn.com/b/kwill/archive/2011/05/05/windows-azure-role-architecture.aspx\">http://blogs.msdn.com/b/kwill/archive/2011/05/05/windows-azure-role-architecture.aspx</a>  <li><a href=\"http://blog.jamin-tannert.de/2012/12/28/bug-in-azure-compute-emulator-sdk-1-8-at-debugging-multiple-role-instances-on-a-machine-without-vs2010-sp1/\" title=\"http://blog.jamin-tannert.de/2012/12/28/bug-in-azure-compute-emulator-sdk-1-8-at-debugging-multiple-role-instances-on-a-machine-without-vs2010-sp1/\">http://blog.jamin-tannert.de/2012/12/28/bug-in-azure-compute-emulator-sdk-1-8-at-debugging-multiple-role-instances-on-a-machine-without-vs2010-sp1/</a></li>\n</ul>","excerpt":"這個問題，卡了我超級無敵久，可以說從去年12月開始，就出現了這個問題，直到最近，才終於請Microsoft的CSS部門的Michael…"}},"pageContext":{"type":"posts","next":{"frontmatter":{"path":null,"title":"Windows Azure -  使用OData並利用Visual Studio佈署到Web Site要注意!","tags":["ASP.NET MVC","Azure","Entity Framework","Linq","OData","SQL Server","Visual Studio"]},"fields":{"slug":"/2013/03/10/Windows-Azure-使用OData並利用Visual-Studio佈署到Web-Site要注意/"},"fileAbsolutePath":"/home/runner/work/blog.sanc.idv.tw/blog.sanc.idv.tw/src/posts/blog.sanc.idv.tw/Windows-Azure-使用OData並利用Visual-Studio佈署到Web-Site要注意.md"},"previous":{"frontmatter":{"path":null,"title":"SQL Server -  安裝StreamInsight 2.1","tags":["SQL Server"]},"fields":{"slug":"/2013/04/18/SQL-Server-安裝StreamInsight-2-1/"},"fileAbsolutePath":"/home/runner/work/blog.sanc.idv.tw/blog.sanc.idv.tw/src/posts/blog.sanc.idv.tw/SQL-Server-安裝StreamInsight-2-1.md"}}}}