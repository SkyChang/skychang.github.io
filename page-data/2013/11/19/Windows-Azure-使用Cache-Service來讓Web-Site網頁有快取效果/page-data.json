{"componentChunkName":"component---src-templates-page-js","path":"/2013/11/19/Windows-Azure-使用Cache-Service來讓Web-Site網頁有快取效果/","result":{"data":{"markdownRemark":{"frontmatter":{"title":"Windows Azure -  使用Cache Service來讓Web Site網頁有快取效果","date":"19 November 2013","author":"Sky Chang","excerpt":null,"tags":["ASP.NET MVC","Azure"],"coverImage":null},"id":"bdba98c4-ebb8-517b-a2dd-31d525227a85","html":"<p>在Windows Azure上，要擴充網站，第一個遇到的問題就是存放Session，在Windows Azure的歷史上，從存放Session到Share Cache ( 2014停止支援 )，然後還有存放到Table Storage (官方也不建議了)，然後到Azure SQL Database，然後Cloud Service上的Cache機制…</p>\n<p>而雖然Cloud Service上的Web已經有解了，但是Web Site還是只能快SQL Database撐著；而如今隨著時代的演進，Azure上也提供了Cache Service (其實已經提供一段時間了…Orz… )</p>\n<p>那今天我們就利用Cache Service來存放網頁的page，來達到提供網站的效能吧!!</p>\n<p>首先，我們要先建立一個Cache Service。</p>\n<p>基本上，如果沒有特別需求，選擇Basic就夠了…但如果想嘗到Cache的HA，那就必須選擇高階的選項 (最低從5G開始)，而如果想要有通知功能，至少也要有中階…簡單的說，口袋不夠深，只選擇Basic，就真的只提供Cache….</p>\n<p><a href=\"http://lh4.ggpht.com/-sECj9n9rC6Y/UopEKI0te-I/AAAAAAAAIQQ/ZTlPfaJozVo/s1600-h/image%25255B4%25255D.png\"><img src=\"http://lh3.ggpht.com/-jiOLazfC8fo/UopEK8A5pII/AAAAAAAAIQY/U7eHbsZ7l_s/image_thumb%25255B2%25255D.png?imgmax=800\" alt=\"image\" title=\"image\"></a></p>\n<p>嗯，小弟的口袋本來就不夠深，所以只能先嘗試看看Basic，看看未來有沒有人願意提供摳摳，小弟再來嘗試看看比較高階的應用XDDD</p>\n<p>Cache建構的時間比較久，幾乎可以泡完一碗泡麵….而建立完成後，如下圖，就可以點進去做一些設定。</p>\n<p><a href=\"http://lh6.ggpht.com/-k5qdKtganL0/UopELyt0sxI/AAAAAAAAIQg/Z_baZtjB98I/s1600-h/image%25255B8%25255D.png\"><img src=\"http://lh3.ggpht.com/-BLx0eucR04s/UopEMSzjqRI/AAAAAAAAIQo/u-11U7S-YII/image_thumb%25255B4%25255D.png?imgmax=800\" alt=\"image\" title=\"image\"></a></p>\n<p>我們進入Configure裡面，就可以針對Cache進行一些設定，例如時間等等…而這邊因為沒有啟用高階或是中階的功能，所以也不能設定通知和高可用性QQ…. ( 未來有需要測試，再來設定看看吧… ) 另外，也因為是Basic，所以只能定義一組，如果是其他等級的，就可以定義10組以上的Cache設定，給不同的狀況下來使用。至於這些詳細的設定，目前MSDN也提供中文的敘述了，就<a href=\"http://msdn.microsoft.com/zh-tw/library/WindowsAzure/dn448831.aspx#CacheServicePreviewProgramSignup\">直接貼給大家</a>當作參考吧 !!~</p>\n<p><a href=\"http://lh5.ggpht.com/-hs1ujkzPqg0/UopENPBqVUI/AAAAAAAAIQs/aAO_RSnSwRk/s1600-h/image%25255B16%25255D.png\"><img src=\"http://lh4.ggpht.com/-BHfoko7DhS0/UopENiirM-I/AAAAAAAAIQ0/mTIEwCa2Y18/image_thumb%25255B8%25255D.png?imgmax=800\" alt=\"image\" title=\"image\"></a></p>\n<p>接下來切到Scale底下；如果有需要，也可以從這邊進行一些設定，切換成中階的Cache或是高階的Cache，基本上，這是給有錢人看的…哭哭…</p>\n<p><a href=\"http://lh4.ggpht.com/-IX2sTWelPz0/UopEOLv57TI/AAAAAAAAIRA/kO-bgJ-O7iE/s1600-h/image%25255B20%25255D.png\"><img src=\"http://lh5.ggpht.com/-0IfyrR-vrVc/UopEO_iD3rI/AAAAAAAAIRI/jnOypw6y8jU/image_thumb%25255B10%25255D.png?imgmax=800\" alt=\"image\" title=\"image\"></a></p>\n<p>大致上就這樣，接下來，我們就來看看ASP.NET MVC上，怎樣使用Cache。</p>\n<p>首先，我們還是要用老朋友NuGet來取得套件；這邊當然就是Windows Azure Cache了~</p>\n<p><a href=\"http://lh3.ggpht.com/-nt3XBJo58qM/UopEPuRqv-I/AAAAAAAAIRQ/qkBgzPXiu_0/s1600-h/image%25255B25%25255D.png\"><img src=\"http://lh5.ggpht.com/-TDQkwjFgbxY/UopEQSGBYvI/AAAAAAAAIRY/t60985cJ8Ns/image_thumb%25255B13%25255D.png?imgmax=800\" alt=\"image\" title=\"image\"></a></p>\n<p>完成之後，會自動幫我們加上一堆設定檔在Web.config上，但我們還是需要調整一下Web.config。</p>\n<p><a href=\"http://lh6.ggpht.com/-VBJHbviCnDE/UopERS9CENI/AAAAAAAAIRg/oG7sInKuAdI/s1600-h/image%25255B29%25255D.png\"><img src=\"http://lh4.ggpht.com/-S84GNf6J3rM/UopESHjh9_I/AAAAAAAAIRk/iU_l_66T5YU/image_thumb%25255B15%25255D.png?imgmax=800\" alt=\"image\" title=\"image\"></a></p>\n<p>調整的內容如下，我們要把&#x3C;caching>區段的註解拿掉，然後在&#x3C;autoDiscover>裡面的identifier屬性輸入Caching的url，並且把&#x3C;securityProperties>區段的註解拿掉，並且在authorizationInfo裡面也填入金鑰。</p>\n<p>基本上如下圖；另外因為這邊沒有使用到將Session存放到Cache的功能，所以&#x3C;providers>的區段我們就維持註解。</p>\n<p><a href=\"http://lh6.ggpht.com/-dTXkxXqQD7o/UopES35cTQI/AAAAAAAAIRw/vknxNZ30eIc/s1600-h/image%25255B33%25255D.png\"><img src=\"http://lh5.ggpht.com/-Ip2OaDP_q5c/UopETix0jTI/AAAAAAAAIR4/HWm_-XBs_C8/image_thumb%25255B17%25255D.png?imgmax=800\" alt=\"image\" title=\"image\"></a></p>\n<p>另外，這邊也補充一下Web.config對應的關係其實是如下圖所示。</p>\n<p><a href=\"http://lh5.ggpht.com/-aW-GJQiqdVI/UopEUZPNnxI/AAAAAAAAIR8/DL4E41yXJRI/s1600-h/image%25255B47%25255D.png\"><img src=\"http://lh5.ggpht.com/-xy1UEAieFP0/UopEVJeC3sI/AAAAAAAAISI/4N6eiVhxDvo/image_thumb%25255B23%25255D.png?imgmax=800\" alt=\"image\" title=\"image\"></a></p>\n<p>這邊是完成後的Web.config，金鑰的地方已經被小弟改成Key了，別忘了要輸入自己的Key喔!</p>\n<pre class=\"brush: xml;\">&lt;?xml version=\"1.0\" encoding=\"utf-8\"?&gt;\n&lt;!--\n  如需如何設定 ASP.NET 應用程式的詳細資訊，請瀏覽\n  http://go.microsoft.com/fwlink/?LinkId=301880\n  --&gt;\n&lt;configuration&gt;\n  &lt;configSections&gt;\n    &lt;section name=\"dataCacheClients\" type=\"Microsoft.ApplicationServer.Caching.DataCacheClientsSection, Microsoft.ApplicationServer.Caching.Core\" allowLocation=\"true\" allowDefinition=\"Everywhere\" /&gt;\n    &lt;section name=\"cacheDiagnostics\" type=\"Microsoft.ApplicationServer.Caching.AzureCommon.DiagnosticsConfigurationSection, Microsoft.ApplicationServer.Caching.AzureCommon\" allowLocation=\"true\" allowDefinition=\"Everywhere\" /&gt;\n  &lt;/configSections&gt;\n  &lt;appSettings&gt;\n    &lt;add key=\"webpages:Version\" value=\"3.0.0.0\" /&gt;\n    &lt;add key=\"webpages:Enabled\" value=\"false\" /&gt;\n     &lt;add key=\"ClientValidationEnabled\" value=\"true\" /&gt;\n    &lt;add key=\"UnobtrusiveJavaScriptEnabled\" value=\"true\" /&gt;\n  &lt;/appSettings&gt;\n  &lt;system.web&gt;\n    &lt;compilation debug=\"true\" targetFramework=\"4.5\" /&gt;\n    &lt;httpRuntime targetFramework=\"4.5\" /&gt;\n  &lt;!-- Windows Azure Cache session state provider --&gt;&lt;!--&lt;sessionState mode=\"Custom\" customProvider=\"AFCacheSessionStateProvider\"&gt;\n      &lt;providers&gt;\n        &lt;add name=\"AFCacheSessionStateProvider\" type=\"Microsoft.Web.DistributedCache.DistributedCacheSessionStateStoreProvider, Microsoft.Web.DistributedCache\" cacheName=\"default\" dataCacheClientName=\"default\" applicationName=\"AFCacheSessionState\"/&gt;\n      &lt;/providers&gt;\n    &lt;/sessionState&gt;--&gt;&lt;!-- Windows Azure Cache output cache provider --&gt;&lt;!--Uncomment this section to use Windows Azure Cache for output cache--&gt;\n    &lt;caching&gt;\n      &lt;outputCache defaultProvider=\"AFCacheOutputCacheProvider\"&gt;\n        &lt;providers&gt;\n          &lt;add name=\"AFCacheOutputCacheProvider\" type=\"Microsoft.Web.DistributedCache.DistributedCacheOutputCacheProvider, Microsoft.Web.DistributedCache\" \n               cacheName=\"default\" dataCacheClientName=\"default\" applicationName=\"AFCacheOutputCache\" /&gt;\n        &lt;/providers&gt;\n      &lt;/outputCache&gt;\n    &lt;/caching&gt;\n  &lt;/system.web&gt;\n&lt;dataCacheClients&gt;\n    &lt;dataCacheClient name=\"default\" isCompressionEnabled=\"true\"&gt;\n      &lt;!--To use the in-role flavor of Windows Azure Cache, set identifier to be the cache cluster role name --&gt;\n      &lt;!--To use the Windows Azure Cache Service, set identifier to be the endpoint of the cache cluster --&gt;\n      &lt;autoDiscover isEnabled=\"true\" identifier=\"test12.cache.windows.net\" /&gt;\n\n      &lt;!--&lt;localCache isEnabled=\"true\" sync=\"TimeoutBased\" objectCount=\"100000\" ttlValue=\"300\" /&gt;--&gt;\n\n      &lt;!--Use this section to specify security settings for connecting to your cache. This section is not required if your cache is hosted on a role that is a part of your cloud service. --&gt;\n      &lt;securityProperties mode=\"Message\" sslEnabled=\"false\"&gt;\n        &lt;messageSecurity authorizationInfo=\"Key\" /&gt;\n      &lt;/securityProperties&gt;\n    &lt;/dataCacheClient&gt;\n  &lt;/dataCacheClients&gt;&lt;/configuration&gt;\n\n</pre>\n<p>接下來，我們要用asp.net mvc程式來測試一下，這邊我們在整個Action上面加上OutputCache輸出，並且另用Duration參數設定為120秒。</p>\n<pre class=\"brush: csharp;\">using Microsoft.ApplicationServer.Caching;\nusing System;\nusing System.Collections.Generic;\nusing System.Linq;\nusing System.Web;\nusing System.Web.Mvc;\nusing System.Web.UI;\n\nnamespace WebApplication1.Controllers\n{\n    public class HomeController : Controller\n    {\n        //\n        // GET: /Home/\n        [OutputCache(Duration = 120, Location = OutputCacheLocation.Server, VaryByParam = \"none\")]\n        public ActionResult Index()\n        {\n            ViewData[\"Date\"] = DateTime.Now.Millisecond;\n            return View();\n        }\n    }\n}\n</pre>\n<p>原則上，設定完後，就會有效果了，但我們為了確認真的有使用到Azure Cache Service，所以我們這邊稍微對Cache Service的Configure做一個調整，我們把時間調整成1min；這樣做的意思是表示，這個Cache的生命只有一分鐘的時間( 好可憐… )，當一分鐘過後，這個Cache就會消失了…</p>\n<p><a href=\"http://lh6.ggpht.com/-xZHr9qh_9eo/Uot07Fb6EzI/AAAAAAAAISY/zJI_NVd5DoY/s1600-h/image%25255B14%25255D.png\"><img src=\"http://lh5.ggpht.com/-4d__XqUU1P0/Uot072W6hDI/AAAAAAAAISg/KSaMrMsDxx4/image_thumb%25255B7%25255D.png?imgmax=800\" alt=\"image\" title=\"image\"></a></p>\n<p>但我們在MVC的OutputCache是設定120秒阿(兩分鐘)，是的，所以如果真的有存到Azure Cache Service的話，雖然MVC的OutputCache是設定兩分鐘，但實際上，到一分鐘的時候，在Azure上的Cache就會消失了，是沒辦法到兩分鐘的；而如果設定失敗…那就會有存活兩分鐘的現象… (通常也會直接報錯了…)</p>\n<p>最終執行的結果如下，第一次執行的毫秒是584.</p>\n<p><a href=\"http://lh4.ggpht.com/-pQu1UHPtGko/Uot08s0ye6I/AAAAAAAAISo/Da-LVnGUqts/s1600-h/image%25255B4%25255D.png\"><img src=\"http://lh3.ggpht.com/-M4kukwN2cbU/Uot09e1CQkI/AAAAAAAAISw/wsqkIvBsd3U/image_thumb%25255B1%25255D.png?imgmax=800\" alt=\"image\" title=\"image\"></a></p>\n<p>過了一分鐘後，變成346…好吧，我想這樣大家也看不出來…總之，如果有興趣的話，大家可以試試看，這部分還滿簡單的喔!</p>\n<p><a href=\"http://lh5.ggpht.com/-FEkV7OLxaKE/Uot0-Lgd9-I/AAAAAAAAIS4/uyNQJoZOaeo/s1600-h/image%25255B8%25255D.png\"><img src=\"http://lh6.ggpht.com/-MVYy1LAkOJU/Uot0--UfMmI/AAAAAAAAITA/sngisIbplNs/image_thumb%25255B3%25255D.png?imgmax=800\" alt=\"image\" title=\"image\"></a></p>\n<p>這樣就完成了Cache..</p>\n<h4>後記</h4>\n<p>其實如果要使用Session也很簡單，只要稍微調整一下，原本打算一併寫的，但畢竟現在已經有中文的資料了，所以只拋磚引玉的寫一篇關於OutputCache的，而未來如果有需要，會再寫一篇關於Session的，那現在如果有很急的朋友們，可以先去參考看看中文的資料喔<del>謝謝</del></p>\n<h4>參考資料</h4>\n<ul>\n<li><a href=\"http://www.windowsazure.com/en-us/manage/services/cache/net/how-to-cache-service/\">http://www.windowsazure.com/en-us/manage/services/cache/net/how-to-cache-service/</a><li><a href=\"http://msdn.microsoft.com/zh-tw/library/WindowsAzure/dn448831.aspx#CacheServicePreviewProgramSignup\">http://msdn.microsoft.com/zh-tw/library/WindowsAzure/dn448831.aspx#CacheServicePreviewProgramSignup</a><li><a href=\"http://msdn.microsoft.com/zh-tw/library/WindowsAzure/dn386142.aspx\">http://msdn.microsoft.com/zh-tw/library/WindowsAzure/dn386142.aspx</a><li><a href=\"http://msdn.microsoft.com/zh-tw/library/WindowsAzure/dn448829.aspx#ConfigureNuGet\">http://msdn.microsoft.com/zh-tw/library/WindowsAzure/dn448829.aspx#ConfigureNuGet</a></li>\n</ul>","excerpt":"在Windows Azure上，要擴充網站，第一個遇到的問題就是存放Session，在Windows Azure的歷史上，從存放Session到Share Cache ( 2014停止支援 )，然後還有存放到Table Storage (官方也不建議了)，然後到Azure SQL…"}},"pageContext":{"type":"posts","next":{"frontmatter":{"path":null,"title":"Windows Azure - 使用Visual Studio對Web Site進行偵錯","tags":["ASP.NET MVC","Azure","Visual Studio"]},"fields":{"slug":"/2013/11/18/Windows-Azure-使用Visual-Studio對Web-Site進行偵錯/"},"fileAbsolutePath":"/home/runner/work/blog.sanc.idv.tw/blog.sanc.idv.tw/src/posts/blog.sanc.idv.tw/Windows-Azure-使用Visual-Studio對Web-Site進行偵錯.md"},"previous":{"frontmatter":{"path":null,"title":"Windows Azure -  與Visual Studio Online連線時，找不到AzureContinuousDeployment.11.xaml檔案","tags":["Azure","TFS"]},"fields":{"slug":"/2013/12/13/Windows-Azure-與Visual-Studio-Online連線時，找不到AzureContinuousDeployment-11-xaml檔案/"},"fileAbsolutePath":"/home/runner/work/blog.sanc.idv.tw/blog.sanc.idv.tw/src/posts/blog.sanc.idv.tw/Windows-Azure-與Visual-Studio-Online連線時，找不到AzureContinuousDeployment-11-xaml檔案.md"}}}}