{"componentChunkName":"component---src-templates-page-js","path":"/2020/03/21/Azure-Create_Azure_Kubernetes_Service/","result":{"data":{"markdownRemark":{"frontmatter":{"title":"Azure - 建立 Azure Kubernetes Service","date":"21 March 2020","author":"Sky Chang","excerpt":null,"tags":["Azure","Container","AKS","Log Analytics","ACR","Kubernetes","Docker","Linux"],"coverImage":null},"id":"6e85c203-73b2-51fa-9037-ce4d60235d04","html":"<h2>前言</h2>\n<p>現在 Kubernetes 紅得幾乎如日中天，各家都推出自己的 Kubernetes 服務，而在 Microsoft 的 K8S，當然就叫做 Azure Kubernetes Service，而它的前身為 Azure Container Service。</p>\n<p>\b而這篇文章，會敘述，如何建立 AKS。是的，你沒看錯，又要再寫一次怎麼建立 AKS。其實之前也寫過很多次，但是隨著時代的演進，又略有不同了 (泣)，所以這篇又會再重新敘述，如何建立 ASK....</p>\n<h2>建立 Create Log Analytics 工作區</h2>\n<p>因為 AKS 會使用到 Log Analytics 來存放 Log 資訊，雖然你可以讓他自己建立，但放置的 Resource 位置都醜醜的，所以第一步，我們先來建立 Create Log Analytics 工作區。</p>\n<p>找到 Log Analytics 工作區並建立，基本上，裡面也沒什麼可以選的...就順順的建立完成吧。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/b435dc5accefe5bd45ff6d863e90e050/add93/2020-05-27-16-55-07.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 49.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAABRklEQVQoz4WSS1ODMBSFs6fllUACRUqVFMJLp844ddeVmzqunHGccaf+CH/9sYkFqdPWxZnATfhy7+GQq7yEKhrIskVR3yDkApZlwXEcuI4N13Xhed6wnlK/TxLVQD2/ocgXaOsSdV2jaRpEcQIq5vAZ3x12zsIOgPPtJ5qPLzw8veLx5R1ZtoDgHIwF8GkAz6e7g+5Z0HgKIuILeFMb2WqLtLyDPbUwmUxh27aRGX3/kZZ+7zUGDR1KuUTbdZCXKbI0QRzHSJIEs9nMSAgBvus4DEMj/dzXjnlLtF+bzQbr9T3aths8VEohz3OkaYooisxFetUwDWaMHQcWS4nb1Qpd9wvrVVWVqfXSNSklKKUHsDGUSHVtIsN5OHShRw2C4MC7sU9avu8fjRJh0RyUp3D2P+CU4X+hp/JJPPcnwP/l7Fz2xvoG8UMAQbWe1HUAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"2020 05 27 16 55 07\"\n        title=\"2020 05 27 16 55 07\"\n        src=\"/static/b435dc5accefe5bd45ff6d863e90e050/78d47/2020-05-27-16-55-07.png\"\n        srcset=\"/static/b435dc5accefe5bd45ff6d863e90e050/56d15/2020-05-27-16-55-07.png 200w,\n/static/b435dc5accefe5bd45ff6d863e90e050/d9f49/2020-05-27-16-55-07.png 400w,\n/static/b435dc5accefe5bd45ff6d863e90e050/78d47/2020-05-27-16-55-07.png 800w,\n/static/b435dc5accefe5bd45ff6d863e90e050/64756/2020-05-27-16-55-07.png 1200w,\n/static/b435dc5accefe5bd45ff6d863e90e050/add93/2020-05-27-16-55-07.png 1377w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h2>建立 Azure Container Registry</h2>\n<p>通常 AKS 拉的 Images 會來自 ACR ( 你要放到 Docker Hub 也是可以啦 )，所以這邊會建議也先準備好 ACR，因為現在建立 AKS 的時候，可以直接選擇 ACR，讓他直接塞 Service Principal 進去，可以省掉自己加 Service Principal 的步驟。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/afeb0590b4a1f5e4936779aebd207fc5/bcfad/2020-05-27-17-44-08.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 49.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAABFklEQVQoz42STU7DMBCFc4EQ/0SpkoqIJjSx85+0ogJ2cAIkVmxZISHWHIFehis+bEORK5mSxdPYY8+n5xl763WBohSo6xpxHCMMQzDGQbUoBSHExP+k7zHG4InXPYaPT4zjgOubW3RdjyhJwZc5WBidBB7O7OhdPr5gfNvj7ukd9w/PyiFHEAQgPxf+kg21916yiBAxioAt4PuBShJwzsGVff0Es3bIBh05LIXEZrtF29Romsb0sqoqo7ZtIYRAlmVGeZ7/SvfbCUySGMMwGEkpDUBHXfQ9IObsn847gedpiqvdDn3fY5omNZzRxLIsT/bQhhwBL4oOy5XEme+bYRw057s4HRKqrFM+q2AO2DPJGX9tLvALX83/I4ADyA8AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"2020 05 27 17 44 08\"\n        title=\"2020 05 27 17 44 08\"\n        src=\"/static/afeb0590b4a1f5e4936779aebd207fc5/78d47/2020-05-27-17-44-08.png\"\n        srcset=\"/static/afeb0590b4a1f5e4936779aebd207fc5/56d15/2020-05-27-17-44-08.png 200w,\n/static/afeb0590b4a1f5e4936779aebd207fc5/d9f49/2020-05-27-17-44-08.png 400w,\n/static/afeb0590b4a1f5e4936779aebd207fc5/78d47/2020-05-27-17-44-08.png 800w,\n/static/afeb0590b4a1f5e4936779aebd207fc5/64756/2020-05-27-17-44-08.png 1200w,\n/static/afeb0590b4a1f5e4936779aebd207fc5/bcfad/2020-05-27-17-44-08.png 1396w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>這邊不會提到怎麼建 ACR，後續找時間再來補上 ACR 的部分。</p>\n<h2>建立 AAD Service Principal</h2>\n<p>在以前，建立 AKS 的第一步，就是要建立 Service Pricnipal，因為 AKS ( Azure Kubernetes Service ) 會需要和其他 Azure 的服務互動，所以我們必須給他一個 AAD Service Principal，如果對於 Service Prinipal 不熟悉的，可以參考底下兩篇文章</p>\n<ul>\n<li><a href=\"https://docs.microsoft.com/zh-tw/azure/active-directory/develop/active-directory-application-objects\">關於 AAD Service Princiap 的解釋 : Azure Active Directory (Azure AD) 中的應用程式和服務主體物件</a></li>\n<li><a href=\"https://docs.microsoft.com/zh-tw/azure/azure-resource-manager/resource-group-create-service-principal-portal\">使用入口網站來建立可存取資源的 Active Directory 應用程式和服務主體</a></li>\n</ul>\n<p>但這個時代，建立 AKS 的時候，你可以先不用建立了，而且，不是以前那種建立出來醜醜的 SP，而是現在有直接管理的機制 ( 刪除 AKS，Service Princiap 也會自動刪除喔! )</p>\n<h2>建立 Azure Kubernetes Service</h2>\n<p><code class=\"language-text\">若需要使用 Az cli 請參考本文最後面</code></p>\n<p>在建立之前，有幾個地方要特別注意。</p>\n<h3>Node 的 Pods 數</h3>\n<p>預設每一個 Node 的最大 Pods 數為 110，若要調整為最大 Pods 數 ( 250 ) 需使用 AZ CLI 進行設定。</p>\n<p>雖然正常情況下，一個 Node 的 Pods 數不太會高達超過 110，但如果真的有超過這個的規劃，那可能要使用 Azure Cli 進行建置。( 配置完後，\n就不可變更 )</p>\n<h3>AKS IP 的規劃</h3>\n<p>AKS 預設使用的 IP 量是很大的，他有一個公式如下:</p>\n<p>EX : 若有 50 個節點，其中也包含相應增加的 10 個節點的佈建：(50 + 10 + 1) + ( (50+10+1) * 30 (default)) = 1,891 (/21 或更大)</p>\n<p>所以如果未來有需要有非常多的 Node，則要提前考慮與計算。</p>\n<p>也請在開始前，將此網段切好，不然可能只能重新建 AKS 了</p>\n<h3>AKS-VNode IP 的規劃</h3>\n<p>除了使用 Node 外，AKS 支援使用 ACI ( Azure Contianer Instance ) 來進行存放實際的 Pods，通常 VNode 需要一個網段，而每一個 Pods 也會佔用掉一個 IP。</p>\n<p>雖然這個功能，在建立完後再 enable / disable，但若有需要，開始前將此網段切好，會比較好。</p>\n<h3>AKS Node 大小的規劃</h3>\n<p>AKS 的 Node 規格建立後，就不可以變更了 ( 很重要，請唸三遍 )，所以到底要給大一點的 VM 當作 Node，還是小一點的 VM 當 Node，在一開始的時候，就決定了一切。</p>\n<h3>AKS 的私人叢集</h3>\n<p>建立 AKS 的時候，可以決定，是否只有內網 ( VNet 內 ) 才能對 AKS 進行控制 ( EX : 使用 Kubectl )，而這個也會在建立玩成後，無法變更。</p>\n<p>但目前將 AKS 放到私人叢集可能會有以下 <a href=\"https://docs.microsoft.com/en-us/azure/aks/private-clusters\">issue</a></p>\n<h3>網路原則</h3>\n<p>目前 AKS 支援原生、Calico、Azure 三種網路原則，雖然小弟我一定是選 Azure，但如果有需要其他原則的考量，可能也要在部署前思考清楚。</p>\n<h3>使用 Azure Cli 來建立</h3>\n<p>在 AKS 的官網，主要透過 Azure Cli 來建立，當然也可以透過 Portal 建立，這邊我們先提供一個快速的 Cli 指令。</p>\n<h3>開始建立</h3>\n<p>找到 Azure Kubernetes Service</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/bed1d91f5cae75e0738e12d3973aa382/bcfad/2020-05-27-17-36-00.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 51.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAABIklEQVQoz5WST06EMBSH2SsUihnkTymFwjAkYmTFCSZxtmrizo1uXbryDq69gnfyLD9bTMlggIyLr+81ff2avtZinIMLgbK+wia4hG2fwyVE4cB1XXieN8YlzDqlFNb+8IL7x3fUpUAlc2y3FYI4hR9L0IuNKiarsr8HWq9vX/j4/Mb+7hmHhyckSQKP+oPMUyeeKjJzK04yhLGA6G6RyGs49hkcxwHRqKuvYSTHrbGE6l9VlYgCH3EYIE05sixTMR3g/Hdu0PWaMAwn0lFY1zX6vsdN16Ft24GmabDb7QZ0nuf5RFYUxbKwkBJaqoukyvVG3UcDYwxRFA1oydw1J0KW1whZofpmTxZPeQxTPxESNZCZ11pjTjwK6cIX+O93MfEHh/QACa2rCNUAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"2020 05 27 17 36 00\"\n        title=\"2020 05 27 17 36 00\"\n        src=\"/static/bed1d91f5cae75e0738e12d3973aa382/78d47/2020-05-27-17-36-00.png\"\n        srcset=\"/static/bed1d91f5cae75e0738e12d3973aa382/56d15/2020-05-27-17-36-00.png 200w,\n/static/bed1d91f5cae75e0738e12d3973aa382/d9f49/2020-05-27-17-36-00.png 400w,\n/static/bed1d91f5cae75e0738e12d3973aa382/78d47/2020-05-27-17-36-00.png 800w,\n/static/bed1d91f5cae75e0738e12d3973aa382/64756/2020-05-27-17-36-00.png 1200w,\n/static/bed1d91f5cae75e0738e12d3973aa382/bcfad/2020-05-27-17-36-00.png 1396w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>進行基本的設定，這邊要注意的就是 VM 大小了，建完後，就不可以改了 ( 只能改數量 )</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/9270a2f99beb94603c12939b4a49b729/bcfad/2020-05-27-17-36-50.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 52%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAABPklEQVQoz42ST3OCMBTEuSsEAoJB0ISiaPlTqtYDHjvjpd//82zzXnWmndHKYWcZCJu3+cWp23ds655Vd3sImcDzPJbruhBCwPd9VhAE/0pKCadtGrRNjWqzwXpdojDa+hplWbJnWYYwDHnxLfiRKNRRKsUiTfmn2SzG7rVGURTQWrOvVivkeY4kSZ5OSd+djZ2MJISHQEaIYsXPVPVe3Xuht3ccSLvntlZ0rbVc5pjP53baGeI4ZidFUTQukCoppTCZTCwIF8YYDiAoNOHvAx8VOJzPuFwuOJ1OOByOVgccjz8+DAO6rkPf96iq6s8GD89QF5botkFZWdLtHk3/gRcLg4AQZZqegFD9Z5Q5MFssIH2B6XQKGQbIlhr+Fci9ys/kmLdPmP2XDQsRE4BEQZkaSaotKMkw6EqRxgR+A+Wo/YMnbbMDAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"2020 05 27 17 36 50\"\n        title=\"2020 05 27 17 36 50\"\n        src=\"/static/9270a2f99beb94603c12939b4a49b729/78d47/2020-05-27-17-36-50.png\"\n        srcset=\"/static/9270a2f99beb94603c12939b4a49b729/56d15/2020-05-27-17-36-50.png 200w,\n/static/9270a2f99beb94603c12939b4a49b729/d9f49/2020-05-27-17-36-50.png 400w,\n/static/9270a2f99beb94603c12939b4a49b729/78d47/2020-05-27-17-36-50.png 800w,\n/static/9270a2f99beb94603c12939b4a49b729/64756/2020-05-27-17-36-50.png 1200w,\n/static/9270a2f99beb94603c12939b4a49b729/bcfad/2020-05-27-17-36-50.png 1396w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>接著，這邊要決定是否要啟用虛擬節點，通常小弟我會在這邊就直接請用，後續也可以透過 AZ Cli 來啟用，其次，VM 擴展集也會在這邊勾起來，未來可以讓 Node 自動擴展。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/36524ee6fe07f48877e326631067c238/bcfad/2020-05-27-17-38-23.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 50%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAABPUlEQVQoz42SSW7DMAxFtc/kKZZs2fKUWLYRue6i6x6g9z/PL6kigRFk6OJDFAE9fooU0zTBOYd5nrEsC4IgQJIkCMMQh8PhJs5z7nqudc1FUQRhbQ87jsjzHEVRoK5rNE3j4zRNoZTy5yvYuphozyOs+4KpmhuQIWVZom1bVFXl4ziOn7pc34XKNLp+RJwcPZDbY0daa2w3Gxhj/Bdw/l3L3qExFZSuPDDLlH8sCSilRBQn3h1/xz3kKZAHcuo6KAKwM275PAyQKkOYltgHEXa77f8dXgho7UDuMt9maWqUdYucYnbJeXbIxR7B7sHC9icsHw4jTbrpepwGRw6dn7QvQC3zYBi8dvJMQtcW0ti/XYuOaPsJdppp0hnl9qTgtoe8Z+8k9PQN8/lDlxix1KQCSdbQQI7k5nWLj/QL63b7856JNDcAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"2020 05 27 17 38 23\"\n        title=\"2020 05 27 17 38 23\"\n        src=\"/static/36524ee6fe07f48877e326631067c238/78d47/2020-05-27-17-38-23.png\"\n        srcset=\"/static/36524ee6fe07f48877e326631067c238/56d15/2020-05-27-17-38-23.png 200w,\n/static/36524ee6fe07f48877e326631067c238/d9f49/2020-05-27-17-38-23.png 400w,\n/static/36524ee6fe07f48877e326631067c238/78d47/2020-05-27-17-38-23.png 800w,\n/static/36524ee6fe07f48877e326631067c238/64756/2020-05-27-17-38-23.png 1200w,\n/static/36524ee6fe07f48877e326631067c238/bcfad/2020-05-27-17-38-23.png 1396w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>這邊比較需要注意的，以前只有服務主體可以選擇，也就是說，以前選擇服務主體後，他會自動的幫忙建立一個 Service Principal，而現在，多了一個更方便的選項，就是系統指派的受控識別，選擇此功能，可以讓 AKS 服務自己來管理，也因此，不會多一個 Service Principal 了，甚至砍掉 AKS 的時候，以前會留下 Service Principal，使用受控識別，也不用自己處理了，砍掉的時候，會將受控識別一起砍掉。</p>\n<p>RBAC 是一定要起用的，後面有太多的功能會和 RBAC 相依。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/77d99584d9a5eeaf36e282aa743bd014/bcfad/2020-05-27-17-38-55.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 49.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAABLUlEQVQoz5VSy07DMBD0HSWOX7FInUfjRpWdJg3iUA6VOPL/XzRsAqVF0AgOo90dy6PZB4sxou97jOOIaZqQZRm01pBCgHNO9RWCuPl9xpzfYuaklGBt2yKEAFdWKMsSTdOg3m5hiwJCKSidQxKE0neFLvwc2T4eFiFrczQktO86nGLAeTjg4Ftou0Fe1FDW/Sp4EbrkbOt3GI5P8L6DIMtlXWPwHqc+IlCulETG09WWvzls2g7T8wv2cUBPQq/HETsaw6aqUFH7zrmbz+sOF0FjDC1BIUkTGCI8tW5pKfNC0jRd4toyfgh+JJ8PhIRn4Hc+/gUs4wl48nB1sET+Vf8XzLodbB2WG1LaLGei80eqFUEs/H/AXDijOr6RXRLMN3QmJUzRQipzd2ZreAfr4fjfeCdW6wAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"2020 05 27 17 38 55\"\n        title=\"2020 05 27 17 38 55\"\n        src=\"/static/77d99584d9a5eeaf36e282aa743bd014/78d47/2020-05-27-17-38-55.png\"\n        srcset=\"/static/77d99584d9a5eeaf36e282aa743bd014/56d15/2020-05-27-17-38-55.png 200w,\n/static/77d99584d9a5eeaf36e282aa743bd014/d9f49/2020-05-27-17-38-55.png 400w,\n/static/77d99584d9a5eeaf36e282aa743bd014/78d47/2020-05-27-17-38-55.png 800w,\n/static/77d99584d9a5eeaf36e282aa743bd014/64756/2020-05-27-17-38-55.png 1200w,\n/static/77d99584d9a5eeaf36e282aa743bd014/bcfad/2020-05-27-17-38-55.png 1396w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>接下來是網路設定，通常配置如下就可以，提供 Node 使用的網段，VNode 使用的網段，還有 AKS 自己使用的網段，通常我都保持預設。</p>\n<p>而需要注意的就是下面那三個，目前私人叢集還有一些問題，所以我目前還不敢打開 XDDD\n而網路原則我習慣用 Azure，HTTP 應用程式路由通常是拿來測試使用，再比較正式的環境上，通常會搭配 Ingress 等服務，所以通常會將此功能關閉。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/007d1f87e9e30fd62d6b4616842c6443/bcfad/2020-05-27-17-40-30.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 50%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAABPklEQVQoz5WSzW6DMBCEObcK+N/GEAOJCSQIKrW5Vz32/R9ouk6bKFIbJT2M1ruWPmbWZMuy4LDfY5omLPMMzhikkFQ5OP8tRve3ZkIIZGVZQlDz/PyEgknshlcEH2BVCSMstDCX+hfw3KealHVti8pXKPIcWpfYv3ygjwfELsJRL5mC4pqA+q7DpCyEgL7vUVceUmoM0xHer+GMhdEGShKQ5qneA54cWmvRdR08RZdSIqxrcqpOZ6XURVLJx4DjOCK5zCkyo6EmZ5yWy0hpyfIkCSHF48AmNFgR0BuDKUYE51DpFPUbetYt4DU4a0INJRhWRYHBGcybDrttxEjRA8XML1/nN0HXykKcEA9HFFxgQ86G0KKlR9nSbj05LBLw55d4RFk7v2P79glLMFc38OsN6mYH5zwMrSA92n/0Bb9L+ckwIUflAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"2020 05 27 17 40 30\"\n        title=\"2020 05 27 17 40 30\"\n        src=\"/static/007d1f87e9e30fd62d6b4616842c6443/78d47/2020-05-27-17-40-30.png\"\n        srcset=\"/static/007d1f87e9e30fd62d6b4616842c6443/56d15/2020-05-27-17-40-30.png 200w,\n/static/007d1f87e9e30fd62d6b4616842c6443/d9f49/2020-05-27-17-40-30.png 400w,\n/static/007d1f87e9e30fd62d6b4616842c6443/78d47/2020-05-27-17-40-30.png 800w,\n/static/007d1f87e9e30fd62d6b4616842c6443/64756/2020-05-27-17-40-30.png 1200w,\n/static/007d1f87e9e30fd62d6b4616842c6443/bcfad/2020-05-27-17-40-30.png 1396w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>最後，現在可以和其他服務串再一起，也就是一開始設定 ACR 和 Log Analytics，這邊選定的 ACR，會直接在 ACR 裡面加上受控識別，來讓 AKS 未來可以撈取，當然不設定也可以，只是以後要自己加上去。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/68f96db88b78dbcb01d0a0ff7332220a/bcfad/2020-05-27-17-41-11.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 49.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAABQ0lEQVQoz5WSzW7CMBCEfW/zZydO4sQJIdSUJKUE1IpDhdRj3/+BpmujUqAQqYdPa63k8cyu2TAM6LoOfT9gHEdwzhHHsatRFF0QhuGf3k/fYu8wpXIYY9A0M8g0hSpKKKWcqO97CIKAqn8SOxe97tnK1psdPg6f2GzfUeoKlS5JvEFV1ajrGrNZg/m8hZTy4uKts4UVpQYXMR49n1ylaM2INMkhhURyRhzFiMJfN0KI2w774QW7tz3MqsdiYchVg5IeybLMuWzb1mHdXs/wpmC7GrFc7/G0ekVeaHo5cvG44M6FnaXl2tG9M9NaI88z+N4DReJ47rYwi6WLKUISoqi2usgTmz4JhrTJKPCOTftlspqEwyN3vscUTBa0QW3cH+IiISimVK5yEnH9f8DK7oBq80UOaGayIIcaiZo78al49/gGiIL6EYKzr5UAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"2020 05 27 17 41 11\"\n        title=\"2020 05 27 17 41 11\"\n        src=\"/static/68f96db88b78dbcb01d0a0ff7332220a/78d47/2020-05-27-17-41-11.png\"\n        srcset=\"/static/68f96db88b78dbcb01d0a0ff7332220a/56d15/2020-05-27-17-41-11.png 200w,\n/static/68f96db88b78dbcb01d0a0ff7332220a/d9f49/2020-05-27-17-41-11.png 400w,\n/static/68f96db88b78dbcb01d0a0ff7332220a/78d47/2020-05-27-17-41-11.png 800w,\n/static/68f96db88b78dbcb01d0a0ff7332220a/64756/2020-05-27-17-41-11.png 1200w,\n/static/68f96db88b78dbcb01d0a0ff7332220a/bcfad/2020-05-27-17-41-11.png 1396w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>然後就完成了～</p>\n<h2>建立 Azure Kubernetes Service - Az Cli</h2>\n<p>如果想使用 AZ Cli 建立的，可以參考底下，目前底下的 AZ Cli 是需要建立 SP 的過程，若想讓他自己託管，可以將建立指令多加上，<a href=\"https://docs.microsoft.com/en-us/cli/azure/aks?view=azure-cli-latest#az-aks-create\">詳細可以參考</a></p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">--enable-managed-identity</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># 填寫自己的 Resource Group、AKS名稱、地區</span>\n<span class=\"token assign-left variable\">RESOURCE_GROUP_NAME</span><span class=\"token operator\">=</span>Study4-Group\n<span class=\"token assign-left variable\">CLUSTER_NAME</span><span class=\"token operator\">=</span>Study4AKS\n\n<span class=\"token comment\"># Service Principal</span>\n<span class=\"token assign-left variable\">SP_ID</span><span class=\"token operator\">=</span>貼上應用程式<span class=\"token punctuation\">(</span>用戶端<span class=\"token punctuation\">)</span>識別碼\n<span class=\"token assign-left variable\">SP_PASSWORD</span><span class=\"token operator\">=</span>貼上上面複製的密碼\n\n<span class=\"token comment\"># 取得virtual network resource ID</span>\n<span class=\"token assign-left variable\">VNET_ID</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span>az network vnet show --resource-group $RESOURCE_GROUP_NAME --name Study4-VNet --query <span class=\"token function\">id</span> -o tsv<span class=\"token variable\">)</span></span>\n\n<span class=\"token comment\"># 給 VNET SP權限</span>\naz role assignment create --assignee <span class=\"token variable\">$SP_ID</span> --scope <span class=\"token variable\">$VNET_ID</span> --role Contributor\n\n<span class=\"token comment\"># 取得 virtual network subnet resource ID</span>\n<span class=\"token assign-left variable\">SUBNET_ID</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span>az network vnet subnet show --resource-group $RESOURCE_GROUP_NAME --vnet-name Study4-VNet --name AKS-Node --query <span class=\"token function\">id</span> -o tsv<span class=\"token variable\">)</span></span>\n\n<span class=\"token comment\"># 建立 AKS </span>\naz aks create <span class=\"token punctuation\">\\</span>\n    --resource-group <span class=\"token variable\">$RESOURCE_GROUP_NAME</span> <span class=\"token punctuation\">\\</span>\n    --name <span class=\"token variable\">$CLUSTER_NAME</span> <span class=\"token punctuation\">\\</span>\n    --node-count <span class=\"token number\">3</span> <span class=\"token punctuation\">\\</span>\n    --generate-ssh-keys <span class=\"token punctuation\">\\</span>\n--network-plugin azure <span class=\"token punctuation\">\\</span>\n    --service-cidr <span class=\"token number\">10.10</span>.0.0/16 <span class=\"token punctuation\">\\</span>\n    --dns-service-ip <span class=\"token number\">10.10</span>.0.105 <span class=\"token punctuation\">\\</span>\n    --docker-bridge-address <span class=\"token number\">172.17</span>.0.1/16 <span class=\"token punctuation\">\\</span>\n    --vnet-subnet-id <span class=\"token variable\">$SUBNET_ID</span> <span class=\"token punctuation\">\\</span>\n    --service-principal <span class=\"token variable\">$SP_ID</span> <span class=\"token punctuation\">\\</span>\n    --client-secret <span class=\"token variable\">$SP_PASSWORD</span> <span class=\"token punctuation\">\\</span>\n    --network-policy azure <span class=\"token punctuation\">\\</span>\n--kubernetes-version <span class=\"token number\">1.15</span>.10\n--max-pods <span class=\"token number\">250</span> <span class=\"token punctuation\">\\</span>\n--node-vm-size Standard_D4s_v3\n\n<span class=\"token comment\">#啟動 VNode</span>\naz aks enable-addons <span class=\"token punctuation\">\\</span>\n    --resource-group <span class=\"token variable\">$RESOURCE_GROUP_NAME</span> <span class=\"token punctuation\">\\</span>\n    --name <span class=\"token variable\">$CLUSTER_NAME</span> <span class=\"token punctuation\">\\</span>\n    --addons virtual-node <span class=\"token punctuation\">\\</span>\n    --subnet-name AKS-VNode</code></pre></div>\n<h2>參考資料</h2>\n<ul>\n<li><a href=\"https://docs.microsoft.com/zh-tw/azure/active-directory/develop/active-directory-application-objects\">https://docs.microsoft.com/zh-tw/azure/active-directory/develop/active-directory-application-objects</a></li>\n<li><a href=\"https://docs.microsoft.com/zh-tw/azure/azure-resource-manager/resource-group-create-service-principal-portal\">https://docs.microsoft.com/zh-tw/azure/azure-resource-manager/resource-group-create-service-principal-portal</a></li>\n<li><a href=\"https://docs.microsoft.com/en-us/cli/azure/aks?view=azure-cli-latest#az-aks-create\">https://docs.microsoft.com/en-us/cli/azure/aks?view=azure-cli-latest#az-aks-create</a></li>\n<li><a href=\"https://docs.microsoft.com/zh-tw/azure/aks/use-managed-identity\">https://docs.microsoft.com/zh-tw/azure/aks/use-managed-identity</a></li>\n<li><a href=\"https://docs.microsoft.com/en-us/azure/aks/private-clusters\">https://docs.microsoft.com/en-us/azure/aks/private-clusters</a></li>\n</ul>","excerpt":"前言 現在 Kubernetes 紅得幾乎如日中天，各家都推出自己的 Kubernetes 服務，而在 Microsoft 的 K8S，當然就叫做 Azure Kubernetes Service，而它的前身為 Azure Container Service…"}},"pageContext":{"type":"posts","next":{"frontmatter":{"path":null,"title":"Dapr - Hello Dapr","tags":["Dapr","K8S","AKS","ASP.NET Core","Microservice"]},"fields":{"slug":"/2020/03/13/Dapr-Hello_Dapr/"},"fileAbsolutePath":"/home/runner/work/blog.sanc.idv.tw/blog.sanc.idv.tw/src/posts/Dapr-Hello_Dapr/Dapr-Hello_Dapr.md"},"previous":{"frontmatter":{"path":null,"title":"天空的垃圾場 - 使用 GatsbyJS 改版 Blog","tags":["Node.js","Hexo","Hugo","Github","GatsbyJS","Wyam","Sky的IT碎碎念"]},"fields":{"slug":"/2020/06/06/SkyBlog-Use_GatsbyJS_for_Blog/"},"fileAbsolutePath":"/home/runner/work/blog.sanc.idv.tw/blog.sanc.idv.tw/src/posts/SkyBlog-Use_GatsbyJS_for_Blog/SkyBlog-Use_GatsbyJS_for_Blog.md"}}}}