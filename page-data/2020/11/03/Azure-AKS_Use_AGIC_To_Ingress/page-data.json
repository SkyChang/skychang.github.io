{"componentChunkName":"component---src-templates-page-js","path":"/2020/11/03/Azure-AKS_Use_AGIC_To_Ingress/","result":{"data":{"markdownRemark":{"frontmatter":{"title":"Azure - AKS - 使用 AGIC 當作 AKS Ingress","date":"03 November 2020","author":"Sky Chang","excerpt":null,"tags":["Azure","Container","Kubernetes","Linux","AKS","ApplicationGateway","AGIC"],"coverImage":null},"id":"83695645-3fed-5945-945a-f3fbf161e57f","html":"<h2>前言</h2>\n<p>用過 K8S 的朋友都知道，目前讓 K8S 對外提供端點，不外乎透過 ClusterIP、Nodeport、Load Balancer、Ingress 這幾種方法，而地端 K8S 下，最常用的應該就是 NodePort，畢竟地端的 Load Balancer 需要自建 QQ ...( 不過在雲上的 AKS 自動送你了 )，但就算有了 Load Balancer，但 LB 能提供的 Port 還是那幾個，遠遠不能滿足裡面那麼多的應用程式，所以我們可能希望透過網址的方式進行 mapping，讓不同的網址對應到後面的 Service，又或是透過 url path 進行導向，而這就是 Ingress 的功用。</p>\n<p>Ingress 有很多種，包含使用 Nginx、Traefik 或是一整包包好的 Istio ，都可以做到上述講的這些功能，但在 AKS 的選擇上，小弟更喜歡用 AGIC ( Application Gateway Ingress Control )。</p>\n<h2>AGIC</h2>\n<p>如下是官網提供的 AGIC 架構圖，其實 AGIC 就是一個放在 AKS 裡面的 Azure Application Gateway 的監控程式，他可以監控 AKS 的 Ingress yaml，並且自動地去修改 Application Gateway 的設定，換言之，若我們使用了其他的 Ingress，這些 Ingress 會在 AKS 裡面運作，在裡面去處理流量的導向，而 AGIC 的監控，雖然在裡面，但真實流量的導向的處理，則是在外部的 Application Gateway。因為他就是一個外部的雲端服務，所以不會消耗掉 AKS 裡面 Node 的資源，而且透過雲上的特性，也可以輕易的縮放 ( 但小弟也沒什麼流量就是了...= =|| )，除此之外，Application Gateway 也提供了內建的 WAF 等機制，最重要的是，使用的方式，也和一般的 Ingress 差不多，搭配 YAML 的設定，就可以同步到 Application Gateway 上。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 770px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/2ba1bd18f88aac9769ed0f7684631d49/5b400/2020-11-03-21-52-46.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 60.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsSAAALEgHS3X78AAACPUlEQVQoz22TTW/TQBCG8z+58QO4cUzLhSsnLnDIAYWvHqqKCkUVQgEUAk0RwXbafDkJVZovO8F1Esfe9a5fZtdOIIiVXnvW3nl2Zmc2BxpJkpCkfm/nakgpwXkMHseISYzxnS2E0O90ntrKL6dA2yETsQeTMqGFDJZRh91poXnVgGXW0bAMmKYJy7LQujIwGg60j4LmlCFkDGdt4++ho5YC00UAo+vCaE9hdmYwOi6GU5+ijSBpM7O3QvM6+ANk4hYffz7Fy0YBxrhIJPWDI4oisGgDy3ZxduHipNzF8fsWSucOAVYa8N1myD/z8KDowRwwlRdys5WFt517eGfncWzdRRCE2Gw2CMNQpzuZE7Tvo9H7pWX1bzFyQw0sfQvx8PUSB0UfZTNKgepHd1bGaeM+1uEiS1fqg+YU4Y+2g9PqFEdnl3hVsvDm8xiNga/XzRceHr1o4vFRG0vf1+eeE/QYD0cY9Wx43hI656woGiwS2ihBwIGAslpTIIwLtas+M/Cllqq6Um7rPPM2aXTboqhiZRMe3EDMK5Aktr7eLx51guqGvSoXPg1w50kNfWetMGn/uWPSSC+M3AuMKoeYVA4QOl9AxQcf9xF7cwLKVMpTELBHkOdfb1CoDHF40tRAwRjixVRLtWno1giYh1PNE7AKwekoFhOIpZfCst7VKYfUHrZt48N5HbXL/j8ppzO2cSB8S4sFU/xvKOjuDB3HoZvQ1o26u3rZAs65LoyqAwWm7Zi+8UzKjrPrqPx+A7YjieVQU1iEAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"2020 11 03 21 52 46\"\n        title=\"2020 11 03 21 52 46\"\n        src=\"/static/2ba1bd18f88aac9769ed0f7684631d49/5b400/2020-11-03-21-52-46.png\"\n        srcset=\"/static/2ba1bd18f88aac9769ed0f7684631d49/56d15/2020-11-03-21-52-46.png 200w,\n/static/2ba1bd18f88aac9769ed0f7684631d49/d9f49/2020-11-03-21-52-46.png 400w,\n/static/2ba1bd18f88aac9769ed0f7684631d49/5b400/2020-11-03-21-52-46.png 770w\"\n        sizes=\"(max-width: 770px) 100vw, 770px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h2>安裝 AGIC</h2>\n<p>目前安裝 AGIC 有兩種做法，以前很可憐的，只能透過 Helm 進行部署，而且還要去設定權限的部分，畢竟，我們要能讓 AGIC 去自動地去 Application Gateway 調整裡面的設定嘛～</p>\n<p>而現在 AGIC 已經變成 AKS 的 addons 之一 ( ACI 的整合功能也是 addons 之一的功能 )，雖然這個 addons 還在 Preview ( 謎之聲 : 最近的文章怎麼都是 Preview XDD )。但基於方便安裝的立場上，而且還提供了自動更新等機制，覺得可以拿來使用了。 ( 請注意，Preview 功能是不提供 Support 的 )。</p>\n<p>而開始前，還是要注意一下 AGIC 使用 Helm 和 addons 安裝的差異。</p>\n<ul>\n<li>addons 版本目前 ( 未來會改 )，不支援其他服務共用一個 Application Gateway，因為 addons 不能設定 ProhibitedTargets。在 Helm 的時代，我們可以啟用 Heml 設定檔 裡面的 appgw.shared=true，並加上 ProhibitedTargets CRD 的 yaml 設定，來讓 Application Gateway 同時提供給 AKS 和 VM 等服務使用。 ( 例如，要進入 VM 的網址為 vm.study4.tw，而我們可以在 ProhibitedTargets CRD 的 yaml 裡面去設定，若網址為 vm.study4.tw 的部分，AGIC 不會自動覆蓋掉我們在 Application Gateway 的設定，如果沒此功能，我們在 Application Gateway 的設定，會被 AGIC 秒改.. <a href=\"https://docs.microsoft.com/zh-tw/azure/application-gateway/ingress-controller-install-existing\">詳細資料</a> )</li>\n<li>同上，換言之，addons 就只能提供給這個 AKS 使用</li>\n<li>\n<p>底下的值，無法使用</p>\n<ul>\n<li>verbosityLevel 預設為 5，<a href=\"https://github.com/Azure/application-gateway-kubernetes-ingress/blob/463a87213bbc3106af6fce0f4023477216d2ad78/docs/troubleshooting.md#logging-levels\">級別說明</a></li>\n<li>usePrivateIp 預設為 false，但有機會自己<a href=\"https://docs.microsoft.com/zh-tw/azure/application-gateway/ingress-controller-annotations#use-private-ip\">改寫</a></li>\n<li>shared 同上，不支援共用了</li>\n<li>reconcilePeriodSeconds 預設每 30 秒去詢問差異</li>\n<li>armAuth.type 因為不走 SP 託管</li>\n</ul>\n</li>\n</ul>\n<p>而最終的對應表，就如官方下圖。</p>\n<p>在 addons 的情境如下</p>\n<ul>\n<li>1 AGIC : 1 AG : 正常情境</li>\n<li>1 AGIC : 2 AG : 目前沒辦法 1 AGIC 對應到多個 AG</li>\n<li>2 AGIC : 1 AG : addons 預設只能開一個 AGIC</li>\n<li>2 AGIC : 2 AG : addons 預設只能開一個 AGIC</li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 772px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/6c617322d803e56c03a18a614b0dbb62/a546b/2020-11-03-23-04-30.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 28.500000000000004%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsSAAALEgHS3X78AAAA4klEQVQY011QSaqEUAz0CCLOAw7ggCM4bdWFeAjvf458qiDN714UeakklXoxzvOU53nkvm85jkPWdZV93wX8PM8yTZNc1yXv+zI3TVMcxxHbthk9zxPXdRkBI89zqaqKqOtauq6Ttm2ZJ0lCFEVBrixL5pgBF8fxRwwRMHSTZVmSZZls2ybLsnAANTRpHYLDMPAX6MNS1HzfJ+gQjsIwZKJu4DQIAgqC14EoiiiKOiJmEbH0I9j3PRuwKU1TvsGhcRxHutYBrUOoaRreFNyXIJzAoZKaA3CMXO/zW8cN/98P+ANEBaX3LBdVvgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"2020 11 03 23 04 30\"\n        title=\"2020 11 03 23 04 30\"\n        src=\"/static/6c617322d803e56c03a18a614b0dbb62/a546b/2020-11-03-23-04-30.png\"\n        srcset=\"/static/6c617322d803e56c03a18a614b0dbb62/56d15/2020-11-03-23-04-30.png 200w,\n/static/6c617322d803e56c03a18a614b0dbb62/d9f49/2020-11-03-23-04-30.png 400w,\n/static/6c617322d803e56c03a18a614b0dbb62/a546b/2020-11-03-23-04-30.png 772w\"\n        sizes=\"(max-width: 772px) 100vw, 772px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>在 Helm 底下，的情境如下</p>\n<ul>\n<li>1 AGIC : 1 AG : 正常情境</li>\n<li>1 AGIC : 2 AG : 目前沒辦法 1 AGIC 對應到多個 AG</li>\n<li>2 AGIC : 1 AG : 同樣因為可以設定 ProhibitedTargets，所以支援放兩個以上的 AGIC 對到同一個 AG</li>\n<li>2 AGIC : 2 AG : 可行，如 1 AGIC : 1 AG 的情境</li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 768px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/7b949b2769582d0f3ec7be0499f4c292/fe486/2020-11-03-23-05-11.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 27.500000000000004%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsSAAALEgHS3X78AAABAElEQVQY01WQya6CUBBE+QUFRQYZBBxQgYSARrauXLLj/z+kXk4nLN6icjvdXdVV1xmGQW3b6vf7aZ5nfT4fjeOopmn0/X51u93U972madKyLKrrWq7ryvd97ff7f6DnXK9XVVUlhN/vt57Pp5HO57Mej4eOx6PN7/e7zU+nkzzPUxAEhjAMDdQmuN1uBeI4Nidd1+lyuZgLwGUEqDebjXa7nRE5SjI4r9dLZVnajsPlw+GgJEnMFVFxtRIRpAZrTT/LMvsO+CRBGCMOIgwRIT6X8zxXmqbWB0VRGIjLSxrmCCAKF0NRFMnBKossIcjSSgTM6QOOM0dg/Vt6OF4T/AHtM6kkidXYzgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"2020 11 03 23 05 11\"\n        title=\"2020 11 03 23 05 11\"\n        src=\"/static/7b949b2769582d0f3ec7be0499f4c292/fe486/2020-11-03-23-05-11.png\"\n        srcset=\"/static/7b949b2769582d0f3ec7be0499f4c292/56d15/2020-11-03-23-05-11.png 200w,\n/static/7b949b2769582d0f3ec7be0499f4c292/d9f49/2020-11-03-23-05-11.png 400w,\n/static/7b949b2769582d0f3ec7be0499f4c292/fe486/2020-11-03-23-05-11.png 768w\"\n        sizes=\"(max-width: 768px) 100vw, 768px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>若有設定多組的 AKS 叢集，目前支援度就不高，如下圖所示</p>\n<ul>\n<li>1 AGIC : 1 AG : 因為是 AKS 叢集，所以這個情境不合理</li>\n<li>1 AGIC : 2 AG : 同上，因為是 AKS 叢集，不可能只有一個 AGIC</li>\n<li>2 AGIC : 1 AG : 同樣因為可以設定 ProhibitedTargets，所以支援放兩個以上的 AGIC 對到同一個 AG</li>\n<li>2 AGIC : 2 AG : 因為是 AKS 叢集，目前多組的 AG 沒辦法讓流量自動分散到不同的 AKS 叢集上</li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 769px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/72bcf1732f1506371238b40c69333056/e4e90/2020-11-03-23-06-39.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 27.500000000000004%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsSAAALEgHS3X78AAAA4UlEQVQY011Q3QpGUBD0Cv5F/kMUSUIUd668g1vv/wLzNVtH+i6mdnfOmZldbV1XHMeB53lwnieWZcG2bWiaBnVdY993XNeF+75RFAUsy4LjOLBtW2oF13UFWpqmiKIIeZ4jyzIRqaoKnPu+LxxBjj2FgiCQWZIkMo/jWEwIzTRNeWQYBsIwxDzPGMdREv6nUTXNuq7DMAyYpgl93wsnCdu2FWc2dCWh6/q7hnroeZ6ANY2ZUq1LE8VrZVlKbA4p+F2Z4Fo8hxKjAQWJf6P3hvykbsPP7HmXr6gSI7gRofovfq18o+QEJLhrAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"2020 11 03 23 06 39\"\n        title=\"2020 11 03 23 06 39\"\n        src=\"/static/72bcf1732f1506371238b40c69333056/e4e90/2020-11-03-23-06-39.png\"\n        srcset=\"/static/72bcf1732f1506371238b40c69333056/56d15/2020-11-03-23-06-39.png 200w,\n/static/72bcf1732f1506371238b40c69333056/d9f49/2020-11-03-23-06-39.png 400w,\n/static/72bcf1732f1506371238b40c69333056/e4e90/2020-11-03-23-06-39.png 769w\"\n        sizes=\"(max-width: 769px) 100vw, 769px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h2>建立 Application Gateway</h2>\n<p>再將 Application Gateway 透過 AGIC 整合 AKS 之前，當然還是要先準備 Application Gateway，如果目前連 AKS 都沒有，這邊提供兩種做法，一個是 az cli，一個是 UI ( 但其實最近越來越喜歡用 az cli XDD )</p>\n<p>另外，開始前，請先切一個 Application Gateway 專用的網段。至於為何要切 /24，底下為文件敘述。</p>\n<p><code class=\"language-text\">應用程式閘道 (Standard_v2 或 WAF_v2 SKU) 最多可支援125個實例 (125 個實例 IP 位址 + 1 個私人前端 IP + 5 個 Azure 保留) –因此建議的子網大小下限為/24</code></p>\n<p>所以~~</p>\n<ul>\n<li>要最大可以到 125 個 instance，就要切 /24</li>\n<li>若要使用私人端點，Standard_v2 必須要一個私人前端 IP，所以要 + 1</li>\n<li>預設會 5 個保留 ( 前四個和最後一個 IP 位址 )</li>\n<li>如果不會開那麼多個 instance 的話，可以少切一點</li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/b12a0178311891ba25d65a6ccaa5c734/3643c/2020-11-15-16-01-07.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 49.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAABkUlEQVQoz4VS2W7jMAzMDziWLSu248T3VdtBk+6mRbHty/7/P81ymGNbFEUfBpJIcUgOuUq3W5zPZ0zThHEcFWVZwlqLMLTXM7zDGIMgCAS38wLa6V/t9jmSJIHneViv14jjGGmaYrPZIE5S9fHOkz4m+A5K2I0LhqG/Z8iyHZyLNGuWZUrEz0zCyvnmnT7G8J3nOaIouhA2dYu6qdVJxPsOLtkLYYi+73E6nTDPswbcgkhCwq3I5Zz7L4uNsCqrEnVdq4PGeNcqaSD3rutwPB6xLAscyaRq/uFftk8wSXC1K+Hv5xe8vf3RIBLbrBG08EyAoqowTjNaqdTIgO6BgtswPg5MCdthEm0K+NKuE+NjPeJQ9RiTDV4fBvx9OuL9MOOQiW6irZE/1oZ3sk9bQMKiaVGJ2DoUQVcO6PIGpbP49TDi/emEl0WqTGXKkVUpOJSiKFRHJdQpk1wId+KgVtSFVfphhLW06/kGEVeHKyRD8HXXvrb5cRc5yFVetSq47/sXIxf3urxGbP4VN7v5Af8A+Z7/q1L/VFgAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"2020 11 15 16 01 07\"\n        title=\"2020 11 15 16 01 07\"\n        src=\"/static/b12a0178311891ba25d65a6ccaa5c734/78d47/2020-11-15-16-01-07.png\"\n        srcset=\"/static/b12a0178311891ba25d65a6ccaa5c734/56d15/2020-11-15-16-01-07.png 200w,\n/static/b12a0178311891ba25d65a6ccaa5c734/d9f49/2020-11-15-16-01-07.png 400w,\n/static/b12a0178311891ba25d65a6ccaa5c734/78d47/2020-11-15-16-01-07.png 800w,\n/static/b12a0178311891ba25d65a6ccaa5c734/64756/2020-11-15-16-01-07.png 1200w,\n/static/b12a0178311891ba25d65a6ccaa5c734/3643c/2020-11-15-16-01-07.png 1400w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>而建立 Application Gateway，當然一樣可以透過 az cli 來建立，如下。而這邊我們會用兩個 az cli 來建立 Application Gateway。</p>\n<h3>透過 az cli</h3>\n<p>第一步，是建立 Public IP，因為 Application Gateway 是對外的，當然要有對外的公用 IP，但這邊有個選項是很有趣的，稱為 --ip-tags 'RoutingPreference=Internet'，意思是說，當啟用了這個選項後，任何從 Application Gateway 出去的數據，都會走 Internet。你或許或說，不是全部都是走 Internet 嗎！？ No.No.非也，如果啟用了這個選項，而且 Application Gateway 架設在東日本，那他會從東日本的 ISP，東繞繞，西繞繞，繞到不同的 ISP 回到台灣。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 513px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/0c6221add89f4c76fe2e5d97bc1a6c7e/7fe11/2020-11-05-23-37-59.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 18.999999999999996%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAIAAAABPYjBAAAACXBIWXMAAAsSAAALEgHS3X78AAAA3ElEQVQI1z2OQW+CMABG+d/+gh13cLedvG1Z4sFE48lMoi6LUVR0iFBoF5kt2loQqJR2bhrf6Uu+5OUZ0TcCACCEIIRCCP2H0jfUfUulParV/fnHeE2VlmUAEQyDJCtaDgtc9+GTvduov9r6vNjNst0qZ1n++LHowMkb5C9feQscu1FkPIG4PKVTyxqZ5g9NagM2X9iNoTccz+ujqOkQtmEbay+lQLHX9ibPIW+7SS+g3RAaCcHnsqSUYkKkrC4xR84p3h5iXFV67azt5cU28wHgPKOEpTE+i+Ka/QvZTdgNLv4DWQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"2020 11 05 23 37 59\"\n        title=\"2020 11 05 23 37 59\"\n        src=\"/static/0c6221add89f4c76fe2e5d97bc1a6c7e/7fe11/2020-11-05-23-37-59.png\"\n        srcset=\"/static/0c6221add89f4c76fe2e5d97bc1a6c7e/56d15/2020-11-05-23-37-59.png 200w,\n/static/0c6221add89f4c76fe2e5d97bc1a6c7e/d9f49/2020-11-05-23-37-59.png 400w,\n/static/0c6221add89f4c76fe2e5d97bc1a6c7e/7fe11/2020-11-05-23-37-59.png 513w\"\n        sizes=\"(max-width: 513px) 100vw, 513px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>而預設的情況下，則會走 Azure 的骨幹，換言之，若是東日本，然後台灣資料中心也已經完工了，那出來的資料，就會從東日本走 MS 骨幹到台灣資料中心，再出來到目的地，而不會透過東日本的 ISP 業者。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 510px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/06d7f1778541c66a3b38fafbc2b280bb/1b7d6/2020-11-05-23-39-52.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 22.499999999999996%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAIAAADKYVtkAAAACXBIWXMAAAsSAAALEgHS3X78AAAA9klEQVQY00VPTU+EMBDtb/fq1YMXTTwZ40WNZhOuHogQY9iNsqB0ZcVqgFoKtLRsPyy7frxMJjOT917egPswzLIMb1GWpRDCWmuMsb/4n7ab+akJwGm+cO1kVVW5LqWcKMr8iYyySk9LTnVc653BzhTsYa05Z3wIgqAo3oUUlLbxpWgq3nMmGL24JSc33aZtfUgOo9l5vjpIm6MHcQoR2E8+GkIGzj3Pi6I559xFWC1wsUZd31str+8+j2dvjFExyHkeXsH1GcT+K/NRDQZcj+OolCKEdF3nYi+X8QtM0jR1Ru6YPC2ek0eEkOM0pB8olZQY94y138cbFBUHMgnzAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"2020 11 05 23 39 52\"\n        title=\"2020 11 05 23 39 52\"\n        src=\"/static/06d7f1778541c66a3b38fafbc2b280bb/1b7d6/2020-11-05-23-39-52.png\"\n        srcset=\"/static/06d7f1778541c66a3b38fafbc2b280bb/56d15/2020-11-05-23-39-52.png 200w,\n/static/06d7f1778541c66a3b38fafbc2b280bb/d9f49/2020-11-05-23-39-52.png 400w,\n/static/06d7f1778541c66a3b38fafbc2b280bb/1b7d6/2020-11-05-23-39-52.png 510w\"\n        sizes=\"(max-width: 510px) 100vw, 510px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>當然，以效能來說，自然是 MS 骨幹的延遲最低了，但走 Internet 的話，會比較便宜喔。</p>\n<ul>\n<li><a href=\"https://docs.microsoft.com/zh-tw/azure/virtual-network/routing-preference-overview\">參考資料</a></li>\n<li><a href=\"https://azure.microsoft.com/en-us/blog/optimize-for-internet-traffic-with-peering-service-and-the-routing-preference-option/\">關於延遲</a></li>\n</ul>\n<p>另外，這邊建議選擇 --sku standard，因為只有 standard 才有支援 Zone-redundant ( 自動啟用，沒錯，連 IP 有 XDDD )。當然，如果想特別針對某一個 zone，可以加上 --zone 1 的參數。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># 建立 Public 首碼，讓我們的 ip 可以連續 ( 一次最多 /28 - 16個 , 最小 /31 - 2個 ip)</span>\naz network public-ip prefix create <span class=\"token punctuation\">\\</span>\n--length <span class=\"token number\">28</span> <span class=\"token punctuation\">\\</span>\n--location JapanEast <span class=\"token punctuation\">\\</span>\n--name PublicIPPrefix-Study4Dev-JE <span class=\"token punctuation\">\\</span>\n--resource-group study4dev-je\n\n<span class=\"token comment\"># 如果想讓網路省錢，可以加上 --ip-tags 'RoutingPreference=Internet' 讓他走 Internet，而不是 Azure 骨幹 </span>\n<span class=\"token comment\">#( 請先註冊 az feature register --namespace Microsoft.Network --name AllowRoutingPreferenceFeature )</span>\naz network public-ip create <span class=\"token punctuation\">\\</span>\n-n PublicIP-AG-AKS-Study4Dev-JE <span class=\"token punctuation\">\\</span>\n-g study4dev-je <span class=\"token punctuation\">\\</span>\n--allocation-method Static <span class=\"token punctuation\">\\</span>\n--sku Standard <span class=\"token punctuation\">\\</span>\n--public-ip-prefix PublicIPPrefix-Study4Dev-JE</code></pre></div>\n<p>建立 Application Gateway，這邊我們可以使用 --zones 1,2,3，來讓 Application Gateway 達到 Zone-redundant，但真的能不能達到高可用性，還是要看後面的 Work Node 的情況，如果大家還記得，之前小弟的 Work Node，基本上為了配合 PPG，所以只部署在 zone 1，所以雖然 Application Gateway 已經有了 Zone-redundant，但 zone 1 掛掉後，基本上，服務還是全死 XDDDD，不過這邊還是讓 Application Gateway 啟用 zones 1,2,3 吧～</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># 建立 Application Gateway</span>\n<span class=\"token comment\"># 目前使用 AZ CLI 建立 Standard_v2 必須指定 private ip addrss，所以要在 Application Gateway 的範圍內建立</span>\n<span class=\"token comment\"># 底下只會建立一個 AG Instance</span>\naz network application-gateway create <span class=\"token punctuation\">\\</span>\n-n AG-AKS-Study4dev-JE <span class=\"token punctuation\">\\</span>\n-l JapanEast <span class=\"token punctuation\">\\</span>\n-g study4dev-je <span class=\"token punctuation\">\\</span>\n--sku Standard_v2 <span class=\"token punctuation\">\\</span>\n--public-ip-address <span class=\"token punctuation\">\\</span>\nPublicIP-AG-Study4Dev-JE <span class=\"token punctuation\">\\</span>\n--vnet-name Study4Dev-JE-VNet <span class=\"token punctuation\">\\</span>\n--subnet ApplicationGateway <span class=\"token punctuation\">\\</span>\n--http2 enabled <span class=\"token punctuation\">\\</span>\n--private-ip-address <span class=\"token number\">10.99</span>.181.80 <span class=\"token punctuation\">\\</span>\n--capacity <span class=\"token number\">1</span> <span class=\"token punctuation\">\\</span>\n--zones <span class=\"token punctuation\">{</span><span class=\"token number\">1,2</span>,3<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\"># 只能建立完後，在默默地刪掉 QQ</span>\n<span class=\"token comment\"># issue https://github.com/MicrosoftDocs/azure-docs/issues/64433</span>\naz network application-gateway frontend-ip delete <span class=\"token punctuation\">\\</span>\n--resource-group study4dev-je <span class=\"token punctuation\">\\</span>\n--gateway-name AG-AKS-Study4dev-JE <span class=\"token punctuation\">\\</span>\n--name appGatewayPrivateFrontendIP</code></pre></div>\n<h3>透過 UI 建立</h3>\n<ul>\n<li>目前搭配 AGIC，一定要 v2，若有需要，也可以開 WAF V2。</li>\n<li>因小弟流量小到可憐，所以就沒開自動縮放</li>\n<li>同上，所以預設只一個 instance</li>\n<li>AG 要先切好一個子網路，專門給 AG 使用</li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/edd55686e732f303b30fe1258a27403b/ace50/2020-11-03-23-44-59.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 51%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAABK0lEQVQoz42STU7EMAyFewFoEidp0ibpD1PKAqlILFjAYnbc/0QPJ9ARYqoOi0+O3fb1xXb1vL7i4/yJt/czXJdg2gHG95BCQEp5hTioK6VQhRCwPM5ovQMRoesiSPFL/FD9QYhjwRyr02nGuq6o67oUUuoRAouSvhLcc5jzrZZj5Zy7JFlkmRf4poXVDWN/+D5LKW47DDHCe18cErto2wBNBiSJc/0LgmBBKeSu4EYVY0J2mQU1OxzTA7ztYFUDo2xhOx8N5SI4DAP3LV16GLqAjnuoysfHbnYFp2lCz4MoV+arjuMTUsuujWdnFlqa4k4r8z9BrTU7qVHf3/EkCePpBSlOiLw+eRgkdRHNcZvoEVXTWDgf4NICYx0U72JG8i4SqbKbG/nnt/gC+Iz3D0gOAJIAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"2020 11 03 23 44 59\"\n        title=\"2020 11 03 23 44 59\"\n        src=\"/static/edd55686e732f303b30fe1258a27403b/78d47/2020-11-03-23-44-59.png\"\n        srcset=\"/static/edd55686e732f303b30fe1258a27403b/56d15/2020-11-03-23-44-59.png 200w,\n/static/edd55686e732f303b30fe1258a27403b/d9f49/2020-11-03-23-44-59.png 400w,\n/static/edd55686e732f303b30fe1258a27403b/78d47/2020-11-03-23-44-59.png 800w,\n/static/edd55686e732f303b30fe1258a27403b/64756/2020-11-03-23-44-59.png 1200w,\n/static/edd55686e732f303b30fe1258a27403b/ace50/2020-11-03-23-44-59.png 1406w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>這一步驟，只是設定一個 Public IP</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/fc96285e1fb28a68496816bd7bdbc2b8/ace50/2020-11-03-23-45-21.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 51.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAABDklEQVQoz52Sy07DMBRE/QNt/Ih97TyakDRWFUUskJDKAhaI//+lwTaUmkhpBYvROFfJ+IxjNj8+4eXtA8/nV5BrIekQ1KAoCnDOf1wIkfyyXivOpZRgfd/hNC+YpgnOWpDRsGRARFBKwRiTXtwKygOjs67r4E8zmvaAvu8xHid47zEMA5xzyWN4Hrhe5w0YkQ0UGvvdLgwEHkYPa68BsXL0C+WtyolQSnU9g1BxWRYM4xGubtLz1odbYjl2pIgyhlA1LXgWsK52M1BkgbzYo1Qy/Bxzl2Y7MO6anKNd3lH5M1Rpvml+H/49sS+6IpHFgaIaStsQIv9Mlwg1VdDhQlM9oNQEKYpQXaQ7+B99Aucx9cQz8rMRAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"2020 11 03 23 45 21\"\n        title=\"2020 11 03 23 45 21\"\n        src=\"/static/fc96285e1fb28a68496816bd7bdbc2b8/78d47/2020-11-03-23-45-21.png\"\n        srcset=\"/static/fc96285e1fb28a68496816bd7bdbc2b8/56d15/2020-11-03-23-45-21.png 200w,\n/static/fc96285e1fb28a68496816bd7bdbc2b8/d9f49/2020-11-03-23-45-21.png 400w,\n/static/fc96285e1fb28a68496816bd7bdbc2b8/78d47/2020-11-03-23-45-21.png 800w,\n/static/fc96285e1fb28a68496816bd7bdbc2b8/64756/2020-11-03-23-45-21.png 1200w,\n/static/fc96285e1fb28a68496816bd7bdbc2b8/ace50/2020-11-03-23-45-21.png 1406w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>未來會透過 AGIC，自動設定完這些參數，但初期透過 UI 建立的時候，這些還是必填....</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/e3156c0fb22bc12eb832dc16a8f9dd32/ace50/2020-11-03-23-45-31.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 51.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAABa0lEQVQoz3VSy26DMBD0pa0iUbAN2CSAg4E0qUKbh1opOTTJoYf+/w9N15aIKE0OI++Ox/s0W28+cDx94/N4gpoWkNpAqgJhGCLiHEIID052HMc4n8+4XC7IsgxJkiBN0z9g7yrDV2VxKA12SmMdcWxShS3xryFH/fCE5nGClk5LfrtYYEF46zosX5aojEVd1WhsiyIvwMwsR1OWaOuWyBpmOsO8KGCJy7VGRlVNkxRaSqRCoqoqqk5jvzmgW+0QBs8QEXUQUidcgC27PVbdFnMS2rpGaQwqa69wvrub5TmiKPJtSwquqAOVaj+K61gEB6ubBYyZIwgCf+keKaW8wNmO4/05gLtz8MG4uAZlLpv0jvSE8/uszu6F/WKGFfXc0Gcu0Dj78PEtbhhgDNZXNs54L2Cv5zc0Dkx4g2YUhYPs/E4SmlswGWlHFaY6pw9toIsGCW0tprm5Tf6DFEhos9X2B5lZIaZPfUv3Cw3b+qyDDqBFAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"2020 11 03 23 45 31\"\n        title=\"2020 11 03 23 45 31\"\n        src=\"/static/e3156c0fb22bc12eb832dc16a8f9dd32/78d47/2020-11-03-23-45-31.png\"\n        srcset=\"/static/e3156c0fb22bc12eb832dc16a8f9dd32/56d15/2020-11-03-23-45-31.png 200w,\n/static/e3156c0fb22bc12eb832dc16a8f9dd32/d9f49/2020-11-03-23-45-31.png 400w,\n/static/e3156c0fb22bc12eb832dc16a8f9dd32/78d47/2020-11-03-23-45-31.png 800w,\n/static/e3156c0fb22bc12eb832dc16a8f9dd32/64756/2020-11-03-23-45-31.png 1200w,\n/static/e3156c0fb22bc12eb832dc16a8f9dd32/ace50/2020-11-03-23-45-31.png 1406w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>這邊也是必填....</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/3af6f14a0c296e157deb3e8827425f71/ace50/2020-11-03-23-45-46.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 51.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAABmElEQVQoz3WSy07kMBBFsxzRnYcfsZM4dpxO0w8aISFG6mFBL0YsgI+YP5jN/L90p8r9ECBYHFXZjqtuXSfb3T3g8fCMn7+eYFsPaTyU9SiKAlVVYb/f43A4IIQApRS01qjr+ojheFwLISCkQDaOI7abNTbrFbq2hXMdrDVoKefLY4zoug4+eAxDxGpaIYYR0Ucs4oSBIqOFhqwUMtd7LBaLxO+XN6w3N3RxADdyVGhzc4vtdou+72GMoT1HjbsLLdG7ns49al0jqyqBfD5Hnuf48/cfWjqcza5o5DKNPZBCbmCtTcWW4xK+8wguEEPKhz6m3NYNMiElJDFNE0JcQmkL3kueEJ6UafKuKHLyUCP4EY1poU4jvkdLUijE8XLTNMng85ofhGH/uCHnHNlXpUjEN6SC/HFZlpcigjkV3e12qSifS6nQ0tjc/DzBZy4Kv4ILNmQ6/xZnhZbWWh/X7ydJiIofhRJWVxanA/Hh43z2A2U+T6o/T/IVWd04mI5eyC+hTZP8YfNTJCXx/hXu+iGpOv/YHL/jP53d/fv4E9pfAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"2020 11 03 23 45 46\"\n        title=\"2020 11 03 23 45 46\"\n        src=\"/static/3af6f14a0c296e157deb3e8827425f71/78d47/2020-11-03-23-45-46.png\"\n        srcset=\"/static/3af6f14a0c296e157deb3e8827425f71/56d15/2020-11-03-23-45-46.png 200w,\n/static/3af6f14a0c296e157deb3e8827425f71/d9f49/2020-11-03-23-45-46.png 400w,\n/static/3af6f14a0c296e157deb3e8827425f71/78d47/2020-11-03-23-45-46.png 800w,\n/static/3af6f14a0c296e157deb3e8827425f71/64756/2020-11-03-23-45-46.png 1200w,\n/static/3af6f14a0c296e157deb3e8827425f71/ace50/2020-11-03-23-45-46.png 1406w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>這邊也是必填....</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/bcc3a8fe79a9581b7afa7a511933164f/ace50/2020-11-03-23-46-01.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 51%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAABqElEQVQoz2VSwXKbMBDlHDBCCEkGGWEw2JPUDYkzmcl0mt7aS9ov6Cf00P8/ve5uSuLWhzcL0vL2vbckH24f8OnLVzw+PcPXLUrXwvgWeZ5Da43b+Q7z3QN244TVaoVCKRQFo7hASf3JdrvFYT9hP42o6xohNPDeoWkamLKEazrYZkCuSpiqQh1oYOVQGgttqgskYdNiGAbBt+8/cLi+Qdd16PseTQjoYgtXGSiVE5FFaDusmwBjnRD/C4ukKDRWWSZ2fv76TQoC0vRKLLONaZrgnBP7jMqYt+f/IZY12SoJI2UUu5GmePDZ0sTKY4yoyK4hsmE6YEOuJLOzvgWJ1nxYiAprKQf92sQfcOWMWVWapnJmrZWByz2TGlHNGZtXQr5U6n1zPGBRMM+z2N7tdqKWM+23URyN40hqN7JAztx7vyi8zGNRcDx+xP3pJKQTERzvn3D6/ELvowwJlDkrZDKuiaiiDQpEoT6rClplUHmGjBbHLmLXI/aT3C2LOxeQOPqZfeixjgdYV9OU8m0BFf0K/ekFm/0jZeclP7ZYr70oWv+tC3gPfwBIEv9fVSk3uwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"2020 11 03 23 46 01\"\n        title=\"2020 11 03 23 46 01\"\n        src=\"/static/bcc3a8fe79a9581b7afa7a511933164f/78d47/2020-11-03-23-46-01.png\"\n        srcset=\"/static/bcc3a8fe79a9581b7afa7a511933164f/56d15/2020-11-03-23-46-01.png 200w,\n/static/bcc3a8fe79a9581b7afa7a511933164f/d9f49/2020-11-03-23-46-01.png 400w,\n/static/bcc3a8fe79a9581b7afa7a511933164f/78d47/2020-11-03-23-46-01.png 800w,\n/static/bcc3a8fe79a9581b7afa7a511933164f/64756/2020-11-03-23-46-01.png 1200w,\n/static/bcc3a8fe79a9581b7afa7a511933164f/ace50/2020-11-03-23-46-01.png 1406w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>這邊也是必填.... ( 未來可不可以改成不要填啊 QQ )</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/7dee6f51f48eff19d98253d454f85b4c/ace50/2020-11-03-23-46-11.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 51%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAABw0lEQVQoz21Su5LUMBB0zK0fkizJtmxZshftGoo7CopaCG6ji6j7Bf6AhP8Pmhl5l7qAoEvWWNPT0zPFx8ev+HF9wbfvz7D9BGkmKDuhqio0TYPL5YLr9QrvPZRSaNsW2mhorfPZ6jZDiAZCChQhRpxPCaf0HkPfwbkB1hr0fZ+TwzznmPcTZj8jrQnBR8xTwBpWRPqO8wKjDJRQKNw4YVmWjJefrzhtHzATSaRCwzBQoYRPT58R6T8XcYPL8XEc0XVdVl1VNUQjSCUpbOijPBxQliV+/f6D3jk8PLxDVde5bW51IJKOyPhMaUM6JsSwoDMdTGsgSdkOiUJICUlYj0f4cIRqLTjG1dhDa+lOZ1ke6F0LP6+QJEI2cgcRqRs0kRdC7MmcqLO5+51JmPB8PsNPUy7KKt3oYchj21kYY3IegwfDbzIhJ9bUYnMjYTApx9jLRD5ORMq+sb8hhHx3ZA+fDPY3e/hP0X9QsodEsG0bqdGZgFVwISbmLeAB8XDY79tQSFFd7cjqxBuFVV6hEFdq0VFbOk+VSbnd+14y7iIKQ8tsXUTnEy1qT48kDaa9PdYIX14xbs8ww5yJOH4nvX+/xV9ACwDQ0gAU9QAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"2020 11 03 23 46 11\"\n        title=\"2020 11 03 23 46 11\"\n        src=\"/static/7dee6f51f48eff19d98253d454f85b4c/78d47/2020-11-03-23-46-11.png\"\n        srcset=\"/static/7dee6f51f48eff19d98253d454f85b4c/56d15/2020-11-03-23-46-11.png 200w,\n/static/7dee6f51f48eff19d98253d454f85b4c/d9f49/2020-11-03-23-46-11.png 400w,\n/static/7dee6f51f48eff19d98253d454f85b4c/78d47/2020-11-03-23-46-11.png 800w,\n/static/7dee6f51f48eff19d98253d454f85b4c/64756/2020-11-03-23-46-11.png 1200w,\n/static/7dee6f51f48eff19d98253d454f85b4c/ace50/2020-11-03-23-46-11.png 1406w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>以上，就建立完成，完成後，我們可以透過屬性取得 ID。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/99d8af264740afede55b242fabc7250f/ace50/2020-11-03-23-54-29.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 54.49999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsSAAALEgHS3X78AAABcklEQVQoz52S226CQBCGua6wCihyEBY5o+IBUUysTZuYNOlF0/d/mb+zWzVN04P24stkZ2f/OewoQZShWjao2wfsdjWej1s8HV+wPzyi2bRo2j3qZovVciGpV0vEUYTxeIwwDOG6LjjnmEymWFRTKG6UYzZfIM8LxGmBkBIEFNBRGVSNQWM9aVVVlXQIxtiFbrcr0TSVYFDivERIApqmwTB0+L5HAQyGrkv0kzUM44J+8n+HkqQTZFmKXq8H0zQRx7F8JM6/PfxRME4y+KMRCXxUIWbT7/f/LxhlE6RJjOFwKB2e58lKxVyE6FfO/vPspP9iaYbjNEeWpvKSUZWiZSFqWZZMIuyfyLgBLCcQFRbwqOU7VUMzcrEuS1i2A2swuE7sjIh3SXBO65KEHGvPxYzgtFv6p5ZugqlQXu8PeNtt0JYFOC0sDwIMKJuY403Qh5qWA6WcTWE7DkwSsW0bVVXRGtHP+z4CEr8OjsAfgSdTvAO5hxqg0aretAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"2020 11 03 23 54 29\"\n        title=\"2020 11 03 23 54 29\"\n        src=\"/static/99d8af264740afede55b242fabc7250f/78d47/2020-11-03-23-54-29.png\"\n        srcset=\"/static/99d8af264740afede55b242fabc7250f/56d15/2020-11-03-23-54-29.png 200w,\n/static/99d8af264740afede55b242fabc7250f/d9f49/2020-11-03-23-54-29.png 400w,\n/static/99d8af264740afede55b242fabc7250f/78d47/2020-11-03-23-54-29.png 800w,\n/static/99d8af264740afede55b242fabc7250f/64756/2020-11-03-23-54-29.png 1200w,\n/static/99d8af264740afede55b242fabc7250f/ace50/2020-11-03-23-54-29.png 1406w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>結論，還是指令比較方便 QQ ( 懶 )</p>\n<h2>安裝 AGIC</h2>\n<p>因為目前是 Preview，所還是要先註冊功能</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># 確認是否有安裝 aks-preview 外掛套件</span>\naz extension list\n\n<span class=\"token comment\"># 若沒安裝過外掛套件，請先安裝</span>\naz extension <span class=\"token function\">add</span> --name aks-preview\n\n<span class=\"token comment\"># 若有安裝過請先更新</span>\naz extension update --name aks-preview\n\n<span class=\"token comment\"># 註冊功能</span>\naz feature register --name AKS-IngressApplicationGatewayAddon --namespace microsoft.containerservice\n\n<span class=\"token comment\"># 確認是否註冊完畢</span>\naz feature list -o table --query <span class=\"token string\">\"[?contains(name, 'microsoft.containerservice/AKS-IngressApplicationGatewayAddon')].{Name:name,State:properties.state}\"</span>\n\n<span class=\"token comment\"># 重新整理功能</span>\naz provider register --namespace Microsoft.ContainerService</code></pre></div>\n<h3>方案一 在 AKS 建立時自動建立</h3>\n<p>這邊是第一個方案，用於下指令建立 AKS 的時候，可以順便把 AGIC 和 AG 帶起來，主要是透過這三行指令 -a ingress-appgw --appgw-name myApplicationGateway --appgw-subnet-prefix \"10.2.0.0/16\" </p>\n<p>完整範例如下，若要透過指令建置，可以參考小弟的<a href=\"http://skychang.github.io/2020/10/19/Azure-Create_Azure_Kubernetes_Service/\">這篇</a></p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># 建立 AKS 時，自動產生 AG</span>\naz aks create <span class=\"token punctuation\">\\</span>\n-n myCluster <span class=\"token punctuation\">\\</span>\n-g myResourceGroup <span class=\"token punctuation\">\\</span>\n--network-plugin azure <span class=\"token punctuation\">\\</span>\n--enable-managed-identity <span class=\"token punctuation\">\\</span>\n-a ingress-appgw <span class=\"token punctuation\">\\</span>\n--appgw-name myApplicationGateway <span class=\"token punctuation\">\\</span>\n--appgw-subnet-prefix <span class=\"token string\">\"10.2.0.0/16\"</span> <span class=\"token punctuation\">\\</span>\n--generate-ssh-keys</code></pre></div>\n<p><a href=\"https://docs.microsoft.com/zh-tw/azure/application-gateway/tutorial-ingress-controller-add-on-new\">官網參考資料</a></p>\n<h3>方案二 已經有 AG 的情況下</h3>\n<p>這個情境是，當我們已經有 AG 的情況下，希望附加到 AKS 上。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># 設定 appgwId</span>\n<span class=\"token assign-left variable\">appgwId</span><span class=\"token operator\">=</span>xxxxx/xxxxxx/xxxxx\n\n<span class=\"token comment\"># 懶惰一點也可以直接透過底下指令</span>\n<span class=\"token assign-left variable\">appgwId</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span>az network application-gateway show -n AG-AKS-Study4Dev-JE -g study4dev-je -o tsv --query <span class=\"token string\">\"id\"</span><span class=\"token variable\">)</span></span> \n\n<span class=\"token comment\"># 啟用 agic addons</span>\naz aks enable-addons <span class=\"token punctuation\">\\</span>\n-n aks-study4dev-je <span class=\"token punctuation\">\\</span>\n-g study4dev-je <span class=\"token punctuation\">\\</span>\n-a ingress-appgw <span class=\"token punctuation\">\\</span>\n--appgw-id <span class=\"token variable\">$appgwId</span>\n\n<span class=\"token comment\"># 若想關閉可以透過底下關閉</span>\naz aks disable-addons <span class=\"token punctuation\">\\</span>\n-n aks-study4dev-je <span class=\"token punctuation\">\\</span>\n-g study4dev-je <span class=\"token punctuation\">\\</span>\n-a ingress-appgw</code></pre></div>\n<p><a href=\"https://docs.microsoft.com/zh-tw/azure/application-gateway/tutorial-ingress-controller-add-on-existing\">官網參考資料</a></p>\n<h3>完成與測試</h3>\n<p>完成後，會產生一個監控用的 Pod。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/0d9c3201857eddc24e6813636411feec/ace50/2020-11-04-00-00-55.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 62.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsSAAALEgHS3X78AAACiklEQVQ4yz1T2W7UQBD0t+z6GN8ej6/1td7sESFBSCKFvCGBEoXzEfGAEEe+hHcS4AuLmnGUh1bb7emarqq2dbw/YBo3GLoeUtVIZIUwyU3o51SWSOoJ0+dfONz+w+HnPeMvjm//YPh6h/bLb+x/3GPz7Q677/ewthc36F58QPX8Gl5SYuEILL3AhC0i1gosmZd+jIWI4acFIl7kxTmCVJlwgpTfIqimhzVdvsXu5SfUZzeIywFxXkJwOjfM+FyZiPLCNLphChFnSIsGKdnoHJizqbm00IBlM2Ddr1GwKUpJUx8uVmwk7Yx0ixqikGYq/6E5r1okBIy1HMxhVsz1uiNgv0O/3qGsB4SkE+f1A6DkVLxEkZ7KDJgXSXhsbLo1Vv1kcsYB8nJlsp7Yqts1hvWegL2hFZFioho2Z6SjEFICV6UzGGt6Et3TjUdoh42J4qHXAHbj1gDmLG5XA842O5xuDzhuezzhBE+nDSlWsIOE4scGVIOM0w4tp6zbEYoSaC213lbbb9ATVFUddazQU4eGukiKr3NTNcYIDeTF85QlxS85ZU79k7JDxt6EvZq2pfUbpj3q1WjGDknXpxkLromghgEp22FsDNJGuQQMS0qSt4wOQudYweZ5bZClgdr+CBVviwhg3KMx2hRjEk1xosQYpGtaw4DfPb67BHKorUOwR0BNtW4n47JejZTvERsc7mEkCU4HHVLWtYBTatoZtyDiysxRPQ6gV86SqURVVFBSQXg+/CCEJ3wsFkt4noAIAizsJesRhB/CdlxImSPP6WqaQYjA9NiuQJRk1PDiHcbLjxj4+3UX79Gcv0HJ33COqzmfXKHW9dNrqJPXyJ/NIR/zK6jzt6hPr/Af552sjH6jP7YAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"2020 11 04 00 00 55\"\n        title=\"2020 11 04 00 00 55\"\n        src=\"/static/0d9c3201857eddc24e6813636411feec/78d47/2020-11-04-00-00-55.png\"\n        srcset=\"/static/0d9c3201857eddc24e6813636411feec/56d15/2020-11-04-00-00-55.png 200w,\n/static/0d9c3201857eddc24e6813636411feec/d9f49/2020-11-04-00-00-55.png 400w,\n/static/0d9c3201857eddc24e6813636411feec/78d47/2020-11-04-00-00-55.png 800w,\n/static/0d9c3201857eddc24e6813636411feec/64756/2020-11-04-00-00-55.png 1200w,\n/static/0d9c3201857eddc24e6813636411feec/ace50/2020-11-04-00-00-55.png 1406w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>若要簡單測試，可以安裝底下的 yaml</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># 安裝 asp.net pod ，裡面包含 ingress</span>\nkubectl apply -f https://raw.githubusercontent.com/Azure/application-gateway-kubernetes-ingress/master/docs/examples/aspnetapp.yaml \n\n\nkubectl get ingress\n\n<span class=\"token comment\"># 測試完成後刪除 asp.net pod</span>\nkubectl delete -f https://raw.githubusercontent.com/Azure/application-gateway-kubernetes-ingress/master/docs/examples/aspnetapp.yaml </code></pre></div>\n<p>Note : 目前不確定是否因小弟的 AKS 有開 AAD 整合，所以 AGIC 會出現</p>\n<p> <code class=\"language-text\">403 錯誤 Unexpected status code &#39;403&#39; while performing a GET on Application Gateway. You can use .....</code></p>\n<p> 的錯誤，所以要針對 Resource 加入 Reader 的權限，而 AG 要給予 Contributor 的權限。</p>\n<p> 指令下完後，要稍微等一下，等待權限生效。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/e8d624cdbbd483c92d296012914bd84a/ace50/2020-11-04-00-14-08.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 62.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsSAAALEgHS3X78AAACqElEQVQ4y22T204TURSG5yWMIvQwnfP0NDNtpwOpWCwUEVARC3JoyyFKIRgERROhgIn6AOqN+iBGE6MX6o08g5RDW/QlfteeKYaoF1/+ddors/ZewznpNEwrCdNMQA9HoekRKKruomoRIgw1YsAankXqxiJsxugS0qOLMK9XYFyruPHESAVOYRlcqjsPNZaCrMXACzICvIhgyCMkKpCoqSCpEGWNVCPVXeUpx+IM9xzVx+mjODOTx/DIOArjUxgtTLrcHPN0YqqMYmkO08VZV0vleUxOzeBmYQKFsZO6CYzdmkb/wDAMt2HCxu73XdQbDdRqNRwcHqJer7dooNls4uiojgbl9/cPsLdXo7p9VxksdvzzF758/Qbb6QR3MdeP9YePYCZScLoyiBkWtGgcCt0nQ48ZkOheGSLdZ5BGDQhSCxm8pOCcL4C52wvI9ebB9eTyWLm3BoWKI9RIJrU1HZ2KApshy4TiklYYKtJqC/IdTYPF81hdWEAPa5i91IvVtQdQ9TDC0RhU+qp0PI4uw4BNfjoW+0edWBypcARJOuNQrUXNVyoVZHN9XsO1++tus2jcRIRGVCPU+NTY8l/K8hJNIrLVIjtIY8/fqXgj5/ouY2n5Ljr8QVoZAf5gCL4AT8pTLODS3uF38+0+v+uzfFu7D23nO1z7zNk22oKy1zBzIYvXb95ie+cJnj57jur2DjarW6hubWODdGOz6nFik7L8440qsenZFH/x8hUy3VlwVtLBx0+faW2a+MFWga0GrYVrs/U45f+JtahRjsUazWO8e/8BbAU5jV4xqusI08XKQgiKJEIRBYghHhL5siRACAUhU0xuxTVFhk6osgSpVSfQS4fpxTn76hxSDPpXk4Q1WIZ5pdSi6DFQhDXkxY2B6f8zOAN7qITfV9EABpD/ju8AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"2020 11 04 00 14 08\"\n        title=\"2020 11 04 00 14 08\"\n        src=\"/static/e8d624cdbbd483c92d296012914bd84a/78d47/2020-11-04-00-14-08.png\"\n        srcset=\"/static/e8d624cdbbd483c92d296012914bd84a/56d15/2020-11-04-00-14-08.png 200w,\n/static/e8d624cdbbd483c92d296012914bd84a/d9f49/2020-11-04-00-14-08.png 400w,\n/static/e8d624cdbbd483c92d296012914bd84a/78d47/2020-11-04-00-14-08.png 800w,\n/static/e8d624cdbbd483c92d296012914bd84a/64756/2020-11-04-00-14-08.png 1200w,\n/static/e8d624cdbbd483c92d296012914bd84a/ace50/2020-11-04-00-14-08.png 1406w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># 對 Resource 給予 Reader 的權限</span>\naz role assignment create --role Reader --scope /subscriptions/xxxx-xxxx/resourceGroups/Study4Dev-JE --assignee xxxx\n\n<span class=\"token comment\"># 對 AG 給予 Contributor 的權限</span>\naz role assignment create --role Contributor --scope /subscriptions/xxxx/resourceGroups/Study4Dev-JE/providers/Microsoft.Network/applicationGateways/AG-AKS-Study4Dev-JE --assignee xxxx</code></pre></div>\n<p>最後，透過 Ingress 的 Public IP，就可以進行簡單的測試。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/cdd6e1c4f61699970bc454d0530e7f11/ace50/2020-11-04-00-16-38.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 59.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsSAAALEgHS3X78AAABSUlEQVQoz51SiZKCMAzl09ZVWHAVj5n9fFkV8AAtR4UKqG+bOjp4O5uZN0lD8poXqnU6FgZ9G71eF10Z210LnW8LhtGUaMEyW9BbDRh6A18G4RN680PlTVOHben4GfYxHNhot01o8/kMcRxhOp3A81zQOQxDJEmMNE2x2XBwnso4AWNrRBEDlzF9J9BZgTGs1wxaUZS4Z0EQwnF+4fszTF1PXrSAP5srv1gu8ci0LM9VcDgcLrDdbpFlGfJcwPN9uJKUckVRyFyO/X5/00PQqKFOSEbFQghFQD5NuZSXqPh4SY5qt7s7yMWEdR9FMVzPO0+6DAJFWJYlqqq6qH0pmWy1WskdOhiNHPkzmNxpgPF4gpRzJfta1UtCmuQk8TQZSaWYVvI24SMp11avfbrDesMzPH42UtI7BO/iTCjE8YlsRIlyRxP8j/APhbiDEt8EIwQAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"2020 11 04 00 16 38\"\n        title=\"2020 11 04 00 16 38\"\n        src=\"/static/cdd6e1c4f61699970bc454d0530e7f11/78d47/2020-11-04-00-16-38.png\"\n        srcset=\"/static/cdd6e1c4f61699970bc454d0530e7f11/56d15/2020-11-04-00-16-38.png 200w,\n/static/cdd6e1c4f61699970bc454d0530e7f11/d9f49/2020-11-04-00-16-38.png 400w,\n/static/cdd6e1c4f61699970bc454d0530e7f11/78d47/2020-11-04-00-16-38.png 800w,\n/static/cdd6e1c4f61699970bc454d0530e7f11/64756/2020-11-04-00-16-38.png 1200w,\n/static/cdd6e1c4f61699970bc454d0530e7f11/ace50/2020-11-04-00-16-38.png 1406w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h2>關於自行定義的 Ingress</h2>\n<p>關於 AGIC 的 ingress 定義 sample，可以參考底下，底下有完整的 pod、svc 和 ingress。從這個 sample 可以看到 ingress 是讓所有 / 路徑，全部對應到 aspnetapp svc 。</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Pod\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> aspnetapp\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> aspnetapp\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"mcr.microsoft.com/dotnet/core/samples:aspnetapp\"</span>\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> aspnetapp<span class=\"token punctuation\">-</span>image\n    <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">containerPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span>\n      <span class=\"token key atrule\">protocol</span><span class=\"token punctuation\">:</span> TCP\n\n<span class=\"token punctuation\">---</span>\n\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Service\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> aspnetapp\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> aspnetapp\n  <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">protocol</span><span class=\"token punctuation\">:</span> TCP\n    <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span>\n    <span class=\"token key atrule\">targetPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span>\n\n<span class=\"token punctuation\">---</span>\n\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> extensions/v1beta1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Ingress\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> aspnetapp\n  <span class=\"token key atrule\">annotations</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">kubernetes.io/ingress.class</span><span class=\"token punctuation\">:</span> azure/application<span class=\"token punctuation\">-</span>gateway\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">rules</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">http</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">paths</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> /\n        <span class=\"token key atrule\">backend</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">serviceName</span><span class=\"token punctuation\">:</span> aspnetapp\n          <span class=\"token key atrule\">servicePort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span></code></pre></div>\n<p>若要將特定路徑對應到特定 domain ，可參考底下 ingress 範例。</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> extensions/v1beta1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Ingress\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> go<span class=\"token punctuation\">-</span>server<span class=\"token punctuation\">-</span>ingress<span class=\"token punctuation\">-</span>timeout\n  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> test<span class=\"token punctuation\">-</span>ag\n  <span class=\"token key atrule\">annotations</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">kubernetes.io/ingress.class</span><span class=\"token punctuation\">:</span> azure/application<span class=\"token punctuation\">-</span>gateway\n    <span class=\"token key atrule\">appgw.ingress.kubernetes.io/backend-hostname</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"internal.example.com\"</span>\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">rules</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">http</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">paths</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> /hello/\n        <span class=\"token key atrule\">backend</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">serviceName</span><span class=\"token punctuation\">:</span> go<span class=\"token punctuation\">-</span>server<span class=\"token punctuation\">-</span>service\n          <span class=\"token key atrule\">servicePort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span></code></pre></div>\n<p>更多範例請參考 <a href=\"https://github.com/Azure/application-gateway-kubernetes-ingress/blob/master/docs/annotations.md\">AGIC GitHub 文件</a></p>\n<h2>後記</h2>\n<p>其實東西不難，但最近在看 Azure 的時候，越來越發現，有很多的細節要注意，所以花了很長時間，終於寫完 (泣)。另外，採用 AGIC 當然是一種作法，但如果你喜歡內建 Pod 來使用 ingress 的方式，也是可以的，這邊，就帶給大家囉。</p>\n<h2>參考資料</h2>\n<ul>\n<li><a href=\"https://docs.microsoft.com/zh-tw/azure/application-gateway/ingress-controller-overview\">https://docs.microsoft.com/zh-tw/azure/application-gateway/ingress-controller-overview</a></li>\n<li><a href=\"https://docs.microsoft.com/zh-tw/azure/application-gateway/tutorial-ingress-controller-add-on-existing\">https://docs.microsoft.com/zh-tw/azure/application-gateway/tutorial-ingress-controller-add-on-existing</a></li>\n<li><a href=\"https://github.com/Azure/application-gateway-kubernetes-ingress\">https://github.com/Azure/application-gateway-kubernetes-ingress</a></li>\n<li><a href=\"https://docs.microsoft.com/en-us/cli/azure/network/public-ip?view=azure-cli-latest#az_network_public_ip_create\">https://docs.microsoft.com/en-us/cli/azure/network/public-ip?view=azure-cli-latest#az<em>network</em>public<em>ip</em>create</a></li>\n<li><a href=\"https://docs.microsoft.com/zh-tw/azure/virtual-network/manage-public-ip-address-prefix\">https://docs.microsoft.com/zh-tw/azure/virtual-network/manage-public-ip-address-prefix</a></li>\n<li><a href=\"https://github.com/Azure/application-gateway-kubernetes-ingress/blob/master/docs/annotations.md\">https://github.com/Azure/application-gateway-kubernetes-ingress/blob/master/docs/annotations.md</a></li>\n<li><a href=\"https://docs.microsoft.com/en-us/cli/azure/network/application-gateway?view=azure-cli-latest#az_network_application_gateway_create\">https://docs.microsoft.com/en-us/cli/azure/network/application-gateway?view=azure-cli-latest#az<em>network</em>application<em>gateway</em>create</a></li>\n<li><a href=\"https://docs.microsoft.com/zh-tw/azure/application-gateway/tutorial-ingress-controller-add-on-existing\">https://docs.microsoft.com/zh-tw/azure/application-gateway/tutorial-ingress-controller-add-on-existing</a></li>\n<li><a href=\"https://docs.microsoft.com/en-us/cli/azure/network/application-gateway?view=azure-cli-latest#az_network_application_gateway_create\">https://docs.microsoft.com/en-us/cli/azure/network/application-gateway?view=azure-cli-latest#az<em>network</em>application<em>gateway</em>create</a></li>\n<li><a href=\"https://docs.microsoft.com/zh-tw/azure/application-gateway/configuration-infrastructure#size-of-the-subnet\">https://docs.microsoft.com/zh-tw/azure/application-gateway/configuration-infrastructure#size-of-the-subnet</a></li>\n</ul>","excerpt":"前言 用過 K8S 的朋友都知道，目前讓 K8S 對外提供端點，不外乎透過 ClusterIP、Nodeport、Load Balancer、Ingress 這幾種方法，而地端 K8S 下，最常用的應該就是 NodePort，畢竟地端的 Load Balancer 需要自建 QQ…"}},"pageContext":{"type":"posts","next":{"frontmatter":{"path":null,"title":"Azure - AKS - Spot Node Pool","tags":["Azure","Container","Kubernetes","Docker","Linux","AKS"]},"fields":{"slug":"/2020/10/31/Azure-AKS_Sport_Node_Pool/"},"fileAbsolutePath":"/home/runner/work/blog.sanc.idv.tw/blog.sanc.idv.tw/src/posts/Azure-AKS_Spot_Node_Pool/Azure-AKS_Sport_Node_Pool.md"},"previous":{"frontmatter":{"path":null,"title":"AzureDevOps - 關於 SSH Key","tags":["AzureDevOps","SSH","Git"]},"fields":{"slug":"/2020/11/16/AzureDevOps-About_SSH_Key/"},"fileAbsolutePath":"/home/runner/work/blog.sanc.idv.tw/blog.sanc.idv.tw/src/posts/AzureDevOps-About_SSH_Key/AzureDevOps-About_SSH_Key.md"}}}}