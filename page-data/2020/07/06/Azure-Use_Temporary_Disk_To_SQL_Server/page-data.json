{"componentChunkName":"component---src-templates-page-js","path":"/2020/07/06/Azure-Use_Temporary_Disk_To_SQL_Server/","result":{"data":{"markdownRemark":{"frontmatter":{"title":"Azure - 在 Azure SQL Server VM 上使用 Temporary Disk","date":"06 July 2020","author":"Sky Chang","excerpt":"","tags":["Azure","VM","SQL Server"],"coverImage":null},"id":"ac84f828-d8c5-541c-8a15-26687f17676c","html":"<h2>前言</h2>\n<p>最近在 Azure 上重建自己的 Azure DevOps Server 2019 的環境，然後既赫然發現，VM 出到 V4 的版本了，當然，V4 不算是什麼大新聞，畢竟隨著時間，一路出，出到 V8 到 XG 都有可能呢 ( 謎之聲 : XG 是啥鬼 )，不過在看 V4 的時候，發現了幾個有趣的東西，第一個，當然就是 AMD 的 CPU 規格的 <a href=\"https://docs.microsoft.com/zh-tw/azure/virtual-machines/dav4-dasv4-series\">Da 系列</a> ( DaV4 和支援 SSD 的 DasV4 )，畢竟現在 AMD 如日中天，連 Linux 之父，還有<a href=\"https://columns.chicken-house.net/\">好朋友安神</a>，都開始使用 AMD 呢，當然，除了 AMD 外，還有 Intel 規格的 <a href=\"https://docs.microsoft.com/zh-tw/azure/virtual-machines/ddv4-ddsv4-series\">Dd 系列</a> ( DdV4 和支援 SSD 的 DdsV4 )，不過這一樣也不意外，畢竟 Intel CPU 從以前到現在，已經很多代了。那最讓人意外的就是 <a href=\"https://docs.microsoft.com/zh-tw/azure/virtual-machines/azure-vms-no-temp-disk\">Dv4 系列</a> 那著個系列有什麼特別的呢，是的，他預設沒有包含 Temporary Disk..，換言之開啟這系列後，那預設的不能存東西的謎之 D 槽，就不會出現了!!當然，沒有 Temporary Disk 也比較便宜。</p>\n<p>Note : V3 之前，Dv3 或是 Dsv3 都包含 Temporary Disk 的，但 V4 開始， Dv4 和 Dsv4 卻不包含，然後有包含的名稱改為 Ddv4 和 Ddsv4 ( 搞得我好混亂啊!! )</p>\n<p>好，也因為新出的版本，有不包含 Temporary Disk 版本，所以小弟就特別跑去問了一下 Dino 哥，為什麼要出這個版本和使用情境，總而言之，就是 <strong>沒有 Temporary Disk</strong> 的比較便宜，而有很多情況下，大家也不一定會使用到 Temporary Disk。</p>\n<p>而有些追求效能者，就可能會把一些暫存的東西放到 Temporary Disk 裡面去，例如下載檔案時，可能動態產生的暫存檔，又或是 SQL Server 的 TempDB 等等。</p>\n<p>所以，這篇主要就以 SQL Server 為範例，將 TempDB 放到 Temporary Disk 來提升效能。</p>\n<h2>效能與限制</h2>\n<p>沒錯，放到 Temporary Disk 上，效能會比較好喔，但，為什麼？放到 C 不是也應該一樣快嗎，其實 Azure VM 上的 Disk，為了讓 VM 升級，關機等等動作，還能保留原本的檔案，所以掛載上去的 C，其實就是 Azure Storage ( 也不意外啦，大家應該也都知道了 )，但畢竟 Storage 不是在本機 VM 上，而 Temporary Disk 則是直接從實體的那台機器開出來的 D 槽，所以效能來說，Temporary Disk 是會比較快的。</p>\n<p>但也因為是從實體開出來的 D 槽，所以當你的 VM 關閉、升級等等情況，D 槽的東西，自然也就會不見了，畢竟 VM 換位置了嘛，也因此，Temporary Disk 適合這種暫存的這種情境。</p>\n<p>接下來，就是簡單的 SQL Server on Azure VM 調整方案。</p>\n<h2>將 TempDB 轉移到 D</h2>\n<p>第一步驟很簡單，就只是將 TempDB 轉到 D，我們可以透過 SSMS 等工具，執行底下的指令。\n當然，前提要先在 D 建立 SQLTemp，或是大家喜歡的目錄。</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">USE</span> MASTER\n\nGO\n\n<span class=\"token keyword\">ALTER</span> <span class=\"token keyword\">DATABASE</span> tempdb <span class=\"token keyword\">MODIFY</span> <span class=\"token keyword\">FILE</span> <span class=\"token punctuation\">(</span>NAME<span class=\"token operator\">=</span> tempdev<span class=\"token punctuation\">,</span> FILENAME<span class=\"token operator\">=</span> <span class=\"token string\">'D:\\SQLTemp\\tempdb.mdf'</span><span class=\"token punctuation\">)</span>\nGO\n\n<span class=\"token keyword\">ALTER</span> <span class=\"token keyword\">DATABASE</span> tempdb <span class=\"token keyword\">MODIFY</span> <span class=\"token keyword\">FILE</span> <span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> templog<span class=\"token punctuation\">,</span> filename <span class=\"token operator\">=</span> <span class=\"token string\">'D:\\SQLTemp\\templog.ldf'</span><span class=\"token punctuation\">)</span>\nGO</code></pre></div>\n<h2>在 SSD 中配置緩衝池擴展</h2>\n<p>完成後，繼續設定，這邊要設定 <a href=\"https://docs.microsoft.com/zh-tw/sql/database-engine/configure-windows/buffer-pool-extension?view=sql-server-ver15\">Buffer Pool Extension</a>，這邊的大小，建議是 VM Ram 的 4~6 倍。</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">ALTER</span> SERVER CONFIGURATION\n\n<span class=\"token keyword\">SET</span> BUFFER POOL EXTENSION <span class=\"token keyword\">ON</span>\n\n<span class=\"token punctuation\">(</span> FILENAME <span class=\"token operator\">=</span> <span class=\"token string\">'D:\\SQLTemp\\ExtensionFile.BPE'</span> <span class=\"token punctuation\">,</span> SIZE <span class=\"token operator\">=</span> <span class=\"token number\">128</span> GB <span class=\"token punctuation\">)</span></code></pre></div>\n<h3>將 SQL Server 服務從自動改成手動</h3>\n<p>因為關機後， D:\\SQLTemp 就會消失，而 SQL Server 不會自己建立此目錄，而此時若 SQL Server 啟動後，就會 GG 了，所以我們要將 SQL Server 改為手動啟用，當我們把 D:\\SQLTemp 準備好後，再啟動 SQL Server。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 416px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/d0ab45f16e82369467bcde8958e7ed37/5d0f3/2020-07-07-00-18-13.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 121%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAYCAYAAAD6S912AAAACXBIWXMAAAsSAAALEgHS3X78AAADuElEQVQ4y61V2a4bRRD1B/GGhPIB/Er4FB54ACFQXnhOHpAigsILCiFyhIhtwDfX9r22Z/EynsWeubNvnsU+VPWMnXuzIJBo6bjaNd3VVXWqqzvLxQLL5RKr1VpIRVGhKgokaQ5VVWHoOmRZRr7fI8/zM7IsE9LzPOQ0D4KAbKzQsW0bPimjKCZEYgHrbm4cwo3Q8fc9GWQjDJ4XRSEQx7EwzHPTNNGxLAu+72MyHuP6ekreqbi6ukJ/MMBoNIJDRl3XhePY6Pf76Ha7sKytOMwjfb/Xw2w+R5qmIiIyaAp3rydjzGZzOOTddrtFGIYoyxKKLEHTNNR1JTbtdjuKYCfWjy4vMRj0ISsyrQ9Eyjr8IysLaLqJjbFFEKbw/FhIgSg9z8Mogx8m4rvrhYToLD0/ErnvrNcaheWTVzYlVYO2MVCUNQ4HkFctaB5GCYXu0+YAFekOxwb8jYTYw+R1FsSyTp7p5g5+kCCMicF9TazeQlEjyUoB/p+2c5ZZXiFJiZwkpwohg5uNTosqsJQkmT5m4HGg4084kgtxnFAUO5hESBCERGQoJMMjUn0/oNRRyBuqsyTdY7FcYWc7qMhARXHcRk063mi3hMVJ0pQQkcQH8aFVVTUhs2f7LMfW1PFPIwx8MugQ02woE1XANRqFER3KOT80Bh3LQFeO8fnPBr544eCzxxbBvIP7pPvlzzluqFyObTqOxzdgY3yYJElUh6aBuZXg0UsZD7tzfPdCxeNRgCdXEZ5MIvxA+HGa4tVwjPVSBXNaFntUZdFij5pk4HunkA0RsraQEHsOmiJ4d6zWa7zsDREyqyWRVByREIQsj8jKQ3NTdN1AQpQvqR4tYrEmexWFcCKn5EKjQ7761cSnDyR8/LWCe9+o+KTFvW9VfPSlgvvf035twQZ1kYfTuJ2bE9hglBXwkgJ2lMMO3wLpHLpJCpfNyeCbze+OD6jvjkN7U9ggs/Q+z97G4X1oC58bydng/zHquj6xvIHb9jwuVm6YLLml/Ve0Odzg+bNnePr0J1GY3Mb5evEB3ET/LbjTc6Pp8Jsxn89w8fo1xtShB4M/RCtnL31x6f07XnxIx1LUodhMf7hjhBGHGwnvXLdJAy++/f9koNG55zWsFx3bppZu2D5m6y0Gl1NcTFXMNBsa9Ud9o4n3gonjNPDhY3p7uM3xW8Q6/jaZTGAYZnOXHbrwS8vFhWzg+e9D/Da8xlA2Ia8MrBYq/hoOm+fUMLCm69frvcKQdPzOsI6f4QE9aEvK/XQ6xd8MhgYh7H4lTgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"2020 07 07 00 18 13\"\n        title=\"2020 07 07 00 18 13\"\n        src=\"/static/d0ab45f16e82369467bcde8958e7ed37/5d0f3/2020-07-07-00-18-13.png\"\n        srcset=\"/static/d0ab45f16e82369467bcde8958e7ed37/56d15/2020-07-07-00-18-13.png 200w,\n/static/d0ab45f16e82369467bcde8958e7ed37/d9f49/2020-07-07-00-18-13.png 400w,\n/static/d0ab45f16e82369467bcde8958e7ed37/5d0f3/2020-07-07-00-18-13.png 416w\"\n        sizes=\"(max-width: 416px) 100vw, 416px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h3>建立 PS 檔案</h3>\n<p>接下來，我們要建立一個 PowerShell 的檔案，這個檔案會幫我們建立 D:\\SQLTemp，而且還會啟動 SQL Server。</p>\n<p>我們就建立在 C:\\ 下吧，就把它叫做 SQLServerInit.ps1。</p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\"><span class=\"token variable\">$SQLService</span>=<span class=\"token string\">\"SQL Server (MSSQLSERVER)\"</span>\n<span class=\"token variable\">$SQLAgentService</span>=<span class=\"token string\">\"SQL Server Agent (MSSQLSERVER)\"</span>\n<span class=\"token variable\">$tempfolder</span>=<span class=\"token string\">\"D:\\SQLTemp\"</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token punctuation\">(</span><span class=\"token function\">test-path</span> <span class=\"token operator\">-</span>path <span class=\"token variable\">$tempfolder</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">New-Item</span> <span class=\"token operator\">-</span>ItemType directory <span class=\"token operator\">-</span>Path <span class=\"token variable\">$tempfolder</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token function\">Start-Service</span> <span class=\"token variable\">$SQLService</span>\n<span class=\"token function\">Start-Service</span> <span class=\"token variable\">$SQLAgentService</span></code></pre></div>\n<p>完成之後，我們要修改一下執行 PowerShell 的權限，執行底下指令，這樣剛剛的 SQLServerInit.ps1 才能順利執行。</p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\"><span class=\"token function\">Set</span><span class=\"token operator\">-</span>ExecutionPolicy RemoteSigned</code></pre></div>\n<h3>加上開機啟動排程</h3>\n<p>最後一步驟，我們只要在 Windows Server 上，打開工作排程器，並建立一個基本工作，如下圖，讓他開機的時候，能執行我們上述的 Init。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 696px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/bcabfe5bc97e5fe438e9410517148385/64252/2020-07-07-01-36-11.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 74.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsSAAALEgHS3X78AAABzUlEQVQ4y6VU227aQBT0//9AHpovSKXmva9V0lYhEAKBYuMr2F4b3+2GAAqTnU1sEYkUVbE0Ot7js+PxnLPWHEvHcrmEbduo6wbb7Rabzea/wX1FUUALrHsIESLNMnz2Iqn2uN5gt9upBa/9fv85wsnkAYZpIcsLVHUt0SjpRJqmCMMQcRwjf8t9hLIssVqtoPV/X0F4Fp7XFXZ/c+yfaiw9F5b0VAgB0zThOA5EFCE6gcViAe3y1xxn36e46AmFr7cR7CBBkaXKV76Z+Je6PM9VDQVo33o+zq8FvlyFCufXIawwQ1OVSJJEFROnCBkV4WOZAE8VsC471CWLXj1sCU+hI4ziFVK5OcnyDm1RS1icaEjbFEXIzhzKbiMLSJhJH5lj5Poj8HkQBO8JW3ODwMd0OsVsNsNoNOrATlLFMXRdPkbo+74aE9d1MRwOYRgGdF2HZVmYG3PYMpKAe6Mo7kaKR/gIYSXf5GEwGOBhPEa/38fg7k4REze9Hv5I5SQI5SdmaYLqbbTUYPMUHBLyPpbFnucppYz0hur4A6G6Nmc6siZKEKfcl6sT9Y7wcEirqurAdS2PZdM0ynz6S0/vdRc/ft5gZHgyN5G5MV4A4R5nzTc5OoIAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"2020 07 07 01 36 11\"\n        title=\"2020 07 07 01 36 11\"\n        src=\"/static/bcabfe5bc97e5fe438e9410517148385/64252/2020-07-07-01-36-11.png\"\n        srcset=\"/static/bcabfe5bc97e5fe438e9410517148385/56d15/2020-07-07-01-36-11.png 200w,\n/static/bcabfe5bc97e5fe438e9410517148385/d9f49/2020-07-07-01-36-11.png 400w,\n/static/bcabfe5bc97e5fe438e9410517148385/64252/2020-07-07-01-36-11.png 696w\"\n        sizes=\"(max-width: 696px) 100vw, 696px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>另外，也別忘記調整成，不需要此帳號登入，就會執行。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 632px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/14385d55c2ce9962cc81da6a6e6d83a6/afa26/2020-07-07-01-36-43.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 80.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsSAAALEgHS3X78AAACQklEQVQ4y41U2ZLaMBD0//9WHvJANlS4UtysjQ/wjW18gN2ZHq8TUiEkqmokS5qe1hwYrufCtm2czz5OngfLtDCfz5GmFzRNg7qucbvdUFXVP5GmKQzfD5AkCRaLBZbLpZITjuPgeDzCNE1MJhNEUYTL5aJGr2BEUajGoRis12uFZR0RhAF831d4ojwMQyUNn0D35ZzCjEAM+Ny2bRHLQRLHchDjIt4u6jXpZ7nM/fQJ+v0EWZb1hHGcCGEHxzvj3bJxdDyYR0fgIk5zlM0d1/r2ErxTXEvG0IdrO8iKEum1QXPvUDUtqluLmpDv5j9Q3YEkF0IGmqMVlA1/O3TdL/x9yFn3AVnLAxFnQpgkKXJ5+0myndUdauEsxZvONyAX13n9OwpF+wDut73CWJKw3++x3W7Btee6CINAMm3pt2rpHtR8KG/vd9wFnJlQ7lelKkzgCslms1GwFjfrjZSSq2VwvV5RFAKZuS7FiPvj8Rij0Qhf394wm82Fw9NzI5ZDZnq5XClYyPvdDnle/Bk1KhM1BDvoEVRLZwaLkvW3E5LVqic8SAjYJVHYFyw7gKVFo58heDKUkJfpwTTfMZ1N4UuRV1X/LF+L/qyxDIX8ZdJlsJ8NdgZjyPZjpRfyVILeIlFHMoIvGVqRTnK9m0toMrUbYPBJ59NJPwbZNAok01tJEivgcDhoSIb1drfHzrSxtxxYtiuC5I9E/lDIZVAdn6fE4plEQ7MzYYPCAexdL4jx+dsan75M8f3gScy3mEynGvcfO0nEvpKfLzAAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"2020 07 07 01 36 43\"\n        title=\"2020 07 07 01 36 43\"\n        src=\"/static/14385d55c2ce9962cc81da6a6e6d83a6/afa26/2020-07-07-01-36-43.png\"\n        srcset=\"/static/14385d55c2ce9962cc81da6a6e6d83a6/56d15/2020-07-07-01-36-43.png 200w,\n/static/14385d55c2ce9962cc81da6a6e6d83a6/d9f49/2020-07-07-01-36-43.png 400w,\n/static/14385d55c2ce9962cc81da6a6e6d83a6/afa26/2020-07-07-01-36-43.png 632w\"\n        sizes=\"(max-width: 632px) 100vw, 632px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>完成後，就是重開機試試看了，順利的話，就會使用 D:\\SQLTemp。</p>\n<h2>後記</h2>\n<p>這邊只是簡單的使用 SQL Server TempDB 來當作範例，但其實還是有很多地方的快取可以存放在這邊喔，當然，還是要注意，關機就沒了喔。</p>\n<h2>參考資料</h2>\n<ul>\n<li><a href=\"https://cloudblogs.microsoft.com/sqlserver/2014/09/25/using-ssds-in-azure-vms-to-store-sql-server-tempdb-and-buffer-pool-extensions/\">https://cloudblogs.microsoft.com/sqlserver/2014/09/25/using-ssds-in-azure-vms-to-store-sql-server-tempdb-and-buffer-pool-extensions/</a></li>\n<li><a href=\"https://docs.microsoft.com/zh-tw/sql/database-engine/configure-windows/buffer-pool-extension?view=sql-server-ver15\">https://docs.microsoft.com/zh-tw/sql/database-engine/configure-windows/buffer-pool-extension?view=sql-server-ver15</a></li>\n</ul>","excerpt":"前言 最近在 Azure 上重建自己的 Azure DevOps Server 2019 的環境，然後既赫然發現，VM 出到 V4 的版本了，當然，V4 不算是什麼大新聞，畢竟隨著時間，一路出，出到 V8 到 XG 都有可能呢 ( 謎之聲 : XG 是啥鬼 )，不過在看 V…"}},"pageContext":{"type":"posts","next":{"frontmatter":{"path":null,"title":"Tye - 使用 Tye 管理 ASP.NET Core 專案","tags":["Tye","K8S","AKS","Container","Docker","SQLServer"]},"fields":{"slug":"/2020/06/21/Tye-Use_Tye_Manage_AspNetCore_Project/"},"fileAbsolutePath":"/home/runner/work/blog.sanc.idv.tw/blog.sanc.idv.tw/src/posts/Tye-Use_Tye_Manage_AspNetCore_Project/Tye-Use_Tye_Manage_AspNetCore_Project.md"},"previous":null}}}