{"componentChunkName":"component---src-templates-page-js","path":"/2015/12/02/VSTS-Build_for_Nodejs2/","result":{"data":{"markdownRemark":{"frontmatter":{"title":"VSTS - VSTS Build - Node.js 後篇","date":"02 December 2015","author":"Sky Chang","excerpt":null,"tags":["Azure","VSTS","CI/CD","JavaScript","Release Management","Node.js"],"coverImage":null},"id":"a60b28d1-dd5b-591c-bcca-00690c0c1bfd","html":"<h2>前言</h2>\n<p>在<a href=\"http://skychang.github.io/2015/12/01/VSTS-Build_for_Nodejs1/\">上一篇</a>我們進行了基本的設定，設定了 npm 流程，接著 gulp 然後再佈署到 Azure Web Site。</p>\n<p>但，如果是常寫 Node.js 的神人們，一定會知道，光是這樣是不夠的...</p>\n<p>那我們還欠缺甚麼呢??..</p>\n<ol>\n<li>gulp 的設定檔案</li>\n<li>給 Azure Web Site 用的 Web.config </li>\n<li>Azure Web Site 設定使用 Node.js 5.0.0 版本</li>\n</ol>\n<p>所以這篇，我們就來解決這些事情。</p>\n<h2>gulp 的設定</h2>\n<p>畢竟我們使用到 gulp 來 run 流程，所以當然要先設定 gulp ，而對於 gulp 不熟悉的朋友可以<a href=\"http://skychang.github.io/2014/11/02/JavaScript-%E4%BD%BF%E7%94%A8gulp%E4%BE%86%E5%BB%BA%E7%BD%AEJS/\">參考這篇</a>，礙於篇幅，小弟就不針對 gulp 做詳細的介紹了，請多見諒。</p>\n<p>如果大家仔細看底下的 Code ，大致上可以發現，require 的東西都還滿常見的，只有兩個是平常比較稍微沒用到的 <a href=\"https://www.npmjs.com/package/gulp-zip\">gulp-zip</a> 和 <a href=\"https://www.npmjs.com/package/minimist\">minimist</a> ，</p>\n<p>所以，在 run gulp 之前，我們可以先用 </p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">npm i gulp-zip minimist -D </code></pre></div>\n<p>來進行安裝。</p>\n<p>gulp-zip ，其實大家應該不難猜到，他就是負責幫我們進行打包的 package ，我們會用 gulp-zip 將所有檔案打包成 package.zip。</p>\n<p>那 minimist 是甚麼呢?</p>\n<p>他其實可以讓我們把參數變成物件寫在設定檔裡面，有興趣的可以參考<a href=\"https://jarvys.github.io/2014/06/01/minimist-js/\">這篇</a></p>\n<p>接下來，我們稍微看一下 Code ，首先，定義了一個 knownOptions 物件，這個物件裡面定義了 packageName 和 packagePath 路徑；接下來，我們透過 minimist 將此物件轉成參數物件；到時候會將參數提供給 gulp-zip 使用，簡單的說，就是告訴 gulp-zip ，壓縮後的檔案名稱是甚麼，要放在哪邊。</p>\n<p>接下來的 Code 就比較好玩一點，首先有一個 packagePaths 的陣列，裡面紀錄了哪些要壓縮，那些不要壓縮，** 代表全部要壓縮，但排除任何目錄底下的 _package ，底下的所有檔案 ( 同理可證 !<strong>/typings/</strong> )。</p>\n<p>那接下來，他又做了哪些事情哩...</p>\n<p>接著，他使用 fs 來把 package.json 讀進來，並且取出 package.json 裡面的 devDependencies，並且把這些全部都排除掉!!</p>\n<p>簡單的說，打包的 Package.zip 完全不包含 devDependencies 底下的 Package ，所以如果有誤放位置的，請移到 Dependencies 底下，不然 package 就不會傳上去了。</p>\n<p>最後，就透過 gulp 進行打包的動作....</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">var</span> gulp <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'gulp'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">var</span> path <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'path'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">var</span> zip <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'gulp-zip'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">var</span> minimist <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'minimist'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">var</span> fs <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'fs'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">var</span> knownOptions <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n\tstring<span class=\"token operator\">:</span> <span class=\"token string\">'packageName'</span><span class=\"token punctuation\">,</span>\n\tstring<span class=\"token operator\">:</span> <span class=\"token string\">'packagePath'</span><span class=\"token punctuation\">,</span>\n\t<span class=\"token keyword\">default</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>packageName<span class=\"token operator\">:</span> <span class=\"token string\">\"Package.zip\"</span><span class=\"token punctuation\">,</span> packagePath<span class=\"token operator\">:</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span>__dirname<span class=\"token punctuation\">,</span> <span class=\"token string\">'_package'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">var</span> options <span class=\"token operator\">=</span> <span class=\"token function\">minimist</span><span class=\"token punctuation\">(</span>process<span class=\"token punctuation\">.</span>argv<span class=\"token punctuation\">.</span><span class=\"token function\">slice</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> knownOptions<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\ngulp<span class=\"token punctuation\">.</span><span class=\"token function\">task</span><span class=\"token punctuation\">(</span><span class=\"token string\">'default'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n\t<span class=\"token keyword\">var</span> packagePaths <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'**'</span><span class=\"token punctuation\">,</span> \n\t\t\t\t\t<span class=\"token string\">'!**/_package/**'</span><span class=\"token punctuation\">,</span> \n\t\t\t\t\t<span class=\"token string\">'!**/typings/**'</span><span class=\"token punctuation\">,</span>\n\t\t\t\t\t<span class=\"token string\">'!typings'</span><span class=\"token punctuation\">,</span> \n\t\t\t\t\t<span class=\"token string\">'!_package'</span><span class=\"token punctuation\">,</span> \n\t\t\t\t\t<span class=\"token string\">'!gulpfile.js'</span><span class=\"token punctuation\">]</span>\n\t\n\t<span class=\"token comment\">//add exclusion patterns for all dev dependencies</span>\n\t<span class=\"token keyword\">var</span> packageJSON <span class=\"token operator\">=</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>fs<span class=\"token punctuation\">.</span><span class=\"token function\">readFileSync</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span>__dirname<span class=\"token punctuation\">,</span> <span class=\"token string\">'package.json'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'utf8'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">var</span> devDeps <span class=\"token operator\">=</span> packageJSON<span class=\"token punctuation\">.</span>devDependencies<span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">var</span> propName <span class=\"token keyword\">in</span> devDeps<span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">var</span> excludePattern1 <span class=\"token operator\">=</span> <span class=\"token string\">\"!**/node_modules/\"</span> <span class=\"token operator\">+</span> propName <span class=\"token operator\">+</span> <span class=\"token string\">\"/**\"</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token keyword\">var</span> excludePattern2 <span class=\"token operator\">=</span> <span class=\"token string\">\"!**/node_modules/\"</span> <span class=\"token operator\">+</span> propName<span class=\"token punctuation\">;</span>\n\t\tpackagePaths<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>excludePattern1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\tpackagePaths<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>excludePattern2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n\t\n    <span class=\"token keyword\">return</span> gulp<span class=\"token punctuation\">.</span><span class=\"token function\">src</span><span class=\"token punctuation\">(</span>packagePaths<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">pipe</span><span class=\"token punctuation\">(</span><span class=\"token function\">zip</span><span class=\"token punctuation\">(</span>options<span class=\"token punctuation\">.</span>packageName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">pipe</span><span class=\"token punctuation\">(</span>gulp<span class=\"token punctuation\">.</span><span class=\"token function\">dest</span><span class=\"token punctuation\">(</span>options<span class=\"token punctuation\">.</span>packagePath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>另外，怎麼可以只寫 gulp 忘記 webpack 勒!?\n底下是小弟改的 webpack 搭配 gulp 的版本，這邊就不解釋了，基本上邏輯和上面一樣。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">var</span> gulp <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"gulp\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">var</span> gutil <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"gulp-util\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">var</span> webpack <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"webpack\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">var</span> WebpackDevServer <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"webpack-dev-server\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">var</span> webpackConfig <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./webpack-dev.config'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">var</span> path <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'path'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">var</span> zip <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'gulp-zip'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">var</span> minimist <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'minimist'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">var</span> fs <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'fs'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">var</span> knownOptions <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n\tstring<span class=\"token operator\">:</span> <span class=\"token string\">'packageName'</span><span class=\"token punctuation\">,</span>\n\tstring<span class=\"token operator\">:</span> <span class=\"token string\">'packagePath'</span><span class=\"token punctuation\">,</span>\n\t<span class=\"token keyword\">default</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>packageName<span class=\"token operator\">:</span> <span class=\"token string\">\"Package.zip\"</span><span class=\"token punctuation\">,</span> packagePath<span class=\"token operator\">:</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span>__dirname<span class=\"token punctuation\">,</span> <span class=\"token string\">'_package'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">var</span> options <span class=\"token operator\">=</span> <span class=\"token function\">minimist</span><span class=\"token punctuation\">(</span>process<span class=\"token punctuation\">.</span>argv<span class=\"token punctuation\">.</span><span class=\"token function\">slice</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> knownOptions<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\ngulp<span class=\"token punctuation\">.</span><span class=\"token function\">task</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"webpack\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">callback</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// run webpack</span>\n    <span class=\"token function\">webpack</span><span class=\"token punctuation\">(</span>webpackConfig<span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">err<span class=\"token punctuation\">,</span> stats</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">gutil<span class=\"token punctuation\">.</span>PluginError</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"webpack\"</span><span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        gutil<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"[webpack]\"</span><span class=\"token punctuation\">,</span> stats<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">// output options</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\ngulp<span class=\"token punctuation\">.</span><span class=\"token function\">task</span><span class=\"token punctuation\">(</span><span class=\"token string\">'zip'</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">[</span><span class=\"token string\">'webpack'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n\t<span class=\"token keyword\">var</span> packagePaths <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'**'</span><span class=\"token punctuation\">,</span> \n\t\t\t\t\t<span class=\"token string\">'!**/_package/**'</span><span class=\"token punctuation\">,</span> \n\t\t\t\t\t<span class=\"token string\">'!**/typings/**'</span><span class=\"token punctuation\">,</span>\n\t\t\t\t\t<span class=\"token string\">'!typings'</span><span class=\"token punctuation\">,</span> \n\t\t\t\t\t<span class=\"token string\">'!_package'</span><span class=\"token punctuation\">,</span> \n\t\t\t\t\t<span class=\"token string\">'!gulpfile.js'</span><span class=\"token punctuation\">]</span>\n\t\n\t<span class=\"token comment\">//add exclusion patterns for all dev dependencies</span>\n\t<span class=\"token keyword\">var</span> packageJSON <span class=\"token operator\">=</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>fs<span class=\"token punctuation\">.</span><span class=\"token function\">readFileSync</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span>__dirname<span class=\"token punctuation\">,</span> <span class=\"token string\">'package.json'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'utf8'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">var</span> devDeps <span class=\"token operator\">=</span> packageJSON<span class=\"token punctuation\">.</span>devDependencies<span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">var</span> propName <span class=\"token keyword\">in</span> devDeps<span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">var</span> excludePattern1 <span class=\"token operator\">=</span> <span class=\"token string\">\"!**/node_modules/\"</span> <span class=\"token operator\">+</span> propName <span class=\"token operator\">+</span> <span class=\"token string\">\"/**\"</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token keyword\">var</span> excludePattern2 <span class=\"token operator\">=</span> <span class=\"token string\">\"!**/node_modules/\"</span> <span class=\"token operator\">+</span> propName<span class=\"token punctuation\">;</span>\n\t\tpackagePaths<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>excludePattern1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\tpackagePaths<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>excludePattern2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n\t\n    <span class=\"token keyword\">return</span> gulp<span class=\"token punctuation\">.</span><span class=\"token function\">src</span><span class=\"token punctuation\">(</span>packagePaths<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">pipe</span><span class=\"token punctuation\">(</span><span class=\"token function\">zip</span><span class=\"token punctuation\">(</span>options<span class=\"token punctuation\">.</span>packageName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">pipe</span><span class=\"token punctuation\">(</span>gulp<span class=\"token punctuation\">.</span><span class=\"token function\">dest</span><span class=\"token punctuation\">(</span>options<span class=\"token punctuation\">.</span>packagePath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\ngulp<span class=\"token punctuation\">.</span><span class=\"token function\">task</span><span class=\"token punctuation\">(</span><span class=\"token string\">'default'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'zip'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>當設定完成後，可以先在 local run gulp 看看，如果順利，就可以看到壓縮檔，但別忘記砍掉，不然不小心簽入進去，到時候會被一起包起來送到 Azure 阿!!!</p>\n<h2>Web.config 設定</h2>\n<p>相對於 gulp ，web.config 就相對簡單； web.config 是提供 Azure 上 web site ( iis ) 的 Node.js 設定環境，基本上只要照 copy 就可以，若有需求，可以自行再去調整。</p>\n<div class=\"gatsby-highlight\" data-language=\"xml\"><pre class=\"language-xml\"><code class=\"language-xml\"><span class=\"token prolog\">&lt;?xml version=\"1.0\" encoding=\"utf-8\"?></span>\n<span class=\"token comment\">&lt;!--\n     This configuration file is required if iisnode is used to run node processes behind\n     IIS or IIS Express.  For more information, visit:\n\n     https://github.com/tjanczuk/iisnode/blob/master/src/samples/configuration/web.config\n--></span>\n\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>configuration</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>system.webServer</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token comment\">&lt;!-- Visit http://blogs.msdn.com/b/windowsazure/archive/2013/11/14/introduction-to-websockets-on-windows-azure-web-sites.aspx for more information on WebSocket support --></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>webSocket</span> <span class=\"token attr-name\">enabled</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>false<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>handlers</span><span class=\"token punctuation\">></span></span>\n      <span class=\"token comment\">&lt;!-- Indicates that the server.js file is a node.js site to be handled by the iisnode module --></span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>add</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>iisnode<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">path</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>Server.js<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">verb</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>*<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">modules</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>iisnode<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>handlers</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>rewrite</span><span class=\"token punctuation\">></span></span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>rules</span><span class=\"token punctuation\">></span></span>\n        <span class=\"token comment\">&lt;!-- Do not interfere with requests for node-inspector debugging --></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>rule</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>NodeInspector<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">patternSyntax</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>ECMAScript<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">stopProcessing</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>true<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n          <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>match</span> <span class=\"token attr-name\">url</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>^Server.js\\/debug[\\/]?<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>rule</span><span class=\"token punctuation\">></span></span>\n\n        <span class=\"token comment\">&lt;!-- First we consider whether the incoming URL matches a physical file in the /public folder --></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>rule</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>StaticContent<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n          <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>action</span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>Rewrite<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">url</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>public{REQUEST_URI}<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>rule</span><span class=\"token punctuation\">></span></span>\n\n        <span class=\"token comment\">&lt;!-- All other URLs are mapped to the node.js site entry point --></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>rule</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>DynamicContent<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n          <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>conditions</span><span class=\"token punctuation\">></span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>add</span> <span class=\"token attr-name\">input</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>{REQUEST_FILENAME}<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">matchType</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>IsFile<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">negate</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>True<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span>\n          <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>conditions</span><span class=\"token punctuation\">></span></span>\n          <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>action</span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>Rewrite<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">url</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>Server.js<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>rule</span><span class=\"token punctuation\">></span></span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>rules</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>rewrite</span><span class=\"token punctuation\">></span></span>\n    \n    <span class=\"token comment\">&lt;!-- 'bin' directory has no special meaning in node.js and apps can be placed in it --></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>security</span><span class=\"token punctuation\">></span></span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>requestFiltering</span><span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>hiddenSegments</span><span class=\"token punctuation\">></span></span>\n          <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>remove</span> <span class=\"token attr-name\">segment</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>bin<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>hiddenSegments</span><span class=\"token punctuation\">></span></span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>requestFiltering</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>security</span><span class=\"token punctuation\">></span></span>\n\n    <span class=\"token comment\">&lt;!-- Make sure error responses are left untouched --></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>httpErrors</span> <span class=\"token attr-name\">existingResponse</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>PassThrough<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span>\n\n    <span class=\"token comment\">&lt;!--\n      You can control how Node is hosted within IIS using the following options:\n        * watchedFiles: semi-colon separated list of files that will be watched for changes to restart the server\n        * node_env: will be propagated to node as NODE_ENV environment variable\n        * debuggingEnabled - controls whether the built-in debugger is enabled\n\n      See https://github.com/tjanczuk/iisnode/blob/master/src/samples/configuration/web.config for a full list of options\n    --></span>\n    <span class=\"token comment\">&lt;!--&lt;iisnode watchedFiles=\"web.config;*.js\"/>--></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>system.webServer</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>configuration</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>但調整完後，要特別注意，別忘記要把 web.config 也簽入到版控，這樣才會被一起打包送到 Azure 喔!!</p>\n<h2>Azure Node.js 版本設定</h2>\n<p>請直接參考<a href=\"http://skychang.github.io/2015/12/02/Azure-Setup_Nodejs_Version/\">這篇</a></p>\n<h2>開始執行 Build</h2>\n<p>經過長時間的設定，我們終於可以來測試看看了。</p>\n<p>要測試非常簡單，我們只要在我們建立好的 Build 上面，按下滑鼠右鍵。 ( 是的，雖然他是網頁，但請勇敢地按下滑鼠右鍵 ) ，並且選擇 Queue Build ，他就會將我們的 Build 放到 Queue 裡面，並且馬上執行。</p>\n<p><a href=\"01.png\"></a></p>\n<p>接著，我們就可以看到 Build 已經執行在跑了，如果有任何的錯誤，也會顯示於 log 上，大家可以看錯誤訊息後，再來調整看哪邊出錯，如果成功後，就會顯示綠燈了。</p>\n<p><a href=\"02.png\"></a></p>\n<h2>後記</h2>\n<p>為了寫新版的 Build 整整寫了四篇，( 包含一篇超短的 Azure Node.js 版本設定 ) ，小弟就在最後談談用了 Build 的感想吧...</p>\n<p>老實說，剛建完後的感覺，並沒有甚麼特別的...心中的 OS 大概就是 : \"阿，弄好了...\" 類似這樣的感覺。但建完後的幾天，寫 Code ，簽入，寫 Code ，簽入，這種感覺才真正的出來；那時，會有一種，\" 阿!!! 好順暢喔 !!! \"，尤其是在弄 Node.js 和前端的時候...</p>\n<p>以前往往弄完，還要到 Azure 上去 npm install ，這是非常非常久的一件事情，我同事也深受其害 XDDD，但又不可能把 package 全部簽入進去... ，所以佈署變成一種奢侈，甚至是到 Demo 之前，才會花一整天的時間去串...</p>\n<p>但現在串起來後，改 bug ，新功能，簽入後，就不用管他了，後面整個串起來，自己處理，我們只需要喝口可樂，上個廁所，回來一切都搞定了!!! ( 可惜還是只有我自 High ，公司大頭還是無感，畢竟現在還沒正式發布產品... )</p>\n<p>而這種速度，也代表著 DevOps 時代的來臨，雖然這不能代表整個 DevOps，但當使用者反饋問題，或是監控到 bug，我們可以透過高速的佈署速度 ，很快的解決和發佈新功能，更快速的反應給客戶，加速流程，這也是重要的一環阿!!!</p>\n<p>最後，還是要提一下，真實環境並非那樣的單純，可能佈署完後，還要搭配測試，也可能在 gulp 裡面包測試，其次，這邊在真實環境裡面，可能只是佈署到 Team 的內部測試環境，而真實環境，可能還有預備環境和正式環境等等，所以我們可能還會搭配 Release Management 來整合其他的過程，但不管怎樣，當完成這段的時候，你已經進了一大步了。</p>\n<p>大家一起加油!! 愛上敏捷，愛上 DevOps ~</p>\n<h2>參考資料</h2>\n<ul>\n<li><a href=\"https://msdn.microsoft.com/en-us/Library/vs/alm/Build/agents/windows\">https://msdn.microsoft.com/en-us/Library/vs/alm/Build/agents/windows</a></li>\n<li><a href=\"https://www.visualstudio.com/en-us/get-started/setup/get-more-build-or-load-testing-vs\">https://www.visualstudio.com/en-us/get-started/setup/get-more-build-or-load-testing-vs</a></li>\n</ul>","excerpt":"前言 在上一篇我們進行了基本的設定，設定了 npm 流程，接著 gulp 然後再佈署到 Azure Web Site。 但，如果是常寫 Node.js 的神人們，一定會知道，光是這樣是不夠的... 那我們還欠缺甚麼呢??.. gulp 的設定檔案 給 Azure Web Site…"}},"pageContext":{"type":"posts","next":{"frontmatter":{"path":null,"title":"Azure - 更改 Azure 上 WebSite 的 Node.js 版本","tags":["Azure","Node.js"]},"fields":{"slug":"/2015/12/02/Azure-Setup_Nodejs_Version/"},"fileAbsolutePath":"/home/runner/work/blog.sanc.idv.tw/blog.sanc.idv.tw/src/posts/Azure-Setup_Nodejs_Version/Azure-Setup_Nodejs_Version.md"},"previous":{"frontmatter":{"path":null,"title":"ASP.NET - 在 OSX 環境下開發 ASP.NET 應用程式 - 設定篇","tags":["ASP.NET","ASP.NET MVC","C#","Mac"]},"fields":{"slug":"/2015/12/20/ASP.NET-Use_OSX_Develop_ASP.NET_Setup/"},"fileAbsolutePath":"/home/runner/work/blog.sanc.idv.tw/blog.sanc.idv.tw/src/posts/Asp.Net-Use_OSX_Develop_ASP.NET_Setup/ASP.NET-Use_OSX_Develop_ASP.NET_Setup.md"}}}}